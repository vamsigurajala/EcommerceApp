{% extends "base.html" %}
{% block title %}Reviews ‚Äì {{ product.product_name }}{% endblock %}

{% block extra_style %}
<style>
  :root{
    --card-bg:#fff; --card-fg:#222; --muted:#6b7280; --accent:#333; --ring:#e5e7eb;
  }
  body.dark-mode :root{
    --card-bg:#1f1f1f; --card-fg:#f5f5f5; --muted:#a3a3a3; --accent:#fff; --ring:#2c2c2c;
  }

  .page{
    max-width: 1100px; margin: 24px auto; padding: 0 16px; display: grid;
    grid-template-columns: 360px 1fr; gap: 22px;
  }
  @media (max-width: 980px){ .page{ grid-template-columns: 1fr; } }

  .card{
    background: var(--card-bg); color: var(--card-fg);
    border:1px solid var(--ring); border-radius: 12px; padding: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
  }

  /* Product summary */
  .product-card img{
    width:100%; height:240px; object-fit: contain; border-radius:10px; background:#f8f8f8;
  }
  body.dark-mode .product-card img{ background:#111; }
  .product-title{ font-size: 22px; margin: 10px 0 6px; font-weight: 800; }
  .product-price{ font-weight: 700; margin: 4px 0 8px; }
  .product-desc{ font-size: 14px; color: var(--muted); }

  /* Review form */
  .form-card h3{ margin:0 0 12px; font-size: 18px;}
  .field{ margin-bottom: 12px; }
  .field label{ display:block; font-weight: 600; margin-bottom: 6px;}
  .field input[type="number"],
  .field input[type="text"],
  .field textarea{
    width:100%; border:1px solid var(--ring); border-radius: 8px; padding: 10px 12px;
    background:transparent; color:inherit; outline:none;
  }
  .field input:focus, .field textarea:focus{ box-shadow: 0 0 0 3px rgba(51,51,51,.12); }
  .submit-row{ display:flex; gap:10px; justify-content:flex-end; }
  .btn{
    border:none; border-radius: 8px; padding: 10px 14px; font-weight:700; cursor:pointer;
    background: var(--accent); color:#fff;
  }
  .btn.secondary{ background:#5865f2; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  /* Reviews list */
  .reviews-head{ display:flex; align-items:center; justify-content:space-between; }
  .reviews-list{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
  .review-item{ display:grid; grid-template-columns: 1fr auto; gap: 8px; }
  .review-meta{ font-size: 12px; color: var(--muted); }
  .verified{ font-size: 11px; color:#059669; font-weight:700; margin-left:8px; }
  .rating{ font-weight: 800; }
  .vote-row{ display:flex; gap:8px; align-items:center; }
  .vote-row form{ display:inline; }
  .vote-btn{
    background:#f4f4f5; border:1px solid var(--ring); color:#111; padding:6px 10px;
    border-radius: 8px; font-weight:700; cursor:pointer;
  }
  body.dark-mode .vote-btn{ background:#2a2a2a; color:#eee; }
  .vote-btn span{ margin-left:6px; }

  /* Pagination */
  .pagination{
    display:flex; justify-content:center; align-items:center; gap:10px; margin-top: 14px;
  }
  .pagination a, .pagination span.state{
    padding:8px 12px; border-radius:8px; background: var(--card-bg); border:1px solid var(--ring);
    text-decoration:none; color: inherit;
  }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <!-- LEFT: Product + form -->
  <div class="stack">
    <div class="card product-card">
      <img src="{{ product.image|default:'' }}" alt="{{ product.product_name }}">
      <div class="product-title">{{ product.product_name }}</div>
      <div class="product-price">‚Çπ {{ product.price }}</div>
      <div class="product-desc">{{ product.product_description }}</div>
      <div style="margin-top:10px;">
        <a href="{% url 'paginatedproducts' %}" class="btn secondary">Back to products</a>
      </div>
    </div>

    <div class="card form-card">
      <h3>Write a review</h3>
      <form action="{% url 'submit_review' product.product_id %}" method="post" id="review-form">
        {% csrf_token %}
        <div class="field">
          <label>Rating (1‚Äì5)</label>
          <input type="number" name="rating" min="1" max="5" required>
        </div>
        <div class="field">
          <label>Title</label>
          <input type="text" name="title" maxlength="120" placeholder="Optional headline">
        </div>
        <div class="field">
          <label>Review</label>
          <textarea name="body" rows="5" placeholder="What did you like or dislike?"></textarea>
        </div>
        <div class="submit-row">
          <button class="btn" type="submit">Submit review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- RIGHT: Reviews -->
  <div class="card">
    <div class="reviews-head">
      <h3 style="margin:0;">Reviews</h3>
      {% if reviews.results and reviews.results|length %}
        <div class="review-count" style="color:var(--muted); font-weight:600;">
          {{ reviews.results|length }} on this page
        </div>
      {% endif %}
    </div>

    {% if reviews.results and reviews.results|length %}
      <div class="reviews-list">
        {% for r in reviews.results %}
          <div class="review-item" data-review-id="{{ r.review_id }}">
            <div>
              <div class="rating">
                {{ r.rating }}/5
                {% if r.is_verified_purchase %}<span class="verified">‚úî Verified</span>{% endif %}
              </div>
              {% if r.title %}
                <div style="font-weight:700; margin-top:4px;">{{ r.title }}</div>
              {% endif %}
              {% if r.body %}
                <div style="margin-top:6px; line-height:1.5;">{{ r.body }}</div>
              {% endif %}
              <div class="review-meta" style="margin-top:6px;">
                #{{ r.review_id }} ‚Ä¢ {{ r.created_at }}
              </div>
            </div>

            <div class="vote-row">
              <form class="vote-form" method="post" action="{% url 'review_vote' r.review_id %}">
                {% csrf_token %}
                <input type="hidden" name="value" value="1">
                <button type="submit" class="vote-btn">üëç <span class="like-count">{{ r.like_count }}</span></button>
              </form>
              <form class="vote-form" method="post" action="{% url 'review_vote' r.review_id %}">
                {% csrf_token %}
                <input type="hidden" name="value" value="-1">
                <button type="submit" class="vote-btn">üëé <span class="dislike-count">{{ r.dislike_count }}</span></button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="pagination">
        {% if reviews.previous %}
          <a href="?page={{ reviews.page|add:"-1" }}">‚Üê Prev</a>
        {% else %}
          <span class="state">‚Üê Prev</span>
        {% endif %}
        <span class="state">Page {{ reviews.page }} of {{ reviews.pages }}</span>
        {% if reviews.next %}
          <a href="?page={{ reviews.page|add:"1" }}">Next ‚Üí</a>
        {% else %}
          <span class="state">Next ‚Üí</span>
        {% endif %}
      </div>
    {% else %}
      <p style="margin:12px 0; color:var(--muted);">No reviews yet. Be the first!</p>
    {% endif %}
  </div>
</div>

<script>
  // Intercept vote posts for instant count updates
  (function(){
    document.querySelectorAll('.vote-form').forEach(function(form){
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
        let data = {};
        try { data = await resp.json(); } catch(_){}
        if (!resp.ok || !data.ok){
          if (data && data.auth === false) { window.location.href = '{% url "loginuser" %}'; return; }
          window.location.reload(); return;
        }
        const card = form.closest('.review-item');
        if (!card) return;
        const likeEl = card.querySelector('.like-count');
        const dislikeEl = card.querySelector('.dislike-count');
        if (likeEl) likeEl.textContent = data.like_count ?? likeEl.textContent;
        if (dislikeEl) dislikeEl.textContent = data.dislike_count ?? dislikeEl.textContent;
      });
    });
  })();
</script>
{% endblock %}
