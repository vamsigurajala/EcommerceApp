{% extends 'changemode.html' %}
{% block extra_style %}
<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<style>
  body, .orders-container, table, th, td, .order-datetime { font-family: 'Inter', Arial, sans-serif; }

  .orders-container{
  width: 70vw;            /* same as cart */
  max-width: 1900px;      /* same as cart */
  min-height: 300px;      /* keeps the box visible when empty */
  margin: 32px auto 0;
  padding: 16px 20px 24px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 0 22px rgba(0,0,0,.13);
  position:relative;
}
body.dark-mode .orders-container{ background:#232323; color:#fff; }

  h1{ text-align:center; font-size:2.2rem; margin-bottom:10px; font-weight:700; color:#222; }
  body.dark-mode h1{ color:#fff; }


  .orders-table-scroll{
  max-height: calc(70vh - 140px);
  min-height: 200px;      /* prevents tiny collapse if there are few rows */
  overflow-y:auto;
  margin-bottom:20px;
  border-radius:7px;
  box-shadow:0 0 3px #eaeaea;
  scrollbar-width:none;
}
.orders-table-scroll::-webkit-scrollbar{ display:none; }

  .orders-table-scroll table thead th{
    position:sticky; top:0; z-index:2; background:#222; color:#fff;
  }
  body.dark-mode .orders-table-scroll table thead th{ background:#181818; color:#fff; }

  table{ border-collapse:collapse; width:100%; min-width:760px; }

  th,td{ text-align:left; padding:15px 12px; font-size:16px; vertical-align:middle; }
  th{ background:#222; color:#fff; font-weight:600; letter-spacing:.03em; font-size:17px; }
  body.dark-mode th{ background:#181818; color:#fff; }

  tr:nth-child(even){ background:#fafafd; }
  body.dark-mode tr:nth-child(even){ background:#232323; }
  td{ color:#232323; }
  body.dark-mode td{ color:#fff; }

  img{ width:64px; height:64px; object-fit:contain; border-radius:7px; background:#f7f7f7; box-shadow:0 1px 5px #eee; display:block; margin:auto; }
  td.product-name{ font-weight:600; text-align:left; }

  .order-datetime{ text-align:center; font-size:15px; font-weight:500; }

  .order-total-box{
    display:inline-block; background:#eef3fb; color:#273755; padding:7px 15px 8px; border-radius:7px;
    font-weight:700; font-size:17px; box-shadow:0 1px 6px rgba(130,130,180,0.09);
  }
  body.dark-mode .order-total-box{ background:#222c33; color:#e8e8ff; }

  /* Actions cell */
  .actions-cell{ white-space:nowrap; }
  .btn-icon{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb;
    background:#fff; color:#111827; font-weight:700; text-decoration:none; cursor:pointer;
    box-shadow:0 1px 2px rgba(0,0,0,.05); transition:transform .05s ease, background .15s;
    margin-left:8px;
  }
  .btn-icon:first-child{ margin-left:0; }
  .btn-icon:hover{ background:#f8fafc; }
  .btn-icon:active{ transform:translateY(1px); }
  .btn-icon svg{ width:16px; height:16px; }

  /* variants */
  .btn-icon.review{ border-color:#e9d5ff; background:#faf5ff; color:#6b21a8; }
  .btn-icon.review:hover{ background:#f3e8ff; }

  .btn-icon.edit{ border-color:#dbeafe; background:#eff6ff; color:#1d4ed8; }
  .btn-icon.edit:hover{ background:#dbeafe; }

  body.dark-mode .btn-icon{ background:#2a2a2a; border-color:#3a3a3a; color:#f3f4f6; }
  body.dark-mode .btn-icon.review{ background:#341b4f; border-color:#5b2d86; color:#f5e9ff; }
  body.dark-mode .btn-icon.edit{ background:#1f2a44; border-color:#2b3b65; color:#e8f0ff; }
  body.dark-mode .btn-icon:hover{ filter:brightness(1.08); }

  .fixed-back-btn{
    position:fixed; left:30px; top:40px; z-index:1000;
    background:#333; color:#fff; font-weight:bold; font-size:16px; padding:8px 16px; border-radius:6px; border:none; cursor:pointer;
  }
  .fixed-back-btn:hover{ background:#555; }

  @media (max-width: 800px){
    .orders-container{ max-width:97vw; padding:8px 2vw 16px; }
    .orders-table-scroll{ max-height:220px; }
    .fixed-back-btn{ left:10px; top:16px; }
    table, th, td{ font-size:13px; }
    h1{ font-size:20px; }
    .btn-icon{ padding:7px 10px; font-size:12px; }
  }

  /* Toasts */
  .toast{
    position:fixed; right:22px; bottom:22px; display:none; align-items:center; gap:10px;
    background:#232323; color:#fff; padding:12px 16px; border-radius:10px;
    box-shadow:0 8px 22px rgba(0,0,0,.25); z-index:2000; font-weight:600;
  }
  .toast.show{ display:inline-flex; }
  .toast.success{ background:#0a7b34; } .toast.error{ background:#b02a37; } .toast.info{ background:#1e5aad; }
  .toast .spinner{ width:16px; height:16px; border:2px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%; animation:spin .9s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<button class="btn-back fixed-back-btn" onclick="location.href='/api/paginate/'">Home</button>

<div class="orders-container">
  <h1>Placed Orders</h1>

  {% if order_data %}
  <div class="orders-table-scroll">
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User ID</th>
          <th>Image</th>
          <th>Product Name</th>
          <th>Placed Time</th>
          <th>Order Status</th>
          <th>Total Amount</th>
          <th>Actions</th>   {# NEW COLUMN #}
        </tr>
      </thead>
      <tbody>
        {% for order in order_data %}
          {% for item in order.order_items %}
          <tr>
            {% if forloop.first %}
              <td rowspan="{{ order.order_items|length }}">{{ order.order_id }}</td>
              <td rowspan="{{ order.order_items|length }}">{{ order.user_id }}</td>
            {% endif %}

            <td><img src="{{ item.image }}" alt="{{ item.product_name }}"></td>
            <td class="product-name">{{ item.product_name }}</td>

            {% if forloop.first %}
              <td rowspan="{{ order.order_items|length }}">
                <div class="order-datetime" data-datetime="{{ order.placed_time|escape }}"></div>
              </td>
              <td rowspan="{{ order.order_items|length }}">{{ order.order_status }}</td>
              <td rowspan="{{ order.order_items|length }}"><span class="order-total-box">Rs.{{ order.total_amount }}</span></td>
            {% endif %}

            {# Actions per PRODUCT (sits next to Total Amount) #}
            <td class="actions-cell">
              {% if item.my_review_id %}
            <a class="btn-icon edit" href="/api/reviews/{{ item.product_id }}/?edit=1">
                  <!-- pencil icon -->
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M4 20h4l10-10-4-4L4 16v4Z" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M14 6l4 4" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                  Edit the Review
                </a>
              {% else %}
                <a class="btn-icon review" href="/api/reviews/{{ item.product_id }}/">
                  <!-- star icon -->
                  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 17.3l-5.5 3 1.1-6.3L3 9.8l6.3-.9L12 3l2.7 5.9 6.3.9-4.6 4.2 1.1 6.3-5.5-3Z"/>
                  </svg>
                  Review Product
                </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>

    {% if messages %}
      {% for message in messages %}
        <div id="toast-{{ forloop.counter }}" class="toast {% if message.tags %}{{ message.tags }}{% endif %}" role="status" aria-live="polite" aria-atomic="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.35"/>
            <path d="M8 12l3 3 5-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  {% else %}
<div style="
    min-height: 40vh;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; text-align: center;">
  <p style="font-size:2rem; font-weight:700; margin: 10px 0 6px;">
    No orders found
  </p>
  <p style="font-size:1.2rem; opacity:.85;">
    Start shopping to place your first order ✨
  </p>
</div>
{% endif %}

</div>

<script>
  // Pretty date/time in “Placed Time”
  document.querySelectorAll('.order-datetime').forEach(function(el){
    var iso = el.getAttribute('data-datetime'); if(!iso) return;
    var dt = new Date(iso.replace('Z','')); if (dt.toString()==='Invalid Date'){ el.innerHTML=''; return; }
    var dateStr = dt.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
    var timeStr = dt.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
    el.innerHTML = dateStr + "<br><span style='display:block;text-align:center;font-size:14px;'>" + timeStr + "</span>";
  });

  // Toasts
  (function(){
    document.querySelectorAll('.toast').forEach(function(t){
      t.classList.add('show');
      setTimeout(function(){ t.classList.remove('show'); }, 4800);
    });
  })();
</script>
{% endblock %}
