{% extends 'changemode.html' %}

{% block title %}Novacart Payments Page{% endblock %}

{% block extra_style %}
{% load static %}

<style>
/* ---------------------------------------------
   Core fonts + CSS variables (light theme)
--------------------------------------------- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@700;800&display=swap');
/* Default (light) tokens */
:root{
  --brand:#4f46e5;
  --cta:#fbbf24;
  --ink:#0f172a;
  --ink-soft:#64748b;
  --paper:#ffffff;
  --bg:#f6f7f9;
  --line:#e5e7eb;
  --success-50:#eefaf0;
  --success-200:#cfe9cf;
  --radius:14px;
  --shadow:0 1px 2px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.06);
  --max:1180px;
  --ease:cubic-bezier(.22,.61,.36,1);
  --header-h: 64px;
  --stepbar-h: 56px;
}

/* Dark tokens (single selector) */
:root[data-theme="dark"]{
  --ink:#e5e7eb;
  --ink-soft:#94a3b8;
  --paper:#0b1220;
  --bg:#050a16;
  --line:#1f2937;
  --success-50:#052e1a;
  --success-200:#14532d;
}
/* ---------------------------------------------
   Dark theme variables (enable with html.dark or body.dark-mode or [data-theme="dark"])
--------------------------------------------- */
html.dark, body.dark-mode, [data-theme="dark"]{ --ink:#e5e7eb; --ink-soft:#94a3b8; --paper:#0b1220; --bg:#050a16; --line:#1f2937; --success-50:#052e1a; --success-200:#14532d;}

/* Redundant explicit dark variable set (kept as-is) */
html.dark{--ink:#e5e7eb;--ink-soft:#94a3b8;--paper:#0b1220;--bg:#050a16;--line:#1f2937;--success-50:#052e1a;--success-200:#14532d}

/* ---------------------------------------------
   Global reset + base body styles
--------------------------------------------- */
*{box-sizing:border-box}html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink);
  background:var(--bg);font-feature-settings: "liga" 1, "kern" 1;}

/* ---------------------------------------------
   Override base layout from changemode.html
   (allow this page to scroll and own header/nav)
--------------------------------------------- */
 /* force normal flow + scrolling */
 /* also ensure <main> spans the width */
 /* hide global theme toggle, header, nav coming from parent layout */
 /* keep page scroll behavior sane */
 /* page header color in both themes */
html,body{height:auto!important}body{display:block!important;overflow:auto!important}main{width:100%;height:auto;display:block}
body>#theme-toggle{display:none}

html,body{overflow-y:auto!important; overscroll-behavior:auto;}
main{overflow:visible;}

/* ---------------------------------------------
   Header layout + brand + shared display fonts
--------------------------------------------- */
.header-inner{max-width:var(--max);margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 16px}
.brand{font-weight:800;letter-spacing:.2px;font-size:22px}
h1,h2,h3,h4,.brand,.btn,.secure-pill,.crumb,.totals-toggle,.offers-tab,.field-label{
  font-family: "Manrope", "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
h1,h2,h3,h4,.brand{font-weight:800}
.btn{font-weight:800}
.crumb{margin-left:6px;font-weight:700;opacity:.92}
.spacer{flex:1}

/* ---------------------------------------------
   (Legacy) #theme-toggle styling if used locally
--------------------------------------------- */
#theme-toggle{position:static;width:40px;height:40px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.14);color:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;position: relative; }
html.dark #theme-toggle{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.10);color:#fff}
.icon-btn svg,#theme-toggle svg{width:20px;height:20px}

:root { --ink-main:#111827; --ink-muted:#4b5563; --ink-soft:#6b7280; --chip-bg:#e0e7ff; --chip-fg:#4338ca; }
@media (prefers-color-scheme:dark){ :root { --ink-main:#e5e7eb; --ink-muted:#cbd5f5; --ink-soft:#9ca3af; --chip-bg:rgba(129,140,248,.18); --chip-fg:#c7d2fe; } }

/* ---------------------------------------------
   Main page container (card-like canvas)
--------------------------------------------- */
.page{max-width:var(--max);margin:16px auto 48px;background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px 16px 16px}

/* ---------------------------------------------
   Topbar row (step + secure pill)
--------------------------------------------- */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 0 12px;border-bottom:none!important;padding-bottom:0!important;margin-bottom:12px!important; overflow: visible; }
.top-left{display:flex;align-items:center;gap:10px;font-weight:800}

/* Back button chip style */
.back-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:2px solid #000!important;border-radius:999px;background:#fff!important;color:#000!important;text-decoration:none;box-shadow:none!important}
.back-btn:hover{background:#fff!important}
.back-btn:focus-visible{outline:2px solid #000;outline-offset:2px}
html.dark .back-btn{background:#fff!important;color:#000!important;border-color:#000!important}

/* Right side content in topbar */
.top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* “100% Secure” pill */
.secure-pill{font-weight:700;font-size:14px;background:#eef3ff;border:1px solid #dfe7ff;padding:6px 10px;border-radius:999px}
html.dark .secure-pill{background:#0f172a;border-color:#1f2937;color:#cbd5e1}

/* ---------------------------------------------
   Generic button styles
--------------------------------------------- */
.btn-verify{background:#2a55e5;color:#fff;padding:0 16px}
.btn{height:48px;border:none;border-radius:10px;font-weight:800;font-size:15px;cursor:pointer}

/* ---------------------------------------------
   Two-column grid (methods + price summary)
--------------------------------------------- */
.grid{display:grid;grid-template-columns:minmax(0,1.15fr) minmax(0,.85fr);gap:20px;margin-top:12px}
.grid>*{min-width:0}
@media (max-width:1276px){.grid{grid-template-columns:1fr}}

/* ---------------------------------------------
   Card container used by sections/panels
--------------------------------------------- */
.card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}

/* ---------------------------------------------
   Section (accordion) shell
--------------------------------------------- */
.section+.section{margin-top:12px}
.section .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line);cursor:pointer;user-select:none}
.section .head h3{margin:0;font-size:16px;font-weight:700}

.section .body{padding:16px 18px 18px;display:grid;gap:10px}

/* ---------------------------------------------
   Inputs/selects (light + dark variants)
--------------------------------------------- */
.input,.select{height:44px;border:1px solid var(--line);border-radius:10px;padding:0 12px;font-size:15px;background-color:#fff;outline:none}
html.dark .input,html.dark .select{background-color:#0f172a;color:#e5e7eb;border-color:#1f2937}

/* Primary “Pay” button + ghost variant */
.btn-pay{background:var(--cta);color:#111}
.btn-ghost{background:#f3f4f6;color:#111}

/* ---------------------------------------------
   Generic modal backdrop + dialog container
--------------------------------------------- */
/* raise above header/topbar & tooltips */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
.modal-backdrop.show{display:flex}
/* ensure the white dialog itself sits atop its own backdrop stacking context */
.modal-backdrop .modal{z-index:3001}

/* ---------------------------------------------
   “Steps” list used inside help modals
--------------------------------------------- */
.step{display:grid;grid-template-columns:28px 1fr;column-gap:12px;align-items:start}
.step .logo{width:26px;height:26px;object-fit:contain;align-self:start;margin-top:-2px}
.step h5{margin:0 0 6px;font-size:16px;line-height:1.2}

/* ---------------------------------------------
   Accordion body show/hide animation
--------------------------------------------- */
.collapsible{overflow:hidden;max-height:0;transition:max-height .35s var(--ease)}
.collapsible.open{max-height:1000px}

/* ---------------------------------------------
   Right column (price summary) basics
--------------------------------------------- */
.price-col{display:flex;flex-direction:column;gap:10px}

/* Sticky price card on desktop, plain on mobile */
.price-card{position:sticky;top:12px;background:transparent!important;border:0!important;box-shadow:none!important;padding:0!important}
@media (max-width:1276px){.price-card{position:static;background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px}}

/* ---------------------------------------------
   Total amount panel (expandable lines)
--------------------------------------------- */
.totals-panel{background:#eef2ff;border:1px solid #dfe7ff;border-radius:12px;overflow:hidden}
.totals-body{max-height:0;overflow:hidden;padding:0 16px;transition:max-height .3s var(--ease),padding .3s var(--ease)}
.totals-panel.is-open .totals-body{padding:12px 16px 0}
.totals-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;font-size:14px}
.totals-sep{height:1px;background:#e2e8f0;margin:8px 0 0}
.totals-toggle{width:100%;display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:transparent;border:none;border-top:1px solid #e2e8f0;cursor:pointer;color:#4f46e5;font-size:16px;font-weight:400}
.total-left,.total-right{display:inline-flex;align-items:center;gap:8px;line-height:1}
.caret{width:12px;height:12px;border-right:2.5px solid currentColor;border-bottom:2.5px solid currentColor;display:inline-block;vertical-align:middle;transform:rotate(45deg) scale(1.25);transform-origin:center;transition:transform .2s var(--ease)}
#totalsToggle[aria-expanded="true"] .caret{transform:rotate(-135deg) scale(1.25)}
.amount-val{font-weight:600;font-size:18px}

/* Tabular numeric alignment for amounts/inputs */
.amount-val,
.totals-row span:last-child,
.chip,
.input,
.select {
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}

/* Show caret differently on desktop vs mobile */
#totalsToggle .total-left .caret,#totalsToggle .total-right .caret{display:none;margin-left:8px;gap:6px;white-space:nowrap;line-height:1;width:6px;height:6px}
@media (min-width:1277px){#totalsToggle .total-right .caret{display:inline-block}}
@media (max-width:1276px){#totalsToggle .total-left .caret{display:inline-block}}
.totals-toggle .total-left{display:inline-flex;align-items:center;gap:2px;line-height:1}

/* ---------------------------------------------
   Green “offers available” callout
--------------------------------------------- */
.line-callout{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:12px;border:1px solid var(--success-200);background:var(--success-50);cursor:pointer;box-shadow:var(--shadow)}
.line-callout:active{transform:translateY(1px)}
.chip{display:inline-flex;align-items:center;justify-content:center;font-size:13px;line-height:1;padding:6px 8px;border:1px solid var(--line);border-radius:999px;margin-left:6px;background:#fff}
html.dark .chip{background:#0f172a}

/* ---------------------------------------------
   Generic modal container + internals
--------------------------------------------- */
.modal{width:min(720px,92vw);max-height:84vh;overflow:auto;background:var(--paper);color:var(--ink);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.modal header{position:sticky;top:0;background:inherit;border-bottom:1px solid var(--line);padding:14px 16px;border-top-left-radius:16px;border-top-right-radius:16px}
.modal h4{margin:0;font-size:16px}
.m-body{padding:14px 16px;display:grid;gap:12px}
.offer{border:1px solid var(--line);border-radius:12px;padding:12px 12px;display:grid;gap:6px}
.offer .title{font-weight:700}
.offer .desc{color:var(--ink-soft);font-size:13px}
.m-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line)}
.btn-secondary{background:#eef2ff;border:1px solid #dbeafe;color:#111;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);border:1px solid var(--brand);color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}

/* ---------------------------------------------
   Generic tab control (if used elsewhere)
--------------------------------------------- */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{appearance:none;border:none;outline:none}
.tab+label{padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px;background:#f1f5f9;color:#0f172a;cursor:pointer;display:inline-flex;gap:6px;align-items:center}
.tab:checked+label{background:var(--brand);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#0f766e}

/* ---------------------------------------------
   Utility: hide scrollbars (cosmetic)
--------------------------------------------- */
.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{scrollbar-width:none;-ms-overflow-style:none}

/* ---------------------------------------------
   Section icon sprites (UPI/Card/Bank/Cash/Gift/EMI)
--------------------------------------------- */
.section[data-icon] .head h3{display:flex;align-items:center;gap:10px}
.section[data-icon] .head h3::before{content:"";width:22px;height:22px;background-size:contain;background-repeat:no-repeat;background-position:center}
.section[data-icon="upi"] .head h3::before{background-image:url("/static/images/upi.png")}
.section[data-icon="card"] .head h3::before{background-image:url("/static/images/card.png")}
.section[data-icon="bank"] .head h3::before{background-image:url("/static/images/bank.png")}
.section[data-icon="cash"] .head h3::before{background-image:url("/static/images/cash.png")}
.section[data-icon="gift"] .head h3::before{background-image:url("/static/images/giftcard.png")}
.section[data-icon="emi"] .head h3::before{background-image:url("/static/images/emi.png")}
html.dark .section[data-icon] .head h3::before{filter:brightness(.92)}

/* ---------------------------------------------
   UPI section typography + link styles
--------------------------------------------- */
.upi-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:4px}
.upi-title{font-weight:700;color:var(--ink)}
.upi-help{color:#2563eb;font-weight:700;font-size:12px;text-decoration:none!important}
.upi-help:hover{text-decoration:underline}
.upi-hint{color:#16a34a;font-weight:600;font-size:14px;margin-bottom:10px}

/* ---------------------------------------------
   Generic form field group + labels + errors
--------------------------------------------- */
.field{margin:0 0 10px;display:flex;flex-direction:column}
.field-label{display:block;font-size:13px;font-weight:600;color:var(--ink-soft);margin:0 0 6px}
.error-text{color:#dc2626;font-size:12px;margin:2px 2px 0;line-height:1.35}
.error-text:empty{display:block;height:0;margin:0;padding:0;overflow:hidden}
.fields-row>.field{align-self:start}

/* Reserve vertical space for error line */
:root{--err-line:16px}
.error-text{display:block;min-height:var(--err-line);color:#dc2626;font-size:12px;line-height:1.35;margin:4px 2px 0}
.error-text{font-weight:600}
.upi-hint,.pay-hint{font-weight:700}
.error-text:empty{visibility:hidden}

/* Focus rings for inputs/buttons (light & dark) */
.input:focus,.select:focus,.btn:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.18);border-color:#3b82f6}
html.dark .input:focus,html.dark .select:focus,html.dark .btn:focus{box-shadow:0 0 0 3px rgba(59,130,246,.16);border-color:#3b82f6}

/* Disabled state for verify/pay buttons */
.btn-pay:disabled,.btn-verify:disabled{background:#e5e7eb!important;color:#9ca3af!important;cursor:not-allowed!important;box-shadow:none!important;border-color:#e5e7eb!important}

/* ---------------------------------------------
   Card number field with trailing brand icon
--------------------------------------------- */
.has-icon{position:relative}
.has-icon>input.input{padding-right:56px}
#cardBrand{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:36px;height:24px;object-fit:contain;opacity:.9;pointer-events:none}

/* ---------------------------------------------
   Net banking search + no-results artwork
--------------------------------------------- */
.nb-search-wrap{position:relative}
.nb-search:focus::placeholder{color:transparent}
#nbNoResults{text-align:center;padding:24px 0}
#nbNoResults img{width:100%;max-width:360px;height:auto;opacity:.95}

/* ---------------------------------------------
   Right column stack: offers button + totals
--------------------------------------------- */
.price-stack{position:sticky;display:flex;flex-direction:column;gap:8px}
.price-stack #offersOpen{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px}

/* ---------------------------------------------
   Generic media defaults
--------------------------------------------- */
img{max-width:100%;height:auto}
.totals-toggle,.line-callout{min-width:0}

/* 2-column card form layout in Card section */
.card-2col{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;align-items:end}
@media (max-width:560px){.card-2col{grid-template-columns:1fr}}

/* ---------------------------------------------
   Bank list (popular/all) with radio + CTA
--------------------------------------------- */
.bank-list{display:grid;gap:3px;max-height:min(56vh,520px);overflow:auto;padding-right:6px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.bank-item{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px;border-radius:10px;border:1px solid var(--line);background:transparent}
.bank-item:hover{background:#f8fafc}
html.dark .bank-item:hover{background:#0f172a}
.bank-item .bank-name{flex:1 1 auto}
.nb-other .bank-list{max-height:min(56vh,520px);overflow:auto}
.bank-item .bank-logo{width:24px;height:24px;margin-left:auto;object-fit:contain}
.bank-item .bank-cta{flex-basis:100%;margin-top:10px}
.bank-item .bank-cta .btn{width:100%}

/* ---------------------------------------------
   Card section field sizing + logo image
--------------------------------------------- */
#cardSection .input,#cardSection .select{width:100%}
#cardSection .has-icon{position:relative}
#cardSection .has-icon>input.input{padding-right:52px}
#cardBrand{position:absolute;right:12px;top:50%;transform:translateY(-50%);width:28px;height:20px;object-fit:contain;opacity:.9;pointer-events:none}
#cardSection .fields-row{display:grid;grid-template-columns:1.15fr .95fr;gap:10px}
@media (max-width:420px){#cardSection .fields-row{grid-template-columns:1fr 1fr}}

/* ---------------------------------------------
   Bank item flex + logo sizing duplicates (kept)
--------------------------------------------- */
.bank-item{display:flex;align-items:center;gap:12px;justify-content:space-between}
.bank-logo{width:28px;height:28px;flex:0 0 28px;object-fit:contain;margin-left:12px}

/* Search input skin for bank list (light/dark) */
.nb-search-wrap{position:relative;display:block;width:100%;min-width:0}
.nb-search{width:100%;box-sizing:border-box;padding-left:40px;background-image:url("/static/images/magnifier.png");background-repeat:no-repeat;background-position:12px center;background-size:18px;background-color:var(--paper)}
html.dark .nb-search{width:100%;box-sizing:border-box;padding-left:40px;background-image:url("/static/images/magnifier.png");background-color:#0f172a;background-repeat:no-repeat;background-position:12px center;background-size:18px}
html.dark .nb-search::placeholder{color:#94a3b8}
.nb-search:focus::placeholder{color:transparent}

/* No-results compact artwork for narrow lists */
#nbNoResults{text-align:center;padding:18px 0}
#nbNoResults img{display:block;margin:10px auto 0;height:auto;width:clamp(160px,40vw,280px);opacity:.95}

/* ---------------------------------------------
   Gift card inputs spacing + error line height
--------------------------------------------- */
#giftBody .field{margin:0}#giftBody .field+.field{margin-top:8px}#giftBody .field-label{margin-bottom:6px}#giftBody .error-text{margin-top:6px;min-height:18px}

/* ---------------------------------------------
   Custom radio buttons (bank/emi options)
--------------------------------------------- */
:root{--rb-size:20px;--rb-ring:2px;--rb-dot:10px}
.bank-list .bank-item input[type="radio"],#emiSection .body input[type="radio"]{appearance:none;-webkit-appearance:none;-moz-appearance:none;width:var(--rb-size);height:var(--rb-size);border:var(--rb-ring) solid var(--line,#cfd4dc);border-radius:50%;background:var(--surface,#fff);display:inline-grid;place-content:center;margin-right:12px;flex:0 0 var(--rb-size);cursor:pointer;position:relative}
.bank-list .bank-item input[type="radio"]:checked,#emiSection .body input[type="radio"]:checked{border-color:var(--brand,#2a55e5);background-color:#fff}
.bank-list .bank-item input[type="radio"]::after,#emiSection .body input[type="radio"]::after{content:"";width:var(--rb-dot);height:var(--rb-dot);border-radius:50%;background:transparent;transition:transform .12s ease-out,background-color .12s ease-out;transform:scale(.6)}
.bank-list .bank-item input[type="radio"]:checked::after,#emiSection .body input[type="radio"]:checked::after{background:var(--brand,#2a55e5);transform:scale(1)}
.bank-list .bank-item input[type="radio"]:focus-visible,#emiSection .body input[type="radio"]:focus-visible{outline:2px solid color-mix(in oklab,var(--brand,#2a55e5),#fff 40%);outline-offset:2px;box-shadow:0 0 0 3px color-mix(in oklab,var(--brand,#2a55e5),#fff 75%)}
.bank-list .bank-item, #emiSection .body label{display:flex;align-items:center;gap:10px;cursor:pointer}

/* EMI summary rows: clean left/right alignment */
#emiSection .krow{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:4px 0;font-size:14px}
#emiSection .krow span:first-child{flex:1;color:var(--ink-soft)}
#emiSection .krow span:last-child{margin-left:12px;font-variant-numeric:tabular-nums}
#emiSection .krow:last-of-type span:first-child{color:var(--ink);font-weight:800}

/* === EMI radios: tighter spacing + pointer cursor (override) === */
#emiSection .body input[type="radio"]{ margin-right:0; }             
#emiSection .body label{ display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
#emiSection .body label *{ cursor:pointer; }                          

/* === EMI dropdown polish (closed state) === */
#emiSection .select{ appearance:none; -webkit-appearance:none; -moz-appearance:none; height:44px; line-height:44px; border-radius:10px; padding:0 40px 0 12px;                         
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2364758b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
  background-repeat:no-repeat; background-position:right 12px center; background-size:14px 14px;}
#emiSection .select:focus{ box-shadow:0 0 0 3px rgba(59,130,246,.18); border-color:#3b82f6; }
html.dark #emiSection .select{ background-color:#0f172a; color:#e5e7eb; border-color:#1f2937;background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");}
#emiSection .select::-ms-expand{ display:none; }  

/* ---------------------------------------------
   Responsive adjustments for price stack on mobile
--------------------------------------------- */
@media (max-width:1276px){.price-stack{position:static;gap:16px;margin-bottom:12px}.price-stack .price-card{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px}.price-stack #offersOpen{padding:12px}}

/* ---------------------------------------------
   Full-screen “offers” modal (custom)
--------------------------------------------- */
.offers-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
.offers-modal.show{display:flex}
.offers-dialog{position:relative;width:min(900px,92vw);max-height:84vh;background:var(--paper);color:var(--ink);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);overflow:visible;display:flex;flex-direction:column}
.offers-header{position:sticky;top:0;z-index:2;display:flex;align-items:center;flex:0 0 auto;min-height:52px;padding:10px 16px;border-bottom:1px solid var(--line);border-top-left-radius:14px;border-top-right-radius:14px;background:var(--paper)}
.offers-header h4{margin:0;font-size:16px;font-weight:800}
.offers-close{position:absolute;top:26px;right:-48px;transform:translateY(-50%);z-index:3;width:36px;height:36px;display:grid;place-items:center;border:1px solid var(--line);border-radius:999px;background:var(--paper);color:var(--ink);font-size:22px;line-height:1;cursor:pointer;box-shadow:var(--shadow)}
.offers-layout{display:flex;flex-direction:column;gap:12px;padding:12px 16px 16px;max-height:calc(84vh - 52px);overflow:hidden}
.offers-tabs{display:flex;align-items:center;gap:8px;border-bottom:0!important;padding-bottom:0!important;border-right:0;padding-right:0;flex-direction:row;overflow:auto}
.offers-tab{display:flex;align-items:center;gap:8px;width:auto;padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;font-weight:700;font-size:13px;cursor:pointer;user-select:none}
.offers-tab.is-active{background:#4f46e5;border-color:#4f46e5;color:#fff}
.offers-tab .brand-logo{width:18px;height:18px;object-fit:contain}
.offers-list{overflow:auto;padding-right:4px;display:grid;gap:12px}
.offer{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--paper)}
.offer-title{display:flex;align-items:center;gap:8px;color:#16a34a;font-weight:800}
.offer-title img{width:18px;height:18px;object-fit:contain}
.offer-desc{color:var(--ink-soft);font-size:13px;margin:6px 0 8px}
.offer-link{color:var(--brand);font-weight:800;font-size:12px;text-decoration:none}
.offer-link:hover{text-decoration:underline}
@media (max-width:768px){.offers-layout{grid-template-columns:1fr;gap:12px}.offers-tabs{border-right:0;border-bottom:1px solid var(--line);flex-direction:row;flex-wrap:wrap;gap:8px;padding-bottom:12px}}
.offers-dialog img{max-width:100%;height:auto}
.offers-dialog .offers-header{background:var(--paper)!important;color:var(--ink)!important}
.offers-dialog .offers-header h4{color:inherit}

/* ---------------------------------------------
   Light + dark color tokens for “offers” callout
--------------------------------------------- */
.line-callout{background:#ecfdf5;border-color:#cdeccb;gap:12px;cursor:pointer}
.line-callout>:first-child{color:#065f46;font-weight:600}
.line-callout>:first-child strong{color:#059669;font-weight:700}
.line-callout>:last-child{display:flex;gap:6px;flex-wrap:nowrap;white-space:nowrap}
.chip{margin-left:0;display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;padding:0 8px;font-size:13px;line-height:1;border-radius:999px;background:#fff;border:1px solid #cdeccb}
html.dark .line-callout{background:#052e1a;border-color:#14532d}
html.dark .line-callout>:first-child{color:#a7f3d0}
html.dark .line-callout>:first-child strong{color:#34d399}
html.dark .chip{background:#0f172a;border-color:#14532d}

/* Button card holding the callout in right column */
.price-stack #offersOpen{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
.price-stack{position:sticky;top:12px;display:flex;flex-direction:column;gap:16px}
.price-card{position:static;z-index:auto}
#offersOpen .lc-text{line-height:1.15}
#offersOpen .lc-title{font-weight:700}
#offersOpen .lc-sub{font-size:12px;color:#0f766e;margin-top:2px}
#offersOpen .lc-chips{display:flex;gap:6px;white-space:nowrap}

/* Totals toggle borders alignment tweaks */
.totals-toggle{border-top:0!important}
.totals-panel.is-open .totals-toggle{border-top:1px solid #e2e8f0}
html.dark .totals-panel.is-open .totals-toggle{border-top:1px solid #1f2937}
.totals-sep{height:1px;background:#e2e8f0;opacity:0;transition:opacity .2s var(--ease)}
.totals-panel.is-open .totals-sep{opacity:1}
html.dark .totals-sep{background:#1f2937}
html.dark .totals-panel{background:#0f172a;border-color:#1f2937}
html.dark .totals-body,html.dark .totals-row,html.dark .totals-toggle{color:#e5e7eb}
html.dark .totals-row .muted{color:#94a3b8}
html.dark .amount-val{color:#c7d2fe}
html.dark #offersOpen{background:#052e1a;border-color:#14532d;color:#a7f3d0}
html.dark #offersOpen strong{color:#34d399}
html.dark #offersOpen .lc-sub{color:#86efac}
html.dark #offersOpen .chip{background:#0b1220;color:#e5e7eb;border-color:#14532d}

/* ---------------------------------------------
   Mobile stacking for grid
--------------------------------------------- */
@media (max-width:1276px){.grid{grid-template-columns:1fr}.price-col{grid-row:1}.grid>:not(.price-col){grid-row:2}.price-card{position:static}}

/* ---------------------------------------------
   Left column container neutralization
--------------------------------------------- */
.pay-col{background:transparent;border:0;box-shadow:none;padding:0}

/* ---------------------------------------------
   Full-screen spinner overlay during navigation
--------------------------------------------- */
#nav-loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:99999;-webkit-backdrop-filter:blur(1px);backdrop-filter:blur(1px)}
#nav-loading.is-on{display:flex}
#nav-loading .nav-card{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px 20px;border-radius:12px;background:#0b0f19;color:#e5e7eb;border:1px solid rgba(255,255,255,.08);box-shadow:0 14px 36px rgba(0,0,0,.55)}
#nav-loading .nav-spin{width:44px;height:44px;border-radius:50%;border:3px solid rgba(255,255,255,.30);border-top-color:#fff;animation:nav-spin .45s linear infinite}
#nav-loading .nav-msg{font-weight:800;letter-spacing:.2px}
@keyframes nav-spin{to{transform:rotate(360deg)}}
body.is-busy{pointer-events:none;overflow:hidden}body.is-busy #nav-loading{pointer-events:all}

/* Minor spacing adjustments for NB section */
#nbPopularHeader{margin-bottom:12px!important}#nbDivider{margin:14px 0 8px!important}

/* ---------------------------------------------
   Hide base theme button; payments header toggle
--------------------------------------------- */
body>#theme-toggle{display:none} /* hide base button so it doesn't overlay clicks */
#theme-toggle-header{width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:rgba(255,255,255,.14);color:#0f172a;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
html.dark #theme-toggle-header{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.10);color:#fff}

/* ---------------------------------------------
   Hide the page header only at short view heights
   (use this to approximate “100% zoom” on your device)
--------------------------------------------- */
@media (max-height: 630px) { #pageHeader { display: none !important; } .page { margin-top: 0 !important; }}
#pageHeader{display:none!important}
#payPage { max-width: 1360px; margin: 16px auto 48px; }

/* Dark only for this page */
body.dark-mode .pay-page{ --ink:#e5e7eb; --ink-soft:#94a3b8; --paper:#0b1220; --bg:#050a16; --line:#1f2937; --success-50:#052e1a; --success-200:#14532d;}

/* Page canvas */
.pay-page .page-card{ max-width: var(--max); margin: 16px auto 48px; background: var(--paper); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 12px 16px 16px;}

/* Step row (left text + right pill) */
.pay-page .pay-topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:12px 0 8px;}
.pay-page .top-left{display:flex; align-items:center; gap:10px; font-weight:800;}
.pay-page .back-btn{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border:2px solid #000; border-radius:999px; background:#fff; color:#000; text-decoration:none;}
body.dark-mode .pay-page .back-btn{ background:#fff; color:#000; border-color:#000; }

.pay-page .secure-pill{ font-weight:700; font-size:14px; padding:6px 10px; border-radius:999px; background:#eef3ff; border:1px solid #dfe7ff; color:#0f172a;}
body.dark-mode .pay-page .secure-pill{ background:#0f172a; border-color:#1f2937; color:#cbd5e1; }

/* —— from here, keep your existing section/grid styles BUT prefix with .pay-page — */
.pay-page .grid{display:grid;grid-template-columns:minmax(0,1.15fr) minmax(0,.85fr);gap:20px;margin-top:12px}
@media (max-width:1276px){.pay-page .grid{grid-template-columns:1fr}}
.pay-page .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.pay-page .section+.section{margin-top:12px}
.pay-page .section .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line);cursor:pointer;user-select:none}
.pay-page .section .head h3{margin:0;font-size:16px;font-weight:700}
.pay-page .chev{transition:transform .25s var(--ease);opacity:.8}
.pay-page .section.open .chev{transform:rotate(180deg)}
.pay-page .section .body{padding:16px 18px 18px;display:grid;gap:10px}
/* …(keep the rest of your rules, but prefix each selector with .pay-page )… */

.theme-tooltip{ display:none; position:absolute; left:50%;top: calc(100% + 8px); transform: translateX(-50%);  background:#232323; color:#fff; padding:7px 12px; border-radius:6px; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,.18); white-space:nowrap; margin:0; z-index: 2000;pointer-events:none; opacity:0; transition:opacity .15s; }
#theme-toggle:hover .theme-tooltip{ display:block; opacity:1; }
.theme-tooltip::before{ content:""; position:absolute; top:-7px; left:50%; transform:translateX(-50%); border-width:0 7px 7px 7px; border-style:solid; border-color:transparent transparent #232323 transparent; }

/* Make the blue topbar fixed, let tooltip hang below, and leave some space on the right so the moon/sun icon sits a bit left. */ 
header.topbar{ position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); z-index: 1000; overflow: visible; padding-right: 72px; }

/* Nudge the icon a touch further left if you want */ 
header.topbar #theme-toggle{ margin-right: 8px;}

/* Keep the tooltip directly **under** the icon */ 
header.topbar #theme-toggle { position: relative; }
header.topbar .theme-tooltip{ position: absolute; left: 50%; top: calc(100% + 8px); transform: translateX(-50%); margin: 0; z-index: 2000; }

/* Push the page content down so it doesn't hide under the fixed bar */ 
main .page{ margin-top: calc(var(--header-h) + 16px) !important; }
/* Payments page: increase left padding of the blue bar */ 
header.topbar{ padding-left: 32px !important; /* adjust value to taste */ }
header.topbar{ position: sticky; top:0; }
main{ padding-top: 0; } /* not needed with sticky */

body.dark-mode { --ink: #e5e7eb; --ink-soft:#94a3b8; --paper:#0b1220; --bg:#050a16; --line:#1f2937; }

/* Inputs */ 
body.dark-mode .input, body.dark-mode .select { background: #0f172a; /* field surface */ border-color: #1f2937; /* outline */ color: var(--ink); }
body.dark-mode .input::placeholder, body.dark-mode .select::placeholder { color: var(--ink-soft); opacity: 1; }

/* Focus ring in dark */ 
body.dark-mode .input:focus, body.dark-mode .select:focus, body.dark-mode .btn:focus { box-shadow: 0 0 0 3px rgba(59,130,246,.16); border-color: #3b82f6; }

/* Disabled buttons in dark (keep readable) */ 
body.dark-mode .btn-pay:disabled, body.dark-mode .btn-verify:disabled{ background:#111827 !important; border-color:#374151 !important; color:#6b7280 !important; }

/* ---- Totals (price) card ---- */ 
body.dark-mode .totals-panel{ background:#0f172a; /* replace lavender */ border-color:#1f2937; color: var(--ink); }
body.dark-mode .totals-body, body.dark-mode .totals-row, body.dark-mode .totals-toggle{ color: var(--ink); }
body.dark-mode .totals-row .muted{ color: var(--ink-soft); }

/* Amount value—give it some pop but readable */ 
body.dark-mode .amount-val{ color:#c7d2fe; }

/* Divider + toggle border in dark */ 
body.dark-mode .totals-sep{ background:#1f2937; }
body.dark-mode .totals-panel.is-open .totals-toggle{ border-top:1px solid #1f2937; }

/* Offers callout chip keeps contrast in dark */ 
body.dark-mode .line-callout{ background:#052e1a; border-color:#14532d; }
body.dark-mode .line-callout > :first-child{ color:#a7f3d0; }
body.dark-mode .chip{ background:#0b1220; color:var(--ink); border-color:#14532d; }

/* Dark surface + borders for bank rows */ 
body.dark-mode .bank-list .bank-item{ background:#0b1220; /* row surface */ border-color:#1f2937; color:var(--ink); }
body.dark-mode .bank-list .bank-item:hover{ background:#0f172a; }
body.dark-mode .bank-list .bank-item:has(input[type="radio"]:checked){ background:#111827; border-color:#3b82f6; }

/* Custom radio: make ring and dot visible on dark */ 
body.dark-mode .bank-list .bank-item input[type="radio"]{ background:#0b1220; border-color:#334155; /* visible ring */ }
body.dark-mode .bank-list .bank-item input[type="radio"]:checked{ border-color:#60a5fa; }
body.dark-mode .bank-list .bank-item input[type="radio"]:checked::after{ background:#60a5fa; /* inner dot */ }

/* Make the “All other banks” link readable */ 
body.dark-mode .nb-other a{ color:#93c5fd; }
body.dark-mode .nb-other a:hover{ color:#bfdbfe; }

/* === Net-banking search: light & dark, consistent === */ /* Base (works for both themes) */ 
.nb-search-wrap{ position:relative; display:block; width:100%; min-width:0; }
.nb-search{ width:100%; box-sizing:border-box; padding-left:40px; /* room for the icon */ 
background-image:url("/static/images/magnifier.png") !important; background-repeat:no-repeat; background-position:12px center; background-size:18px; background-color:var(--paper); color:var(--ink); /* kill native search field chrome so the blue arcs don’t show */ appearance:none; -webkit-appearance:none; }

/* Use the actual theme class the page toggles: body.dark-mode */ 
body.dark-mode .nb-search{background-image:url("/static/images/magnifier.png") !important;background-repeat:no-repeat;background-position:12px 50%;background-size:18px 18px;background-color:var(--paper);color:var(--ink);}

/* Softer placeholder in dark; hide on focus */
body.dark-mode .nb-search::placeholder{ color:#94a3b8; }
.nb-search:focus::placeholder{ color:transparent; }

/* Remove WebKit search decorations (the cause of the blue shapes) */ 
.nb-search::-webkit-search-decoration, .nb-search::-webkit-search-cancel-button, .nb-search::-webkit-search-results-button, .nb-search::-webkit-search-results-decoration{ -webkit-appearance:none; appearance:none; display:none; }

/* Neutralize autofill paint (Edge/Chrome) so it doesn’t tint the field */ 
.nb-search:-webkit-autofill{ -webkit-text-fill-color:var(--ink); -webkit-box-shadow:0 0 0 1000px var(--paper) inset !important; box-shadow:0 0 0 1000px var(--paper) inset !important; }

/* Chevron for section headers */ 
.section .head .chev{ display:inline-block; width:10px; height:10px; border-right:2px solid currentColor; border-bottom:2px solid currentColor; transform:rotate(45deg); transform-origin:center; /* ensures full, smooth rotation */ transition:transform .22s var(--ease), color .22s var(--ease); color:var(--ink-soft); }
.section.open .head .chev{ transform:rotate(-135deg); color:var(--ink); }

/* Hide the header when the viewport is tall (↑ size) */ 
@media (max-height: 650px) { header.topbar { display: none !important; } main { padding-top: 0 !important; } /* pull page up */ }

/* --- Payment Timeout modal: new look --- */
#payTimeoutModal{ z-index:3000; } /* above page */
#payTimeoutModal .modal{ width:min(560px,92vw); border-radius:18px; border:1px solid color-mix(in oklab, var(--ink-soft), #fff 65%); background:linear-gradient(180deg, color-mix(in oklab, var(--paper), #fff 6%), var(--paper)); box-shadow:0 20px 60px rgba(2,8,23,.40), 0 0 0 1px rgba(2,8,23,.08) inset; overflow:hidden; }
#payTimeoutModal header{ border:0; padding:18px 20px 0; background:transparent; }
#payTimeoutModal .t-wrap{ padding:6px 20px 20px; display:grid; grid-template-columns:56px 1fr; column-gap:14px; align-items:start; }
#payTimeoutModal .t-icon{ width:56px; height:56px; border-radius:14px; display:grid; place-items:center; background:radial-gradient(55% 55% at 50% 45%, #fde68a 0%, #fbbf24 70%, #f59e0b 100%); box-shadow:inset 0 0 0 1px rgba(0,0,0,.06); color:#1f2937; }
#payTimeoutModal .t-title{ margin:0 0 4px; font-size:18px; font-weight:800; letter-spacing:.2px; }
#payTimeoutModal .t-desc{ margin:0; color:var(--ink-soft); }
#payTimeoutModal .t-note{ margin:10px 0 0; font-size:13px; color:var(--ink-soft); }
#payTimeoutModal .t-bar{ height:8px; border-radius:999px; background:#f3f4f6; margin:14px 0 0; overflow:hidden; box-shadow:inset 0 0 0 1px rgba(0,0,0,.06); }
#payTimeoutModal .t-fill{ height:100%; width:0%; background:linear-gradient(90deg,#f59e0b,#ef4444); transition:width .25s linear; }
#payTimeoutModal .m-actions{ border-top:1px solid var(--line); padding:12px 16px; gap:8px; justify-content:space-between; }
#payTimeoutModal .m-actions .left{ display:flex; align-items:center; gap:8px; color:var(--ink-soft); font-size:12px; }
#payTimeoutModal .btn-secondary{ background:#111827; color:#fff; border-color:transparent; }
#payTimeoutModal .btn-primary{ background:#ef4444; border-color:#ef4444; color:#fff; }
html.dark #payTimeoutModal .t-bar{ background:#0f172a; }
html.dark #payTimeoutModal .t-icon{ color:#0b1220; }
/* wider dialog + softer backplate */
#payTimeoutModal{ z-index:3000; backdrop-filter:blur(2px); }
#payTimeoutModal .modal{ width:min(720px,94vw); /* ⬅wider */ border-radius:20px; background:radial-gradient(120% 120% at 0% 0%, color-mix(in oklab, var(--paper), #fff 6%), transparent 60%), var(--paper); box-shadow:0 24px 80px rgba(2,8,23,.45), 0 0 0 1px rgba(2,8,23,.08) inset; }
/* header/body spacing polish */
#payTimeoutModal header{ border:0; padding:22px 24px 0; background:transparent; }
#payTimeoutModal .t-wrap{ padding:10px 24px 20px; grid-template-columns:64px 1fr; column-gap:16px; }
#payTimeoutModal .t-icon{ width:64px; height:64px; border-radius:16px; }
#payTimeoutModal .t-title{ font-size:20px; }
/* progress bar */
#payTimeoutModal .t-bar{ height:10px; border-radius:999px; margin-top:14px; }
/* actions area → help text ABOVE buttons */
#payTimeoutModal .m-actions{ display:grid; grid-template-rows:auto auto; gap:12px; border-top:1px solid var(--line); padding:14px 16px 16px; }
#payTimeoutModal .m-actions .help{ color:var(--ink-soft); font-size:12.5px; line-height:1.35; padding:0 4px; }
/* buttons row */
#payTimeoutModal .m-actions .buttons{ display:flex; gap:10px; justify-content:flex-end; align-items:center; flex-wrap:wrap; }
/* remove underlines, nicer hover/focus */
#payTimeoutModal .m-actions a{ text-decoration:none !important; }
#payTimeoutModal .btn-secondary, #payTimeoutModal .btn-primary{ border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.04); transition:transform .06s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease; }
#payTimeoutModal .btn-secondary{ background:#0f172a; color:#fff; border:1px solid rgba(255,255,255,.06); }
#payTimeoutModal .btn-secondary:hover{ transform:translateY(-1px); }
#payTimeoutModal .btn-secondary:focus-visible, #payTimeoutModal .btn-primary:focus-visible{ outline:2px solid color-mix(in oklab, var(--brand), #fff 40%); outline-offset:2px; }
#payTimeoutModal .btn-primary{ background:#ef4444; border-color:#ef4444; color:#fff; }
#payTimeoutModal .btn-primary:hover{ background:#dc2626; transform:translateY(-1px); }
/* mobile: stack buttons full-width */
@media (max-width:520px){ #payTimeoutModal .m-actions .buttons{ flex-direction:column; align-items:stretch; } #payTimeoutModal .m-actions .buttons a{ width:100%; text-align:center; } }
:root[data-theme="dark"] #payTimeoutModal .t-bar{ background:#0f172a; }


.session-actions{ display:flex; gap:10px; margin-top:12px; }
.btn-login{
  display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
  border-radius:8px; background:#2563eb; color:#fff; font-weight:800; text-decoration:none;
}
.btn-login:hover{ filter:brightness(1.05); }
.btn-why{ background:transparent; color:var(--ink-soft); border:0; padding:0; cursor:pointer; }

#session-expired-modal .btn-login{display:block;width:100%;text-align:center;justify-content:center;padding:14px 16px;border-radius:10px;
  background:#2563eb;color:#fff;font-weight:800;text-decoration:none;border:1px solid transparent;box-shadow:inset 0 1px 0 rgba(255,255,255,.06);}
#session-expired-modal .btn-login:hover{filter:brightness(1.04);}

/* center the CTA row (if not already) */ 
.session-actions{display:flex;justify-content:center;}

/* remove underline for "Why did this happen?" */ 
#session-modal .why a{text-decoration:none;color:inherit;} 
#session-modal .why a:hover{text-decoration:none;}

/* if you use an outside X, give it a bit more too */ 
#session-close-outside{font-size:28px;z-index:5002;}

/* link highlight states */
 #session-modal .why a:hover{color:#2563eb;}
 #session-modal .why a.clicked{color:#ef4444;}

/* yellow info block, always below the link */ 
#session-why-text{display:none;margin:8px 0 10px;padding:12px 14px;border-radius:10px;background:#fef9c3;border:1px solid #fde68a;color:#0c0c0c;position:relative;z-index:1;} 
body.dark-mode #session-why-text{background:#3b2f13;border-color:#a16207;color:#fde68a;}

#session-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(1.5px);z-index:5000;}
#session-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(640px,92vw);background:var(--paper);color:var(--ink);border:1px solid var(--line);border-radius:12px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:18px 18px 20px;z-index:5001;overflow:visible;}
#session-modal header{position:relative;display:flex;justify-content:center;align-items:center;margin-bottom:10px;}
#session-modal header h4{margin:0;text-align:center;}
#session-close-outside{position:absolute;top:-18px;right:-59px;width:30px;height:30px;display:grid;place-items:center;border-radius:10px;font-size:26px;line-height:1;background:var(--paper);color:var(--ink-soft);border:1px solid var(--line);box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer;z-index:5002;}
.session-hero{display:block;margin:8px auto 12px;}
.session-hero img{width:100%;height:auto;display:block;object-fit:contain;border-radius:8px;filter:none;}
#session-why-text{display:none;margin:8px 0 10px;padding:12px 14px;border-radius:10px;background:#fef9c3;border:1px solid #fde68a;color:#0c0c0c;}
body.dark-mode #session-modal{background:#161616;color:#fff;border-color:#2a2a2a;}
body.dark-mode #session-close-outside{background:#161616;color:#cbd5e1;border-color:#2a2a2a;box-shadow:0 6px 18px rgba(0,0,0,.6);}
body.dark-mode #session-why-text{background:#3b2f13;border-color:#a16207;color:#fde68a;}

/* Force the small, bold session title like other pages */
#session-modal header h1,
#session-modal header h2,
#session-modal header h3,
#session-modal header h4{margin:0;font-size:18px!important;line-height:1.25!important;font-weight:800!important;letter-spacing:.2px;color:var(--ink,#0f172a)!important;}
/* If you still use the old wrapper id anywhere, cover it too */
#session-expired-modal header h1,
#session-expired-modal header h2,
#session-expired-modal header h3,
#session-expired-modal header h4{margin:0;font-size:18px!important;line-height:1.25!important;font-weight:800!important;letter-spacing:.2px;}
/* Dark mode title color */
body.dark-mode #session-modal header h1,
body.dark-mode #session-modal header h2,
body.dark-mode #session-modal header h3,
body.dark-mode #session-modal header h4{color:#fff!important;}

.page{overflow: hidden}
.page { max-width: var(--max); margin: 16px auto 48px; background: var(--paper); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 12px 16px 16px; overflow: hidden; }
@media (min-width: 1360px) { .payments-mast { position: sticky; top: var(--stickTop, 84px); z-index: 10; padding: 0 16px 12px; margin: 0; background: transparent; } .payments-mast .mast-inner { background: var(--paper); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 12px 16px; } }
.pay-col { background: var(--paper); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); }
@media (min-width: 1600px) { .pay-col { background: transparent; border: 0; box-shadow: none; } }
#payTimeoutModal .btn-primary:hover { background: #dc2626; transform: translateY(-1px); }
html.modal-open, body.modal-open { overflow: hidden !important; height: 100%; overscroll-behavior: contain; }


.stack{display:flex;flex-direction:column;gap:12px}
.tile-row{border:1px solid #e5e7eb;border-radius:12px;padding:12px 12px 12px;position:relative;background:#fff}
.tile-row.selected{outline:2px solid #2563eb}
.radio-line{display:flex;align-items:center;gap:12px;cursor:pointer}
.radio-line input{display:none}
.radio-ui{width:22px;height:22px;border-radius:50%;border:2px solid #9ca3af;display:inline-block;position:relative; top: 3px;}
.tile-row.selected .radio-ui{border-color:#2563eb}
.tile-row.selected .radio-ui::after{content:"";position:absolute;inset:4px;border-radius:50%;background:#2563eb}
.radio-text{display:flex;align-items:center;gap:10px;font-size:15px}
.badge{margin-left:6px;background:#eef2ff;color:#4338ca;border-radius:9999px;padding:2px 8px;font-size:12px}
.sub{color:#6b7280;margin-left:6px}
.tile-actions{position:absolute;right:12px;top:12px;display:flex;gap:10px}
.tile-actions .link{background:none;border:none;color:#2563eb;cursor:pointer;padding:0;font-size:13px}
.tile-actions .danger{color:#dc2626}
.pay-for-tile{width:100%;margin-top:12px}
.hidden{display:none}
.add-pill{margin-top:12px;border:1px dashed #a78bfa;color:#6d28d9;background:#faf5ff;padding:8px 12px;border-radius:10px}
.row-ck{display:flex;gap:8px;align-items:center;margin:8px 0 4px}
.brand{height:18px;width:auto}

details.dots { position: relative; margin-left: 8px; }
details.dots > summary { list-style: none; cursor: pointer; width: 28px; height: 28px; border-radius: 999px; display: grid; place-items: center; }
details.dots > summary::marker { content: ''; }
details.dots > summary::after { content: '⋯'; font-size: 18px; line-height: 1; opacity: .8; }
details.dots[open] > summary { background: var(--surface-2, #f3f4f6); }
details.dots .menu { position: absolute; right: 0; top: 34px; background: var(--bg, #fff); border: 1px solid rgba(0,0,0,.08); box-shadow: 0 6px 24px rgba(0,0,0,.12); border-radius: 12px; padding: 6px; min-width: 160px; z-index: 10; }
details.dots .menu .menu-item { display: block; width: 100%; text-align: left; padding: 8px 10px; border: 0; background: none; cursor: pointer; }
details.dots .menu .menu-item:hover { background: rgba(0,0,0,.04); }
details.dots .menu .menu-item.danger { color: #d11; }
.tile-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border: 1px solid var(--border, #e5e7eb); border-radius: 12px; }
.tile-row .radio-line { flex: 1 1 auto; min-width: 0; }
.tile-actions { margin-left: auto; position: relative; flex: 0 0 auto; }
.tile-row .pay-for-tile { width: 260px; margin-left: 16px; }
@media (max-width:640px) { .tile-row { flex-wrap: wrap; } .tile-row .pay-for-tile { width: 100%; margin: 10px 0 0 0; } }
.row-ck { display: flex; align-items: center; gap: 10px; user-select: none; cursor: pointer; }
.row-ck input[type="checkbox"] { width: 18px; height: 18px; accent-color: #2563eb; cursor: pointer; }
.row-ck span { cursor: pointer; }
.link.action, .link.danger, .tile-actions button, .add-pill, .btn, .btn-pay, .radio-line, .saved-radio, .tile-row { cursor: pointer; }
.tile-row { display: flex; align-items: center; }
.tile-row .radio-line { flex: 1 1 auto; min-width: 0; }
.tile-actions { margin-left: auto; position: relative; flex: 0 0 auto; }
.add-pill { cursor: pointer; }
.hidden { display: none !important; }
.btn-pay { width: 100% !important; display: block !important; }
#upiSection .pay-hint { color: #16a34a; font-weight: 700; margin-bottom: 15px; }
#upiSection .btn-pay { width: 100%; display: block; margin-top: 16px; }
#upiSection .muted { margin-top: 10px; }
#upi-id-error { color: #dc2626; font-size: 13px; margin-top: 4px; }


/* === final layout for saved tiles: left text, right dots === */
.stack{display:flex;flex-direction:column;gap:12px;}
.tile-row{display:flex;flex-direction:column;align-items:stretch;gap:8px;width:100%;}
.tile-row .tile-head{display:flex;align-items:center;justify-content:space-between;width:100%;}
.tile-row .radio-line{display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;justify-content:flex-start;}
.tile-row .radio-text{display:flex;align-items:center;gap:8px;}
.tile-row .dots{margin-left:auto;flex:0 0 auto;}
.tile-row .btn-pay,.tile-row .pay-for-tile{width:100%;margin-top:8px;align-self:stretch;}
/* === align Proceed button edges with radio + 3 dots === */
.tile-row{padding:0 12px;}
.tile-row .tile-head{padding:0 4px;}
.tile-row .pay-for-tile{width:auto;margin:8px 4px 0 4px;align-self:stretch;}
.tile-row .btn-pay,.tile-row .pay-for-tile{border-radius:8px;}

/* === final polish: spacing & vertical dots === */
.tile-row{padding:10px 12px 12px 12px;} /* top/bottom space */
.tile-row .tile-head{padding:4px 4px 6px 4px;}
.tile-row .pay-for-tile{width:auto;margin:10px 6px 0 6px;align-self:stretch;}
.tile-row .dots summary { font-size:0; line-height:1; display:inline-grid; place-items:center; }
.tile-row .dots summary::-webkit-details-marker{display:none;} /* hide default arrow */

details.dots { position:relative; margin-left:8px; }
details.dots > summary { list-style:none; cursor:pointer; width:28px; height:28px; padding:0; margin:0; border-radius:999px; display:grid; place-items:center; background:transparent !important; border:none; user-select:none; outline:none; }
details.dots > summary::-webkit-details-marker { display:none; }
details.dots[open] > summary { background:transparent !important; }
details.dots > summary::after { content:''; display:inline-block; width:4px; height:4px; border-radius:50%; background:currentColor; box-shadow:0 -6px 0 currentColor,0 6px 0 currentColor; }
details.dots > summary:focus, details.dots > summary:active { outline:none; background:transparent !important; }
details.dots > summary:focus-visible { outline:2px solid rgba(37,99,235,.6); outline-offset:2px; }

.pay-hint + .list-head { margin-top:4px; } /* reduces space between offer and Saved UPI IDs */
.upi-subtitle { font-size:12px; font-weight:600; color:#4b5563; margin:12px 0 10px 0; user-select:none; cursor:default; } /* small title non-selectable */
#upi-manual input.input { margin-top:8px; } /* adds gap between Add new UPI ID text and input box */
#card-manual .row-ck { margin-bottom:18px; }
#card-manual.no-saved .muted { margin-bottom:6px; } /* gap between RBI line and green offer */
#card-manual.no-saved .pay-hint { margin-bottom:18px; }

/* kill the big outer container card on the left */
.pay-col { background: transparent; border: 0; box-shadow: none; border-radius: 0; padding: 0; }

/* make each payment section its own free card */
.pay-col .section.card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 14px rgba(15,23,42,.04); margin-bottom: 12px; overflow: hidden; }

/* optional: give the step header its own card look so it still feels nice */
.pay-col .step-head { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 14px rgba(15,23,42,.04); padding: 16px 20px; margin-bottom: 12px; }
.hidden { display: none !important; }

.radio-text { display:flex; flex-direction:column; gap:4px; }
.card-top { display:flex; align-items:center; justify-content:space-between; }
.card-main { font-weight:600; font-size:14px; color:#111827; }
.card-badge { margin-left:8px; }
.card-line { display:flex; align-items:center; gap:8px; font-size:13px; color:#4b5563; }
.card-num { letter-spacing:0.06em; }
.card-holder { max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.card-logo img.brand { width:28px; height:18px; object-fit:contain; display:block; margin-left:4px; }
.card-exp { font-size:13px; color:#6b7280; }

#cardSection .radio-line { display:flex; align-items:flex-start; gap:10px; }
#cardSection .card-header { display:flex; flex-direction:column; align-items:flex-start; gap:2px; padding:4px 0; }
#cardSection .card-top { display:flex; align-items:center; justify-content:flex-start; gap:8px; font-weight:600; font-size:14px; color:#111827; }
#cardSection .card-main { margin-left:0; }
#cardSection .card-bottom { display:flex; align-items:center; flex-wrap:wrap; gap:6px; font-size:13px; color:#4b5563; margin-top:2px; }
#cardSection .card-num { letter-spacing:0.06em; }
#cardSection .card-holder { max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
#cardSection .card-logo img.brand { width:28px; height:18px; object-fit:contain; display:block; }
#cardSection .card-exp { font-size:13px; color:#6b7280; }
#cardSection .sep { opacity:.6; }

#upiSection .radio-line { display:flex; align-items:center; gap:10px; }
#upiSection .radio-ui { position:relative; top:1px; }
#upiSection .upi-line { display:flex; align-items:center; gap:8px; font-size:14px; color:#111827; font-weight:500; }
#upiSection .upi-id { font-weight:600; color:#111827; }
#upiSection .badge { background:#e0e7ff; color:#4338ca; font-weight:600; font-size:12px; border-radius:6px; padding:2px 6px; }
#cardSection .badge { background:#e0e7ff; color:#4338ca; font-weight:600; font-size:12px; border-radius:6px; padding:2px 6px; }



#sm-confirm-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); z-index: 2000; display: none; overflow: hidden; }
#sm-confirm-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; color: #111827; padding: 36px 30px 30px; border-radius: 14px; box-shadow: 0 10px 45px rgba(0,0,0,0.25); z-index: 2001; width: 440px; max-width: 90%; text-align: center; display: none; transition: all 0.25s ease; overflow: visible; }
#sm-confirm-modal h4 { font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 14px; letter-spacing: 0.3px; line-height: 1.4; }
#sm-confirm-modal p { font-size: 15px; color: #4b5563; margin-bottom: 26px; line-height: 1.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#sm-confirm-modal .session-actions { display: flex; justify-content: center; gap: 18px; }
#sm-confirm-modal .btn-primary { background: linear-gradient(90deg,#ef4444,#dc2626); color: #fff; border: none; border-radius: 8px; padding: 10px 26px; font-weight: 600; cursor: pointer; transition: 0.25s; box-shadow: 0 3px 10px rgba(239,68,68,0.35); }
#sm-confirm-modal .btn-primary:hover { background: linear-gradient(90deg,#dc2626,#b91c1c); transform: translateY(-1px); }
#sm-confirm-modal .btn-secondary { background: #f9fafb; color: #111827; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px 26px; font-weight: 500; cursor: pointer; transition: 0.25s; }
#sm-confirm-modal .btn-secondary:hover { background: #f3f4f6; }
#sm-confirm-close { position: absolute; top: -28px; right: -70px; width: 30px; height: 30px; border: none; background: #fff; color: #9ca3af; font-size: 22px; font-weight: 700; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.18); cursor: pointer; transition: 0.25s; display: flex; align-items: center; justify-content: center; line-height: 1; }
#sm-confirm-close:hover { color: #111827; transform: scale(1.12); }
#sm-confirm-close { top: -36px !important; right: -70px !important; }
/* 🌙 Dark Mode Support (One-Liners) */
body.dark-mode #sm-confirm-modal { background:#1f2937; color:#f3f4f6; box-shadow:0 10px 45px rgba(0,0,0,0.7); border:1px solid #374151; }
body.dark-mode #sm-confirm-modal h4 { color:#f9fafb; }
body.dark-mode #sm-confirm-modal p { color:#d1d5db; }
body.dark-mode #sm-confirm-modal .btn-primary { background:linear-gradient(90deg,#dc2626,#b91c1c); box-shadow:0 3px 10px rgba(239,68,68,0.25); }
body.dark-mode #sm-confirm-modal .btn-secondary { background:#374151; color:#f3f4f6; border:1px solid #4b5563; }
body.dark-mode #sm-confirm-modal .btn-secondary:hover { background:#4b5563; }
body.dark-mode #sm-confirm-close { background:#1f2937; color:#d1d5db; box-shadow:0 4px 12px rgba(255,255,255,0.08); }
body.dark-mode #sm-confirm-close:hover { color:#fff; }
body.dark-mode #sm-confirm-close { background:#f9fafb; color:#111827; border:1px solid #4b5563; box-shadow:0 4px 14px rgba(0,0,0,0.45); }
body.dark-mode #sm-confirm-close:hover { background:#e5e7eb; color:#000; transform:scale(1.12); }



#upiSection .upi-line { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #111827; font-weight: 500; }
#upiSection .upi-id { font-weight: 600; color: #111827; }
#upiSection .badge { background: #e0e7ff; color: #4338ca; font-size: 12px; font-weight: 600; padding: 2px 6px; border-radius: 6px; line-height: 1; }
body.dark-mode #upiSection .badge { background: #4338ca; color: #fff; }
#upiSection .radio-text{display:flex;flex-direction:row;align-items:center;gap:8px;}
#upiSection .upi-id{white-space:nowrap;}
#upiSection .badge{flex-shrink:0;margin-left:6px;}

/* ================================
   PAYMENTS – SESSION EXPIRED MODAL (one-liner format)
   ================================ */
#payTimeoutModal {position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(2px);z-index:3000;}
#payTimeoutModal.show {display:flex;}
#payTimeoutModal .modal {position:relative;width:min(720px,94vw);background:radial-gradient(120% 120% at 0% 0%,color-mix(in oklab,var(--paper,#fff),#fff 6%),transparent 60%),var(--paper,#fff);color:var(--ink,#0f172a);border-radius:20px;border:1px solid color-mix(in oklab,var(--ink-soft,#64748b),#fff 65%);box-shadow:0 24px 80px rgba(2,8,23,.45),0 0 0 1px rgba(2,8,23,.08) inset;padding:0;overflow:hidden;}
#payTimeoutModal header {border:0;padding:22px 24px 0;background:transparent;}
#payTimeoutTitle.t-title {margin:0;font-size:20px;font-weight:800;letter-spacing:.2px;}
#payTimeoutModal .t-wrap {padding:10px 24px 20px;display:grid;grid-template-columns:64px 1fr;column-gap:16px;align-items:flex-start;}
#payTimeoutModal .t-icon {width:64px;height:64px;border-radius:16px;display:grid;place-items:center;background:radial-gradient(55% 55% at 50% 45%,#fde68a 0%,#fbbf24 70%,#f59e0b 100%);box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);color:#1f2937;}
#payTimeoutModal .t-desc {margin:0;color:var(--ink-soft,#64748b);}
#payTimeoutModal .t-note {margin:10px 0 0;font-size:13px;color:var(--ink-soft,#64748b);}
#payTimeoutModal .t-bar {height:10px;border-radius:999px;background:#f3f4f6;margin-top:14px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);}
#payTimeoutModal .t-fill {height:100%;width:0%;background:linear-gradient(90deg,#f59e0b,#ef4444);transition:width .25s linear;}
#payTimeoutModal .m-actions {display:grid;grid-template-rows:auto auto;gap:12px;border-top:1px solid var(--line,#e5e7eb);padding:14px 16px 16px;}
#payTimeoutModal .m-actions .help {color:var(--ink-soft,#64748b);font-size:12.5px;line-height:1.35;padding:0 4px;}
#payTimeoutModal .m-actions .buttons {display:flex;gap:10px;justify-content:flex-end;align-items:center;flex-wrap:wrap;}
#payTimeoutModal .m-actions a {text-decoration:none!important;}
#payTimeoutModal .btn-secondary,#payTimeoutModal .btn-primary {border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.04);transition:transform .06s ease,box-shadow .15s ease,background .15s ease,opacity .15s ease;padding:10px 18px;font-weight:800;}
#payTimeoutModal .btn-secondary {background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.06);}
#payTimeoutModal .btn-secondary:hover {transform:translateY(-1px);}
#payTimeoutModal .btn-primary {background:#ef4444;border:1px solid #ef4444;color:#fff;}
#payTimeoutModal .btn-primary:hover {background:#dc2626;border-color:#dc2626;transform:translateY(-1px);}
#payTimeoutModal .btn-secondary:focus-visible,#payTimeoutModal .btn-primary:focus-visible {outline:2px solid color-mix(in oklab,var(--brand,#4f46e5),#fff 40%);outline-offset:2px;}
@media(max-width:520px){#payTimeoutModal .m-actions .buttons{flex-direction:column;align-items:stretch;}#payTimeoutModal .m-actions .buttons a{width:100%;text-align:center;}}
:root[data-theme="dark"] #payTimeoutModal .modal,body.dark-mode #payTimeoutModal .modal {background:#020617;color:#e5e7eb;border-color:#1f2937;box-shadow:0 24px 80px rgba(0,0,0,.7),0 0 0 1px rgba(15,23,42,.85) inset;}
:root[data-theme="dark"] #payTimeoutModal .t-bar,body.dark-mode #payTimeoutModal .t-bar {background:#0f172a;}
:root[data-theme="dark"] #payTimeoutModal .t-icon,body.dark-mode #payTimeoutModal .t-icon {color:#0b1220;}
:root[data-theme="dark"] #payTimeoutModal .m-actions .help,body.dark-mode #payTimeoutModal .m-actions .help {color:#94a3b8;}
:root[data-theme="dark"] #payTimeoutModal .btn-secondary,body.dark-mode #payTimeoutModal .btn-secondary {background:#111827;border-color:#1f2937;}
:root[data-theme="dark"] #payTimeoutModal .btn-secondary:hover,body.dark-mode #payTimeoutModal .btn-secondary:hover {background:#1f2937;}
:root[data-theme="dark"] #payTimeoutModal .btn-primary,body.dark-mode #payTimeoutModal .btn-primary {background:#ef4444;border-color:#ef4444;}

[data-theme="dark"] .pay-shell {
  max-width: 1120px !important;
  margin: 0 auto !important;
  padding: 24px 16px 40px !important;
}

</style>
{% endblock %}

{% block content %}
<main class="payment-page">
<form id="payForm" action="/api/pay/success/" method="post"> 
  {% csrf_token %}
  <input type="hidden" name="save_upi" id="save_upi" value="0">
  <input type="hidden" name="upi_vpa"  id="upi_vpa"  value="">

  <input type="hidden" name="save_card"      id="save_card"      value="0">
  <input type="hidden" name="card_last4"     id="card_last4"     value="">
  <input type="hidden" name="card_brand"     id="card_brand"     value="">
  <input type="hidden" name="card_exp_month" id="card_exp_month" value="">
  <input type="hidden" name="card_exp_year"  id="card_exp_year"  value="">
  <input type="hidden" name="card_masked"    id="card_masked"    value="">
  <input type="hidden" name="card_holder_name" id="card-holder-hidden" value="">

  <!-- when picking a saved method -->
  <input type="hidden" name="saved_method_id"   id="saved_method_id"   value="">
  <input type="hidden" name="saved_method_type" id="saved_method_type" value="">
</form>


<div id="order-root" data-session-expired="1" hidden></div>

<section class="pay-page">
  <div class="page-card">

    <div class="pay-topbar">
      <div class="top-left">
        <a class="back-btn" href="/api/checkout/?seed=1" aria-label="Back to Checkout">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <span>Step 3 of 3</span><span>• Payments</span>
      </div>

      <div class="top-right">
        <span class="secure-pill">🔒 100% Secure</span>
      </div>
    </div>


<div class="grid">
    <!-- LEFT: PAYMENT METHODS -->
<section id="paymentsTop" class="pay-col">
    
 {# =================== U P I  =================== #}
<div class="section card" id="upiSection" data-accordion data-icon="upi">
  <div class="head">
    <h3>UPI</h3>
    <span class="chev" aria-hidden="true"></span>
  </div>

  <div class="collapsible">
    <div class="body">

      <div class="upi-head">
        <div class="upi-title">Pay by any UPI app</div>
        <a href="#" class="upi-help" id="upiHelpLink">How to find?</a>
      </div>

      {# when we HAVE saved UPIs, show the offer line above that list #}
      <div class="pay-hint">Save upto ₹30 • 4 offers available</div>

      {# ---------------- SAVED UPI IDs (only if present) ---------------- #}
      {% if saved_upis|length > 0 %}
        <div class="list-head">
          <span class="list-title">Saved UPI IDs</span>
        </div>

        {# ⬇️ only change: added saved-list class #}
        <div class="stack saved-list">
          {% for m in saved_upis %}
          {# ⬇️ only change: added saved-token class #}
          <div class="tile-row saved-token" data-method-type="upi" data-method-id="{{ m.id }}">
            <div class="tile-head">
              <label class="radio-line">
                <input class="saved-radio"
                       type="radio"
                       name="saved_upi"
                       value="{{ m.id }}"
                       data-type="upi"
                       {% if m.is_default %}checked{% endif %}>
                <span class="radio-ui"></span>
                <span class="radio-text">
                  <span class="upi-line">
                    <span class="upi-id"><strong>{{ m.masked_display }}</strong></span>
                    {# ⬇️ only change: added pill-default class #}
                    {% if m.is_default %}<span class="badge pill-default">Default</span>{% endif %}
                  </span>
                </span>
              </label>

              <details class="dots">
                {# ⬇️ only change: added token-menu class #}
                <summary class="token-menu" aria-label="More"></summary>
                <div class="menu">
                  <form method="post"
                        action="{% url 'saved_method_default' m.id %}?type=upi"
                        onsubmit="return false;">
                    {% csrf_token %}
                    <button type="button"
                            class="menu-item"
                            onclick="setDefault(event, this.form)">Make default</button>
                  </form>
                   <form method="post"
                        action="{% url 'saved_method_delete' m.id %}"
                        onsubmit="return false;">
                    {% csrf_token %}
                    <button type="button"
                              class="menu-item danger"
                              onclick="openSavedMethodConfirm(this.form)">Delete</button>
                  </form>
                </div>
              </details>
            </div>

            <button class="btn btn-pay pay-for-tile hidden"
                    form="payForm"
                    formaction="{% url 'payment_success' %}"
                    formmethod="post">
              Proceed to Pay
            </button>
          </div>
          {% endfor %}
        </div>

        {# ⬇️ only change: added add-token-row class #}
        <button id="link-add-upi"
                type="button"
                class="add-pill add-token-row"
                style="cursor:pointer;">
          + Add new UPI ID
        </button>
      {% endif %}

      {# ---------------- SINGLE MANUAL UPI FORM ---------------- #}
      <div id="upi-manual" {% if saved_upis|length > 0 %}class="hidden"{% endif %}>

        {% if saved_upis|length > 0 %}
        <div id="upi-subtitle" class="upi-subtitle" style="display:none;">Add new UPI ID</div>
        {% endif %}

        <div style="display:grid;grid-template-columns:1fr auto;gap:12px;">
          <input id="upi-id" class="input" placeholder="ENTER UPI ID">
          <button class="btn btn-verify" id="upi-verify" type="button" disabled>Verify</button>
        </div>

        <p class="error-text" id="upi-id-error" role="alert" aria-live="polite"></p>

        <label class="row-ck">
          <input type="checkbox" id="save-upi-checkbox">
          <span>Save this UPI ID for faster checkout next time</span>
        </label>

        <button class="btn btn-pay" id="upi-pay"
                type="submit"
                form="payForm"
                formaction="{% url 'payment_success' %}"
                formmethod="post"
                disabled>
          Proceed to Pay
        </button>

        <div class="muted" style="font-size:13px;">Use any UPI app. We’ll request a collect to your UPI handle.</div>
      </div>
    </div>
  </div>
</div>



    {# =================== C A R D S =================== #}
<div class="section card" id="cardSection" data-accordion data-icon="card">
  <div class="head">
    <h3>Credit / Debit / ATM Card</h3>
    <span class="chev" aria-hidden="true"></span>
  </div>

  <div class="collapsible">
    <div class="body">

      {% if saved_cards|length > 0 %}
        <div class="muted">Add and secure cards as per RBI guidelines</div>
        <div class="pay-hint" style="color:#16a34a;font-weight:700">
          Get upto 5% cashback* • 2 offers available
        </div>
      {% endif %}

      {# --------- SAVED CARDS (only if present) --------- #}
      {% if saved_cards|length > 0 %}
        <div class="list-head">
          <span class="list-title">Saved Cards</span>
        </div>

        {# ⬇️ only change: added saved-list #}
        <div class="stack saved-list">
          {% for m in saved_cards %}
            {% with brand=m.card_brand|default_if_none:"CARD"|upper %}
            {# ⬇️ only change: added saved-token #}
            <div class="tile-row saved-token" data-method-type="card" data-method-id="{{ m.id }}">
              <div class="tile-head">
                <label class="radio-line">
                  <input class="saved-radio"
                         type="radio"
                         name="saved_card"
                         value="{{ m.id }}"
                         data-type="card"
                         {% if m.is_default %}checked{% endif %}>
                  <span class="radio-ui"></span>

                  <span class="card-header">
                    {# ---- LINE 1: title + Default ---- #}
                    <span class="card-top">
                      <span class="card-main">{{ brand|title }} Credit Card</span>
                      {% if m.is_default %}
                        {# ⬇️ only change: add pill-default #}
                        <span class="badge pill-default">Default</span>
                      {% endif %}
                    </span>

                    {# ---- LINE 2: masked number | name | logo | (MM/YY) ---- #}
                    <span class="card-bottom">
                      <span class="card-num">•••• {{ m.last4 }}</span>

                      {% if m.card_holder_name %}
                        <span class="sep">|</span>
                        <span class="card-holder">{{ m.card_holder_name }}</span>
                      {% endif %}

                      <span class="sep">|</span>

                      <span class="card-logo">
                        {% with b=m.card_brand|default_if_none:"CARD" %}
                          {% with fn=b|lower %}
                            {% with brand_path="images/"|add:fn|add:".png" %}
                              {% static brand_path as BRAND_SRC %}
                              {% static "images/card.png" as FALLBACK_CARD %}
                              <img class="brand"
                                   src="{{ BRAND_SRC }}"
                                   alt="{{ b }}"
                                   loading="lazy"
                                   onerror="this.onerror=null;this.src='{{ FALLBACK_CARD }}';">
                            {% endwith %}
                          {% endwith %}
                        {% endwith %}
                      </span>

                      {% if m.exp_month and m.exp_year %}
                        {% with ey=m.exp_year|stringformat:"s" %}
                          {% with ey2=ey|slice:"-2:" %}
                            <span class="sep">|</span>
                            <span class="card-exp">({{ m.exp_month }}/{{ ey2 }})</span>
                          {% endwith %}
                        {% endwith %}
                      {% endif %}
                    </span>
                  </span>
                </label>

                <details class="dots">
                  {# ⬇️ only change: add token-menu #}
                  <summary class="token-menu" aria-label="More"></summary>
                  <div class="menu">
                    <form method="post"
                          action="{% url 'saved_method_default' m.id %}?type=card"
                          onsubmit="return false;">
                      {% csrf_token %}
                      <button type="button"
                              class="menu-item"
                              onclick="setDefault(event, this.form)">Make default</button>
                    </form>
                    <form method="post"
                          action="{% url 'saved_method_delete' m.id %}"
                          onsubmit="return false;">
                      {% csrf_token %}
                      <button type="button"
                            class="menu-item danger"
                            onclick="openSavedMethodConfirm(this.form)">Delete</button>
                    </form>
                  </div>
                </details>
              </div>

              <button class="btn btn-pay pay-for-tile hidden"
                      form="payForm"
                      formaction="{% url 'payment_success' %}"
                      formmethod="post">
                Proceed to Pay
              </button>
            </div>
            {% endwith %}
          {% endfor %}
        </div>

        {# only change: add add-token-row #}
        <button id="link-add-card"
                type="button"
                class="add-pill add-token-row"
                style="cursor:pointer;">
          + Add new card
        </button>
      {% endif %}

      {# --------- SINGLE MANUAL CARD FORM (OLD ONE) --------- #}
      <div id="card-manual" class="{% if saved_cards|length == 0 %}no-saved{% else %}hidden{% endif %}">

        {% if saved_cards|length == 0 %}
          <div class="muted">Add and secure cards as per RBI guidelines</div>
          <div class="pay-hint" style="color:#16a34a;font-weight:700">
            Get upto 5% cashback* • 2 offers available
          </div>
        {% endif %}

        <div class="field">
          <label class="field-label" for="card-holder-name">Name on card</label>
          <input id="card-holder-name"
                 name="card_holder_name"
                 class="input"
                 autocomplete="cc-name"
                 placeholder="Name on card">
          <p class="error-text" id="card-holder-error" role="alert" aria-live="polite"></p>
        </div>

        <div class="field">
          <label class="field-label" for="card-number">Card Number</label>
          <div class="has-icon">
            <input id="card-number"
                   class="input"
                   inputmode="numeric"
                   autocomplete="cc-number"
                   placeholder="Card Number"
                   maxlength="19">
            <img id="cardBrand" src="/static/images/fakecard.png" alt="card brand">
          </div>
          <p class="error-text" id="card-number-error" role="alert" aria-live="polite"></p>
        </div>

        <div class="fields-row card-2col">
          <div class="field">
            <label class="field-label" for="expiry">Valid Thru</label>
            <input id="expiry"
                   class="input"
                   inputmode="numeric"
                   placeholder="MM/YY"
                   maxlength="5">
            <p class="error-text" id="expiry-error" role="alert" aria-live="polite"></p>
          </div>
          <div class="field">
            <label class="field-label" for="cvv">CVV</label>
            <input id="cvv"
                   class="input"
                   inputmode="numeric"
                   autocomplete="cc-csc"
                   placeholder="CVV">
            <p class="error-text" id="cvv-error" role="alert" aria-live="polite"></p>
          </div>
        </div>

        <label class="row-ck">
          <input type="checkbox" id="save-card-checkbox">
          <span>Save this card for faster checkout</span>
        </label>

        <button class="btn btn-pay" id="card-pay"
                type="submit"
                form="payForm"
                formaction="{% url 'payment_success' %}"
                formmethod="post">
          Proceed to Pay
        </button>
      </div>

    </div>
  </div>
</div>


      <!-- NET BANKING -->
      <div class="section card" data-accordion data-icon="bank">
        <div class="head"><h3>Net Banking</h3><span class="chev" aria-hidden="true"></span></div>
        <div class="collapsible">
          <div class="body" id="nbBody">
            <div class="nb-search-wrap" id="nbSearchWrap"><span class="nb-icon" aria-hidden="true"></span><input id="nbSearch" class="input nb-search" placeholder="Search for bank"></div>
            <div id="nbPopular">
              <div class="muted" id="nbPopularHeader">Popular banks</div>
              <div id="nbPopularList" class="bank-list">
                <label class="bank-item"><input type="radio" name="bank" value="State Bank of India" checked><span class="bank-name">State Bank of India</span><img class="bank-logo" src="/static/images/sbi.png" alt="SBI" loading="lazy"></label>
                <label class="bank-item"><input type="radio" name="bank" value="HDFC Bank"><span class="bank-name">HDFC Bank</span><img class="bank-logo" src="/static/images/hdfc.png" alt="HDFC Bank" loading="lazy"></label>
                <label class="bank-item"><input type="radio" name="bank" value="ICICI Bank"><span class="bank-name">ICICI Bank</span><img class="bank-logo" src="/static/images/icici.png" alt="ICICI Bank" loading="lazy"></label>
                <label class="bank-item"><input type="radio" name="bank" value="Kotak Mahindra Bank"><span class="bank-name">Kotak Mahindra Bank</span><img class="bank-logo" src="/static/images/kotak.png" alt="Kotak Mahindra Bank" loading="lazy"></label>
                <label class="bank-item"><input type="radio" name="bank" value="Axis Bank"><span class="bank-name">Axis Bank</span><img class="bank-logo" src="/static/images/axis.png" alt="Axis Bank" loading="lazy"></label>
                <label class="bank-item"><input type="radio" name="bank" value="Federal Bank"><span class="bank-name">Federal Bank</span><img class="bank-logo" src="/static/images/federal.png" alt="Federal Bank" loading="lazy"></label>
              </div>
              <button id="nbShowAll" type="button" style="background:transparent;border:none;color:var(--brand);font-weight:800;display:flex;align-items:center;gap:6px;margin-top:8px;cursor:pointer">All other banks <span style="font-size:18px">›</span></button>
            </div>
            <div id="nbDivider" class="muted" style="display:none;margin-top:10px">All other banks</div>
            <div id="nbAllList" class="bank-list" style="display:none"></div>
          </div>
        </div>
      </div>

      <!-- CASH ON DELIVERY -->
      <div class="section card" data-accordion data-icon="cash">
        <div class="head"><h3>Cash on Delivery</h3><span class="chev" aria-hidden="true"></span></div>
        <div class="collapsible">
          <div class="body" id="codBody">
            <div class="cod-fee-card" role="note" aria-label="Cash on Delivery handling fee"><p class="cod-fee-title">Due to handling costs, a nominal fee of ₹5 will be charged for orders placed using this option.Avoid this fee by paying online now.</p></div>
            <button class="btn btn-pay" id="codPlaceOrder" type="submit" form="payForm" formaction="/api/pay/success/" formmethod="post">Place Order</button>
          </div>
        </div>
      </div>

      <!-- GIFT CARD -->
      <div class="section card" data-accordion data-icon="gift">
        <div class="head"><h3>Have a Novacart Gift Card?</h3><span class="chev" aria-hidden="true"></span></div>
        <div class="collapsible">
          <div class="body" id="giftBody">
            <div class="muted">Upto 10 giftcards can be added per transaction.</div>
            <div class="field"><label for="gcNumber" class="field-label">Voucher Number</label><input id="gcNumber" class="input" inputmode="numeric" autocomplete="off" placeholder="Enter 16-digit number" maxlength="16"/><p class="error-text" id="gcNumberErr" role="alert" aria-live="polite"></p></div>
            <div class="field"><label for="gcPin" class="field-label">Voucher PIN</label><input id="gcPin" class="input" inputmode="numeric" autocomplete="off" placeholder="Enter 6-digit PIN" maxlength="6"/><p class="error-text" id="gcPinErr" role="alert" aria-live="polite"></p></div>
            <button id="gcAddBtn" class="btn btn-pay" type="button" disabled>Add Gift Card</button>
          </div>
        </div>
      </div>

      <!-- EMI -->
      <div class="section card" id="emiSection" data-accordion data-icon="emi">
        <div class="head"><h3>EMI</h3><span class="chev" aria-hidden="true"></span></div>
        <div class="collapsible">
          <div class="body">
            <div class="muted">Pay in easy monthly instalments on eligible cards.</div>
            <div class="pay-hint" style="color:#16a34a;font-weight:700">No-cost EMI may apply on select plans</div>
            <div class="field"><label class="field-label">EMI Type</label><div style="display:flex;gap:3px;flex-wrap:wrap"><label><input type="radio" name="emiType" value="cc" checked> Credit Card EMI</label><label><input type="radio" name="emiType" value="dc"> Debit Card EMI</label><label><input type="radio" name="emiType" value="cl"> Cardless EMI</label></div></div>
            <div class="fields-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div class="field"><label for="emiBank" class="field-label">Bank</label><select id="emiBank" class="select"><option value="">Select bank…</option><option>SBI</option><option>HDFC Bank</option><option>ICICI Bank</option><option>Axis Bank</option><option>Kotak</option><option>Kotak Mahindra Bank</option></select></div>
              <div class="field"><label for="emiTenure" class="field-label">Tenure</label><select id="emiTenure" class="select"><option value="">Select tenure…</option><option value="3">3 months</option><option value="6">6 months</option><option value="9">9 months</option><option value="12">12 months</option></select></div>
            </div>
            <div class="krow"><span>Interest (p.a.)</span><span id="emiRate"> ... </span></div>
            <div class="krow"><span>Processing fee</span><span id="emiFee"> ... </span></div>
            <div class="krow" style="font-weight:800"><span>Monthly EMI</span><span id="emiMonthly"> ... </span></div>
            <button id="emiPay" class="btn btn-pay" type="submit" form="payForm" formaction="/api/pay/success/" formmethod="post" disabled>Proceed with EMI</button>
            <p class="error-text" id="emiError" role="alert" aria-live="polite"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: PRICE SUMMARY -->
    <div class="price-col">
      <div class="price-stack" id="priceStack">
        <aside class="card price-card">
          <div class="totals-panel" id="totalsPanel">
            <div id="totalsBody" class="totals-body" aria-hidden="true">
              <div class="totals-row"><span class="muted">Price ({{ item_count }} {{ item_count|pluralize:"item,items" }})</span><span>₹{{ cart_total|floatformat:0 }}</span></div>
              <div class="totals-row"><span class="muted">Delivery charge</span><span>₹{{ shipping_fee|floatformat:0 }}</span></div>
              <div class="totals-row"><span class="muted">Platform fee</span><span>₹{{ platform_fee|floatformat:0 }}</span></div>
              <div class="totals-sep"></div>
            </div>
            <button id="totalsToggle" class="totals-toggle" type="button" aria-expanded="false" aria-controls="totalsBody">
              <span class="total-left">Total Amount <span class="caret" aria-hidden="true"></span></span>
              <span class="total-right"><span class="amount-val" id="amountMain">₹{{ total_payable|floatformat:0 }}</span><span class="caret" aria-hidden="true"></span></span>
            </button>
          </div>
        </aside>

        <!-- DISCOUNT -->
        <div class="line-callout" id="offersOpen" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="offersModal">
          <div class="lc-text"><div class="lc-title"><strong>10% instant discount</strong></div><div class="lc-sub">Claim now with payment offers</div></div>
          <div><span class="chip">💳</span><span class="chip">🏦</span><span class="chip">+3</span></div>
        </div>
      </div>
    </div>
  </div>

  </div>
</section>

<!-- BANKS MODAL -->
<div class="modal-backdrop" id="banksModal" aria-modal="true" role="dialog" aria-labelledby="banksTitle">
  <div class="modal">
    <header><h4 id="banksTitle">Select Your Bank</h4></header>
    <div class="m-body"><input id="bankSearch" class="input" placeholder="Search for your bank…"><div class="bank-list no-scrollbar" id="banksList"></div></div>
    <div class="m-actions"><button class="btn-secondary" id="banksClose">Close</button></div>
  </div>
</div>

<!-- UPI HELP MODAL -->
<div class="modal-backdrop" id="upiHelpModal" aria-modal="true" role="dialog" aria-labelledby="upiHelpTitle">
  <div class="modal">
    <header style="display:flex;justify-content:space-between;align-items:center;"><h4 id="upiHelpTitle">Steps to find your UPI ID</h4><button id="upiHelpClose" class="btn-secondary" style="padding:4px 10px">Close</button></header>
    <div class="m-body">
      <div class="step"><img class="appicon logo" src="/static/images/phonepe.png" alt="PhonePe"><div><h5>PhonePe</h5><ol><li>Open the <strong>PhonePe</strong> app.</li><li>Tap your <strong>profile picture</strong> at the <strong>top-left</strong> of the home screen.</li><li>Open <strong>Bank Accounts / UPI</strong> and tap your account.</li><li>Your <strong>UPI ID</strong> (e.g. <code>name@bank</code>) is shown there.</li></ol></div></div>
      <div class="step"><img class="appicon logo" src="/static/images/gpay.png" alt="Google Pay"><div><h5>Google Pay</h5><ol><li>Open the <strong>Google Pay</strong> app.</li><li>Tap your <strong>profile photo</strong> at the <strong>top-right</strong>.</li><li>Choose <strong>Bank account</strong> / <strong>UPI ID</strong>.</li><li>Your linked bank shows one or more <strong>UPI IDs</strong>.</li></ol></div></div>
      <div class="step"><img class="appicon logo" src="/static/images/paytm.png" alt="Paytm"><div><h5>Paytm</h5><ol><li>Open the <strong>Paytm</strong> app.</li><li>Tap your <strong>profile picture</strong> at the <strong>top-left</strong>.</li><li>Open <strong>UPI &amp; Payment Settings</strong> (or just <strong>UPI</strong>).</li><li>Your <strong>UPI ID</strong> is visible on that page.</li></ol></div></div>
      <div class="step"><img class="appicon logo" src="/static/images/amazonpay.png" alt="Amazon Pay"><div><h5>Amazon Pay</h5><ol><li>Open the <strong>Amazon Pay</strong> app.</li><li>Tap your <strong>profile icon</strong> at the <strong>top-left</strong>.</li><li>Open <strong>Profile</strong> / <strong>My UPI ID</strong>.</li><li>Your active <strong>UPI ID</strong> is listed there.</li></ol></div></div>
      <div style="margin-top:10px;font-size:13px;"><strong>Tips:</strong><ul style="margin:8px 0 0 16px;padding:0;list-style:disc"><li>A UPI ID looks like <code>yourname@bank</code> or <code>9876543210@upi</code>.</li><li>If you have multiple UPI IDs, any one works for collection.</li><li>Can’t find it? Update your app to the latest version.</li></ul></div>
    </div>
  </div>
</div>

<!-- OFFERS MODAL -->
<div id="offersModal" class="offers-modal" role="dialog" aria-modal="true" aria-labelledby="offersTitle">
  <div class="offers-dialog">
    <button id="offersCloseX" class="offers-close" aria-label="Close">×</button>
    <header class="offers-header"><h4 id="offersTitle">Offers on online payment</h4></header>
    <div class="offers-layout">
      <aside class="offers-tabs" role="tablist" aria-label="Offer categories">
        <button class="offers-tab is-active" data-group="all" role="tab" aria-selected="true">All Offers</button>
        <button class="offers-tab" data-group="sbi" role="tab" aria-selected="false"><img class="brand-logo" src="/static/images/sbi.png" alt=""><span>Novacart SBI Credit Card</span></button>
        <button class="offers-tab" data-group="axis" role="tab" aria-selected="false"><img class="brand-logo" src="/static/images/axis.png" alt=""><span>Novacart Axis Bank Card</span></button>
      </aside>
      <section id="offersList" class="offers-list" role="tabpanel" aria-live="polite" aria-labelledby="offersTitle"></section>
    </div>
  </div>
</div>
<div id="nav-loading" aria-hidden="true">
  <div class="nav-card" role="status" aria-live="polite">
    <div class="nav-spin" aria-hidden="true"></div>
    <div class="nav-msg">Processing payment…</div>
  </div>
</div>

<!-- LOGIN / SESSION EXPIRED MODAL (same as checkout.html) -->
<div class="modal-backdrop" id="session-backdrop" style="display:none;"></div>
<div class="modal" id="session-modal" role="dialog" aria-modal="true" aria-labelledby="session-title" style="display:none;">
  <header>
    <h4 id="session-title">Your session expired</h4>
    <button id="session-close-outside" aria-label="Close">×</button>
  </header>

  <div class="session-hero" aria-hidden="true">
    <img src="{% static 'images/sessionend.png' %}" alt="">
  </div>

  <div class="why" id="why-link-wrap">
    <a href="#" id="why-link">Why did this happen?</a>
  </div>
  <div id="session-why-text" style="display:none;">
  For security, we auto-sign out after inactivity or when your session token expires.
</div>

  <div class="session-actions">
    <a class="btn-login" href="{% url 'loginuser' %}?next={{ request.get_full_path|urlencode }}">Log in again</a>
  </div>
</div>


<!-- SESSION/TIMEOUT ENDED MODAL -->
<div class="modal-backdrop" id="payTimeoutModal" aria-modal="true" role="dialog" aria-labelledby="payTimeoutTitle">
  <div class="modal" role="document">
    <header>
      <h4 id="payTimeoutTitle" class="t-title">Payment session ended</h4>
    </header>

    <div class="t-wrap">
      <div class="t-icon" aria-hidden="true">
        <!-- warning glyph -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
          <path d="M12 8v5m0 4h.01M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div>
        <p class="t-desc">
          Your payment wasn’t completed in time. We’ve marked this as <strong>Payment not successful</strong>.
        </p>
        <p class="t-note">
          You can try again from your orders page or continue here. <span id="ptoCountdown" aria-live="polite"></span>
        </p>

        <!-- soft redirect progress -->
        <div class="t-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="t-fill" id="ptoFill"></div>
        </div>
      </div>
    </div>

    <div class="m-actions">
      <!-- help text ABOVE the buttons -->
      <div class="help">Need help? Contact support from your orders page.</div>

      <!-- buttons (no underline) -->
      <div class="buttons">
        <a class="btn-secondary" id="payTimeoutStay" href="#">Continue here</a>
        <a class="btn-primary" id="payTimeoutOrders" href="/api/vieworders/">Go to My Orders</a>
      </div>
    </div>
  </div>
</div> 

<!--ONLY use this pair for delete confirm -->
<div id="sm-confirm-backdrop" class="modal-backdrop" style="display:none;"></div>

<div id="sm-confirm-modal"
     class="modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="sm-confirm-title"
     style="display:none;">
  <header style="position:relative;display:flex;justify-content:center;align-items:center;margin-bottom:10px;">
    <h4 id="sm-confirm-title" style="margin:0;">Remove payment method</h4>
    <button id="sm-confirm-close" aria-label="Close"
            style="position:absolute;top:-2px;right:-44px;width:30px;height:30px;
                   display:grid;place-items:center;border-radius:10px;font-size:26px;
                   line-height:1;background:#fff;border:1px solid #e5e7eb;cursor:pointer;">
      ×
    </button>
  </header>

  <p id="sm-confirm-text" style="text-align:center;">
    Are you sure you want to delete this saved payment method?
  </p>

  <div class="session-actions" style="justify-content:center;gap:10px;">
    <button id="sm-confirm-yes" class="btn-primary" type="button">Delete</button>
    <button id="sm-confirm-no"  class="btn-secondary" type="button">Cancel</button>
  </div>
</div>

</main>
<script>

/* =========================================================
   Vanilla JS for theme, accordions, modals, totals, inputs
   ========================================================= */
/* ---------- Helpers ---------- */
const Rs = n => '₹' + Math.round(+n||0).toLocaleString('en-IN');
const numOnly = s => (s||'').replace(/\D+/g,'');

/* ---------- Demo totals binding (kept: safe fallback if server values missing) ---------- */
(function(){
  const totals = { items: 2, price: 1799, delivery: 0, platform: 5 };
  totals.total = totals.price + totals.delivery + totals.platform;
  document.querySelectorAll('[data-bind="items"]').forEach(n=>n.textContent = totals.items);
  document.querySelectorAll('[data-bind="price"]').forEach(n=>n.textContent = totals.price);
  document.querySelectorAll('[data-bind="delivery"]').forEach(n=>n.textContent = totals.delivery);
  document.querySelectorAll('[data-bind="platform"]').forEach(n=>n.textContent = totals.platform);
  document.querySelectorAll('[data-bind="total"]').forEach(n=>n.textContent = totals.total);
})();

/* =========================================================
   STICKY SUBHEADER: continue button + amount mirror
   ========================================================= */
(function(){
  const ctaBtn = document.getElementById('continuePayBtn');
  const methodsTop = document.getElementById('paymentsTop');
  ctaBtn?.addEventListener('click', ()=> methodsTop?.scrollIntoView({behavior:'smooth', block:'start'}));

  // keep subheader & mobile chip amounts in sync with main total
  const main = document.getElementById('amountMain');
  const sub  = document.getElementById('subAmount');
  const mob  = document.getElementById('mAmountMain');
  function sync(){
    const val = (main?.textContent||'').trim();
    if(sub) sub.textContent = val;
    if(mob) mob.textContent = val;
  }
  sync();
  if(main){
    const mo = new MutationObserver(sync);
    mo.observe(main,{childList:true,subtree:true,characterData:true});
  }
})();

/* =========================================================
   ACCORDIONS (single open at a time)
   ========================================================= */
(function(){
  document.querySelectorAll('[data-accordion]').forEach((section, idx)=>{
    const head = section.querySelector('.head');
    const box  = section.querySelector('.collapsible');
    if(idx===0){ section.classList.add('open'); box?.classList.add('open'); }
    head?.addEventListener('click', ()=>{
      const opening = !section.classList.contains('open');
      document.querySelectorAll('[data-accordion].open').forEach(s=>{
        if(s!==section){ s.classList.remove('open'); s.querySelector('.collapsible')?.classList.remove('open'); }
      });
      if(opening){ section.classList.add('open'); box?.classList.add('open'); }
      else{ section.classList.remove('open'); box?.classList.remove('open'); }
    });
  });
})();

/* =========================================================
   TOTALS DROPDOWNS (desktop + mobile)
   ========================================================= */
function initTotalsDropdown(panelId,toggleId,bodyId){
  const panel  = document.getElementById(panelId);
  const toggle = document.getElementById(toggleId);
  const body   = document.getElementById(bodyId);
  if(!panel || !toggle || !body) return;
  const setOpen = open=>{
    toggle.setAttribute('aria-expanded', String(open));
    body.setAttribute('aria-hidden', String(!open));
    panel.classList.toggle('is-open', open);
    body.style.maxHeight = open ? (body.scrollHeight + 'px') : '0px';
  };
  setOpen(false);
  toggle.addEventListener('click', ()=> setOpen(toggle.getAttribute('aria-expanded')!=='true'));
  addEventListener('resize', ()=>{ if(panel.classList.contains('is-open')) body.style.maxHeight = body.scrollHeight + 'px'; });
}
initTotalsDropdown('totalsPanel','totalsToggle','totalsBody');
initTotalsDropdown('mTotalsPanel','mTotalsToggle','mTotalsBody');

/* =========================================================
   OFFERS MODAL + TABS (final)
   ========================================================= */
/* ===== OFFERS MODAL (single source of truth) ===== */
(function(){
  // 1) Offer data
  const OFFERS = [
    { id:1, brand:'axis', title:'5% Unlimited Cashback',
      desc:'On Novacart Axis Bank Credit Card. T&C apply', terms:'T&C Apply' },
    { id:2, brand:'sbi',  title:'10% Instant Discount',
      desc:'On SBI Credit Card. Min spend ₹5000. Max ₹1250', terms:'T&C Apply' },
    { id:3, brand:'sbi',  title:'Special Price on SBI Card',
      desc:'Extra ₹2000 off with SBI Credit Card EMI',       terms:'View T&Cs' },
    { id:4, brand:'axis', title:'Extra Discount with Axis',
      desc:'5% off on Novacart Axis Bank Card EMI',          terms:'Know More' },
  ];

  const BRAND_LOGO = {
    sbi:  '/static/images/sbi.png',
    axis: '/static/images/axis.png'
  };

  // 2) Elements
  const trigger = document.getElementById('offersOpen');     // green callout
  const modal   = document.getElementById('offersModal');    // backdrop
  const list    = document.getElementById('offersList');     // right list
  const closeX  = document.getElementById('offersCloseX');   // outside ×
  const tabs    = Array.from(modal.querySelectorAll('.offers-tab'));

  if(!trigger || !modal || !list || !closeX || tabs.length === 0) return;

  // 3) Helpers
  function activeGroup(){
    const btn = tabs.find(t => t.classList.contains('is-active'));
    return (btn && btn.dataset.group) || 'all';
  }

  function setActive(group){
    tabs.forEach(t => {
      const on = (t.dataset.group || 'all') === group;
      t.classList.toggle('is-active', on);
      t.setAttribute('aria-selected', on ? 'true' : 'false');
    });
  }

  function renderOffers(){
    const group = activeGroup();
    const rows  = OFFERS.filter(o => group === 'all' ? true : o.brand === group);

    list.innerHTML = rows.map(o => `
      <article class="offer">
        <div class="offer-title">
          ${o.brand ? `<img src="${BRAND_LOGO[o.brand] || ''}" alt="">` : ''}
          <span>${o.title}</span>
        </div>
        <div class="offer-desc">${o.desc}</div>
        <a href="#" class="offer-link">${o.terms} ›</a>
      </article>
    `).join('') || `<p class="muted" style="text-align:center;padding:12px 0">No offers available.</p>`;
  }

  function openModal(){
    modal.classList.add('show');
    renderOffers();
  }
  function closeModal(){
    modal.classList.remove('show');
  }

  // 4) Wire events
  trigger.addEventListener('click', openModal);
  closeX.addEventListener('click', closeModal);

  // click on backdrop to close
  modal.addEventListener('click', e => { if(e.target === modal) closeModal(); });

  // Esc to close
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape' && modal.classList.contains('show')) closeModal();
  });

  // tabs switch
  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      setActive(btn.dataset.group || 'all');
      renderOffers();
    });
  });

  // default tab: All
  setActive('all');
})();


/* =========================================================
   BANKS MODAL (global list) – simple searchable list
   ========================================================= */
(function(){
  const BANKS=['State Bank of India','HDFC Bank','ICICI Bank','Axis Bank','Kotak Mahindra Bank','Punjab National Bank','Bank of Baroda','Canara Bank','Union Bank of India','Bank of India','IndusInd Bank','Yes Bank','IDBI Bank','Federal Bank','South Indian Bank','Jammu & Kashmir Bank','Karur Vysya Bank','City Union Bank','Bandhan Bank','RBL Bank','Karnataka Bank','DCB Bank','Tamilnad Mercantile Bank','Nainital Bank','Dhanlaxmi Bank'];
  const openBtn  = document.getElementById('openBanks');
  const modal    = document.getElementById('banksModal');
  const closeBtn = document.getElementById('banksClose');
  const search   = document.getElementById('bankSearch');
  const list     = document.getElementById('banksList');

  function render(q=''){
    const items = BANKS.filter(b=>b.toLowerCase().includes(q.toLowerCase()));
    list.innerHTML = items.map(b=> `<label class="bank-item"><span>${b}</span><input type="radio" name="bank_all"></label>`).join('');
  }
  openBtn?.addEventListener('click', ()=>{ modal?.classList.add('show'); render(''); if(search){ search.value=''; setTimeout(()=>search.focus(),10);} });
  closeBtn?.addEventListener('click', ()=> modal?.classList.remove('show'));
  modal?.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });
  search?.addEventListener('input', e=> render(e.target.value));
})();

/* =========================================================
   UPI HELP MODAL (How to find?)
   ========================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  const openBtn = document.getElementById('upiHelpLink');
  const modal   = document.getElementById('upiHelpModal');
  const closeBtn= document.getElementById('upiHelpClose');
  if(!openBtn || !modal) return;
  openBtn.addEventListener('click', e=>{ e.preventDefault(); modal.classList.add('show'); });
  closeBtn?.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });
  addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.classList.contains('show')) modal.classList.remove('show'); });
});

/* =========================================================
   UPI VALIDATION (live + on blur; clears on accordion change)
   ========================================================= */

function isValidUpiId(v){
  const x = (v || '').trim();
  // basic pattern: name@bank
  return /^[a-zA-Z0-9._-]{2,}@[a-zA-Z][a-zA-Z0-9._-]{2,}$/.test(x);
}

(function(){
  const section = document.getElementById('upiSection');
  const input   = document.getElementById('upi-id');
  const verify  = document.getElementById('upi-verify');
  const pay     = document.getElementById('upi-pay');
  const err     = document.getElementById('upi-id-error');
  const saveCk  = document.getElementById('save-upi-checkbox');

  if (!section || !input || !verify || !pay || !err) return;

  let touched = false;

  function setButtons(ok){
    verify.disabled = !ok;
    pay.disabled    = !ok;
  }

  function showError(msg){
    err.textContent = msg || '';
    input.classList.toggle('is-invalid', !!msg);
  }

  // main validator
  function validate(){
    const val = (input.value || '').trim();
    const ok  = isValidUpiId(val);

    setButtons(ok);   // enable/disable Verify + Proceed

    if (!touched){
      showError('');
      return ok;
    }

    if (!val){
      showError('UPI ID is required');
    } else if (!ok){
      showError('Enter a valid UPI ID (e.g., name@bank)');
    } else {
      showError('');
    }
    return ok;
  }

  function reset(){
    touched = false;
    showError('');
    setButtons(false);
  }

  // -------- events ----------

  // typing: validate live, and turn on buttons as soon as pattern ok
  input.addEventListener('input', () => {
    touched = true;
    validate();
  });

  // leaving the box: show red error if wrong
  input.addEventListener('blur', () => {
    touched = true;
    validate();
  });

  // optional Verify click – just reuses same validation
  verify.addEventListener('click', (e) => {
    if (!validate()){
      e.preventDefault();
      input.focus();
    }
  });

  // Proceed to Pay: block if invalid, and move values into hidden inputs
  pay.addEventListener('click', (e) => {
    if (!validate()){
      e.preventDefault();
      input.focus();
      return;
    }
    const v     = (input.value || '').trim();
    const hSave = document.getElementById('save_upi');
    const hVpa  = document.getElementById('upi_vpa');
    if (hSave) hSave.value = (saveCk && saveCk.checked) ? '1' : '0';
    if (hVpa)  hVpa.value  = v;
  });

  // clear when accordion is closed
  document.querySelectorAll('[data-accordion] .head').forEach(h => {
    h.addEventListener('click', () => {
      setTimeout(() => {
        if (!section.classList.contains('open')) reset();
      }, 0);
    });
  });

  reset();
})();



/* =========================================================
   CARD INPUT: brand detect, formatting, validation
   ========================================================= */
(function(){
  const holder       = document.getElementById('card-holder-name');   // Name on card (visible)
  const holderHidden = document.getElementById('card-holder-hidden'); // Hidden field sent to backend
  const num          = document.getElementById('card-number');
  const exp          = document.getElementById('expiry');
  const cvv          = document.getElementById('cvv');
  const pay          = document.getElementById('card-pay');
  const brandImg     = document.getElementById('cardBrand');

  const errH = document.getElementById('card-holder-error');
  const errN = document.getElementById('card-number-error');
  const errE = document.getElementById('expiry-error');
  const errC = document.getElementById('cvv-error');

  // if any of the important elements are missing, abort this block
  if (!holder || !num || !exp || !cvv || !pay || !brandImg || !errH || !errN || !errE || !errC) return;

  const PATHS = {
    default:   '/static/images/fakecard.png',
    visa:      '/static/images/visa.png',
    mastercard:'/static/images/mastercard.png',
    amex:      '/static/images/amex.png',
    discover:  '/static/images/discover.png',
  };

  /* ========= Name on card: only letters + space + '.' allowed ========= */

  const holderNavKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter'];

  // Block digits & symbols while typing
  holder.addEventListener('keydown', (e) => {
    // allow navigation / control keys and shortcuts
    if (holderNavKeys.includes(e.key) || e.ctrlKey || e.metaKey) return;

    // allow A–Z / a–z / '.' and space
    if (/^[a-zA-Z.]$/.test(e.key) || e.key === ' ') return;

    // everything else blocked (digits, symbols, etc.)
    e.preventDefault();
  });

  // Clean up any pasted / IME text + sync hidden field
  function sanitizeHolder(){
    // keep only letters, space, and '.'
    const cleaned = (holder.value || '').replace(/[^a-zA-Z. ]/g, '');
    if (holder.value !== cleaned) holder.value = cleaned;
    if (holderHidden) holderHidden.value = cleaned.trim();
    return cleaned;
  }

  /* ========= Card brand / formatting helpers ========= */

  const detectBrand = d => {
    if (/^4/.test(d))               return 'visa';
    if (/^5[1-5]/.test(d))          return 'mastercard';
    if (/^3[47]/.test(d))           return 'amex';
    if (/^(6011|65|64[4-9])/.test(d)) return 'discover';
    return 'default';
  };

  const setBrandUI = b => {
    brandImg.src = PATHS[b] || PATHS.default;
    const len = b === 'amex' ? 4 : 3;
    cvv.maxLength = len;
    cvv.value = (cvv.value || '').replace(/\D+/g,'').slice(0, len);
    cvv.placeholder = b === 'amex' ? 'CVV (4)' : 'CVV';
  };

  const luhnOk = d => {
    let sum = 0, alt = false;
    for (let i = d.length - 1; i >= 0; i--){
      let n = d.charCodeAt(i) - 48;
      if (alt){
        n *= 2;
        if (n > 9) n -= 9;
      }
      sum += n;
      alt = !alt;
    }
    return sum % 10 === 0;
  };

  const fmtCard = (d, b) =>
    b === 'amex'
      ? [d.slice(0,4), d.slice(4,10), d.slice(10,15)].filter(Boolean).join(' ')
      : d.replace(/(\d{4})(?=\d)/g,'$1 ').trim();

  function sanitizeAndFormatCard(){
    const raw   = (num.value || '').replace(/\D+/g,'');
    const brand = detectBrand(raw);
    const cap   = brand === 'amex' ? 15 : 16;
    const trimmed = raw.slice(0, cap);
    num.value = fmtCard(trimmed, brand);
    setBrandUI(brand);
    return trimmed;
  }

  function sanitizeAndFormatExpiry(){
    let d = (exp.value || '').replace(/\D+/g,'').slice(0,4);
    if (d.length >= 3) d = d.slice(0,2) + '/' + d.slice(2);
    exp.value = d;
  }

  function sanitizeCvv(){
    const brand = detectBrand((num.value || '').replace(/\D+/g,''));
    const len   = brand === 'amex' ? 4 : 3;
    cvv.value   = (cvv.value || '').replace(/\D+/g,'').slice(0,len);
  }

  /* ========= Field-level validation ========= */

  let tH = false, tN = false, tE = false, tC = false; // "touched" flags

  function vHolder(){
    const v = sanitizeHolder();
    let msg = '';
    if (!v) msg = 'Name on card is required';
    else if (v.length < 2) msg = 'Enter full name';
    errH.textContent = tH ? msg : '';
    holder.classList.toggle('is-invalid', tH && !!msg);
    return !msg;
  }

  function vNumber(){
    const d = (num.value || '').replace(/\D+/g,'');
    let msg = '';
    if (!d) msg = 'Card number is required';
    else {
      const brand = detectBrand(d);
      const lenOk = brand === 'amex' ? d.length === 15 : d.length === 16;
      if (!lenOk || !luhnOk(d)) msg = 'Enter a valid card number';
    }
    errN.textContent = tN ? msg : '';
    num.classList.toggle('is-invalid', tN && !!msg);
    return !msg;
  }

  function vExpiry(){
    const v = (exp.value || '').trim();
    let msg = '';
    const m = v.match(/^(\d{1,2})\s*\/\s*(\d{2})$/);
    if (!v) msg = 'Expiry is required';
    else if (!m) msg = 'Use MM/YY format';
    else{
      const mm = +m[1];
      const yy = +('20' + m[2]);
      if (mm < 1 || mm > 12) msg = 'Invalid month';
      else{
        const now = new Date();
        const end = new Date(yy, mm, 0, 23, 59, 59);
        if (end < now) msg = 'Card expired';
      }
    }
    errE.textContent = tE ? msg : '';
    exp.classList.toggle('is-invalid', tE && !!msg);
    return !msg;
  }

  function vCvv(){
    const d     = (num.value || '').replace(/\D+/g,'');
    const brand = detectBrand(d);
    const need  = brand === 'amex' ? 4 : 3;
    const ok    = new RegExp(`^\\d{${need}}$`).test((cvv.value || '').trim());
    const msg   = ok ? '' : `Enter ${need} digit CVV`;
    errC.textContent = tC ? msg : '';
    cvv.classList.toggle('is-invalid', tC && !!msg);
    return !msg;
  }

  /* ========= Global refresh (keeps button state in sync) ========= */

  function refresh(){
    // tidy all fields
    sanitizeHolder();
    const d = sanitizeAndFormatCard();
    sanitizeAndFormatExpiry();
    sanitizeCvv();

    const brand   = detectBrand(d);
    const needCvv = brand === 'amex' ? 4 : 3;

    // card number
    const lenOk   = brand === 'amex' ? d.length === 15 : d.length === 16;
    const cardOk  = lenOk && luhnOk(d);

    // expiry
    const m = (exp.value || '').match(/^(\d{2})\/(\d{2})$/);
    let expiryOk = false;
    if (m){
      const mm = +m[1];
      const yy = +('20' + m[2]);
      if (mm >= 1 && mm <= 12){
        const endOfMonth = new Date(yy, mm, 0, 23, 59, 59);
        expiryOk = endOfMonth >= new Date();
      }
    }

    // cvv
    const cvvOk = new RegExp(`^\\d{${needCvv}}$`).test((cvv.value || '').trim());

    // holder
    const nameVal  = sanitizeHolder();
    const holderOk = !!nameVal && nameVal.length >= 2;

    // overall
    const ok = holderOk && cardOk && expiryOk && cvvOk;
    pay.disabled = !ok;

    // Optimistic clear: once field is valid, clear its error
    if (tH && holderOk){
      errH.textContent = '';
      holder.classList.remove('is-invalid');
    }
    if (tN && cardOk){
      errN.textContent = '';
      num.classList.remove('is-invalid');
    }
    if (tE && expiryOk){
      errE.textContent = '';
      exp.classList.remove('is-invalid');
    }
    if (tC && cvvOk){
      errC.textContent = '';
      cvv.classList.remove('is-invalid');
    }
  }

  /* ========= Event wiring ========= */

  // name
  holder.addEventListener('input', () => {
    sanitizeHolder();
    tH = false;
    errH.textContent = '';
    holder.classList.remove('is-invalid');
    refresh();
  });
  holder.addEventListener('blur', () => {
    tH = true;
    vHolder();
    refresh();
  });

  // number / expiry / cvv – keep existing behaviour
  ['input','blur'].forEach(ev => {
    num.addEventListener(ev, refresh);
    exp.addEventListener(ev, refresh);
    cvv.addEventListener(ev, refresh);
  });
  num.addEventListener('paste', () => requestAnimationFrame(refresh));
  exp.addEventListener('paste', () => requestAnimationFrame(refresh));
  cvv.addEventListener('paste', () => requestAnimationFrame(refresh));

  num.addEventListener('blur', () => { tN = true; vNumber(); });
  exp.addEventListener('blur', () => { tE = true; vExpiry(); });
  cvv.addEventListener('blur', () => { tC = true; vCvv(); });

  // clear errors while typing
  function clearOnType(field, errEl){
    field.addEventListener('input', () => {
      errEl.textContent = '';
      field.classList.remove('is-invalid');
    });
  }
  clearOnType(holder, errH);
  clearOnType(num,    errN);
  clearOnType(exp,    errE);
  clearOnType(cvv,    errC);

  /* ===== Clear errors when Card accordion re-opens ===== */
  (function setupCardAccordionClear(){
    const sec  = document.getElementById('cardSection');
    if (!sec) return;
    const head = sec.querySelector('.head');

    function clearCardErrors(){
      tH = tN = tE = tC = false;
      [errH, errN, errE, errC].forEach(el => el && (el.textContent = ''));
      [holder, num, exp, cvv].forEach(el => el && el.classList.remove('is-invalid'));
      refresh();
    }

    const mo = new MutationObserver(() => {
      if (sec.classList.contains('open')) clearCardErrors();
    });
    mo.observe(sec, { attributes:true, attributeFilter:['class'] });

    if (head){
      const mo2 = new MutationObserver(() => {
        if (head.getAttribute('aria-expanded') === 'true') clearCardErrors();
      });
      mo2.observe(head, { attributes:true, attributeFilter:['aria-expanded'] });

      head.addEventListener('click', () => {
        setTimeout(() => {
          if (sec.classList.contains('open') || head.getAttribute('aria-expanded') === 'true'){
            clearCardErrors();
          }
        }, 0);
      });
    }
  })();

  // initial compute
  refresh();
})();


/* ---------- Block clipboard/paste for card fields (as requested) ---------- */
(function(){
  ['card-number','expiry','cvv'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    ['paste','copy','cut','drop','dragover','contextmenu'].forEach(evt=> el.addEventListener(evt, e=>e.preventDefault()));
    el.addEventListener('beforeinput', e=>{ if(e.inputType==='insertFromPaste'||e.inputType==='insertFromDrop') e.preventDefault(); });
    el.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && ['v','x','c'].includes(e.key.toLowerCase())) e.preventDefault();
    });
  });
})();


/* =========================================================
   NET BANKING – Popular + “All other banks” inline + unified search + inline CTA
   ========================================================= */
(function(){
  // ---- session-only open flag (resets on refresh)
  let allOpen = false;

  const nbBody=document.getElementById('nbBody'); if(!nbBody) return;
  const nbShowAll=document.getElementById('nbShowAll');
  const nbSearchWrap=document.getElementById('nbSearchWrap');
  const nbSearch=document.getElementById('nbSearch');
  const nbPopularHeader = document.getElementById('nbPopularHeader');
  const nbDivider=document.getElementById('nbDivider');
  const nbAllList=document.getElementById('nbAllList');
  const nbPopularList=document.getElementById('nbPopularList');

  // ensure initial collapsed UI
  if (nbSearchWrap) nbSearchWrap.style.display = 'none';
  if (nbAllList) nbAllList.style.display = 'none';
  if (nbDivider) nbDivider.style.display = 'none';
  if (nbShowAll) nbShowAll.style.display = ''; // link visible on fresh load

  // No-results artwork (your existing block)
  let nbNoResults=document.getElementById('nbNoResults');
  if(!nbNoResults){
    nbNoResults=document.createElement('div'); nbNoResults.id='nbNoResults';
    nbNoResults.innerHTML='<img src="/static/images/failedsearch.png" alt="No results">';
    (nbSearch?.parentNode||nbBody).insertBefore(nbNoResults, nbSearch?nbSearch.nextSibling:nbBody.firstChild);
  }
  nbNoResults.style.display='none';

  // ---- data (unchanged)
  const POPULAR="State Bank of India, HDFC Bank, ICICI Bank, Kotak Mahindra Bank, Axis Bank, Federal Bank".split(',').map(s=>s.trim());
  const ALL_MASTER=("Airtel Payments Bank, AU Small Finance Bank, Bandhan Bank, Bassein Catholic Co-operative Bank, BNP Paribas, Bank of Bahrain and Kuwait, BOBCARD, Bank of Baroda Corporate, Bank of Baroda Retail, Bank of India, Bank of Maharashtra, Canara Bank, CSB Bank, Central Bank of India, City Union Bank, Corporation Bank, Cosmos Co-operative Bank, DBS Bank, DCB Bank, Dena Bank, Deutsche Bank, Dhanlaxmi Bank, HSBC, IDBI Bank, IDFC FIRST Bank, Indian Bank, Indian Overseas Bank, IndusInd Bank, Janata Sahakari Bank (Pune), J&K Bank, Karnataka Bank, Karur Vysya Bank, Lakshmi Vilas Bank - Retail, Lakshmi Vilas Bank - Corporate, Punjab National Bank, Punjab National Bank Corporate, Punjab & Sind Bank, Punjab & Maharashtra Co-operative Bank, RBL Bank, RBS, Saraswat Co-operative Bank, Shamrao Vithal Co-operative Bank, Shivalik Mercantile Co-operative Bank, South Indian Bank, Standard Chartered Bank, Tamilnad Mercantile Bank, Tamil Nadu Mercantile Bank, TNSC Bank, UCO Bank, Union Bank of India, Yes Bank, The Zoroastrian Co-operative Bank").split(',').map(s=>s.trim());
  const POP_SET=new Set(POPULAR.map(n=>n.toLowerCase()));
  const ALL_BANKS=Array.from(new Set(ALL_MASTER)).filter(n=>!POP_SET.has(n.toLowerCase())).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

  const IMG='/static/images/';
  const LOGO_MAP={
    'state bank of india':'sbi.png','hdfc bank':'hdfc.png','icici bank':'icici.png','axis bank':'axis.png','kotak mahindra bank':'kotak.png','federal bank':'federal.png',
    'airtel payments bank':'airtel.png','au small finance bank':'au.png','bandhan bank':'bandhan.png','bank of bahrain and kuwait':'bahrain.png',
    'bassein catholic co-operative bank':'bassein.png','bobcard':'bobcard.png','city union bank':'cub.png','lakshmi vilas bank - corporate':'lakshmi.png',
    'lakshmi vilas bank - retail':'lakshmi.png','shamrao vithal co-operative bank':'svc.png','shivalik mercantile co-operative bank':'smc.png',
    'tamilnad mercantile bank':'tmb.png','tamil nadu mercantile bank':'tmb.png','the zoroastrian co-operative bank':'zoro.png',
    'bank of baroda':'baroda.png','bank of india':'boi.png','canara bank':'canara.png','central bank of india':'central.png','cosmos co-operative bank':'cosmos.png',
    'corporation bank':'corporation.png','csb bank':'csb.png','dbs bank':'dbs.png','dcb bank':'dcb.png','dena bank':'dena.png','deutsche bank':'deutsche.png',
    'dhanlaxmi bank':'dhanlaxmi.png','idbi bank':'idbi.png','idfc first bank':'idfc.png','indian bank':'indian.png','indian overseas bank':'indianoverseas.png',
    'indusind bank':'indus.png','j&k bank':'jandk.png','janata sahakari bank (pune)':'janata.png','karnataka bank':'karnataka.png','karur vysya bank':'karur.png',
    'maharashtra bank':'maharastra.png','punjab national bank':'punjab.png','punjab & sind bank':'sind.png','rbl bank':'rbl.png','saraswat co-operative bank':'saraswati.png',
    'south indian bank':'southindian.png','standard chartered bank':'standard.png','svc bank':'svc.png','tnsc bank':'tnsc.png','uco bank':'uco.png',
    'union bank of india':'union.png','yes bank':'yes.png','hsbc':'hsbc.png','rbs':'rbs.png','bnpparibas':'bnb.png','pmc bank':'pmc.png','zoroastrian co-operative bank':'zoro.png'
  };
  const LOGO_ALIAS={
    'bnpparibas':'bnpparibas','bnp paribas':'bnpparibas',
    'bank of baroda corporate':'bank of baroda','bank of baroda retail':'bank of baroda',
    'uco':'uco bank','yes':'yes bank','pnb':'punjab national bank','punjab national bank corporate':'punjab national bank',
    'svs bank':'svc bank','svcb':'svc bank','saraswat bank':'saraswat co-operative bank','cosmos bank':'cosmos co-operative bank',
    'sbi':'state bank of india','idfc first':'idfc first bank','jammu & kashmir bank':'j&k bank'
  };
  const DEFAULT_LOGO='bank.png';
  const norm = s=> (s||'').toLowerCase().replace(/\s+/g,' ').trim();
  function logoFor(name){
    const key = norm(name);
    const alias = LOGO_ALIAS[key];
    const mainKey = alias ? norm(alias) : key;
    if(LOGO_MAP[mainKey]) return IMG+LOGO_MAP[mainKey];
    if(mainKey.includes('maharashtra')) return IMG+'maharastra.png';
    if(mainKey.includes('punjab')&&mainKey.includes('sind')) return IMG+'sind.png';
    if(mainKey.includes('cosmos')) return IMG+'cosmos.png';
    if(mainKey.includes('corporation')) return IMG+'corporation.png';
    if(mainKey.includes('standard chartered')) return IMG+'standard.png';
    return IMG+DEFAULT_LOGO;
  }

  function wireRadios(){
  nbBody.querySelectorAll('input[type="radio"][name="bank"]').forEach(r=>{
    if(r._w) return; r._w = true;
    r.addEventListener('change',()=>{
      // remove old CTAs
      nbBody.querySelectorAll('.bank-cta').forEach(n=>n.remove());

      const row = r.closest('.bank-item');
      // if row is hidden (filtered out), don't show CTA
      if(!row || row.offsetParent === null) return;

      // insert CTA *after* the label so the label doesn't eat the click
      row.insertAdjacentHTML('afterend', `
        <div class="bank-cta">
          <button class="btn btn-pay"
                  type="submit"
                  form="payForm"
                  formaction="/api/pay/success/"
                  formmethod="post"
                  style="margin:10px 0;width:100%">
            Proceed to Pay
          </button>
        </div>
      `);
    });
  });
}

function removeCTAs(){
  nbBody.querySelectorAll('.bank-cta').forEach(n=>n.remove());
}


function visibleBankRadios(){
  return [...nbBody.querySelectorAll('input[type="radio"][name="bank"]')]
    .filter(r => {
      const row = r.closest('.bank-item');
      return row && row.offsetParent !== null; // visible in layout
    });
}


// Ensure one radio is checked (prefer Popular list)
function ensureDefaultChecked(){
  const vis = visibleBankRadios();
  let checked = vis.find(r => r.checked);
  if (!checked && vis.length){
    vis[0].checked = true;
    checked = vis[0];
  }
  return checked || null;
}


// Attach CTA under the currently-checked bank
function attachCtaToChecked(){
  const sel = ensureDefaultChecked();
  if (sel) sel.dispatchEvent(new Event('change', { bubbles:true }));
}


  function renderAll(q=''){
    const s=(q||'').trim().toLowerCase();
    const list=s?ALL_BANKS.filter(b=>b.toLowerCase().includes(s)):ALL_BANKS;
    if(nbAllList){
      nbAllList.innerHTML=list.map(n=>`
        <label class="bank-item">
          <input type="radio" name="bank" value="${n}">
          <span class="bank-name">${n}</span>
          <img class="bank-logo" src="${logoFor(n)}" alt="${n}" loading="lazy">
        </label>
      `).join('');
    }
    wireRadios();
    return list.length;
  }

  function filterPopular(q=''){
    const s=(q||'').trim().toLowerCase();
    if(!nbPopularList) return 0;
    let shown=0;
    nbPopularList.querySelectorAll('.bank-item').forEach(el=>{
      const name=(el.querySelector('.bank-name')?.textContent||'').toLowerCase();
      const match=!s || name.includes(s);
      el.style.display = match ? '' : 'none';
      if(match) shown++;
    });
    return shown;
  }

  // helper to enter "open all" mode for THIS session (no persistence)
  function openAll(){
    allOpen = true;
    if (nbShowAll) nbShowAll.style.display = 'none';   // never show again this session
    if (nbSearchWrap) nbSearchWrap.style.display = ''; // show search
    if (nbAllList) nbAllList.style.display = '';       // show list
    if (nbDivider) nbDivider.style.display = '';       // divider between popular & all
    renderAll(nbSearch ? nbSearch.value : '');
  }

  
function applySearch(){
  const q = nbSearch ? nbSearch.value : '';
  const searching = q.trim().length > 0;

  const p = filterPopular(q);
  const a = allOpen ? renderAll(q) : 0;
  const none = (p + a) === 0;

  // Show/hide the "no results" artwork
  nbNoResults.style.display = (searching && none) ? 'block' : 'none';

  // If nothing matches: remove CTA and uncheck any radios
  if (none){
    removeCTAs();
    nbBody.querySelectorAll('input[type="radio"][name="bank"]:checked')
      .forEach(r => r.checked = false);
  } else {
    if (searching){
      // ❗ While typing / filtering: DO NOT auto-select anything and remove CTA
      removeCTAs();
      nbBody.querySelectorAll('input[type="radio"][name="bank"]:checked')
        .forEach(r => r.checked = false);
    } else {
      // (Non-search mode) keep your older behavior: ensure one visible radio is selected
      const visibleChecked = nbBody.querySelector(
        'label.bank-item:not([style*="display: none"]) input[type="radio"][name="bank"]:checked'
      );
      if (!visibleChecked){
        const firstVisible = nbBody.querySelector(
          'label.bank-item:not([style*="display: none"]) input[type="radio"][name="bank"]'
        );
        if (firstVisible){
          firstVisible.checked = true;
          firstVisible.dispatchEvent(new Event('change', { bubbles:true })); // attaches CTA
        } else {
          removeCTAs(); // safety
        }
      } else {
        // reattach CTA if needed
        visibleChecked.dispatchEvent(new Event('change', { bubbles:true }));
      }
    }
  }

  // Headings / divider visibilities
  if (nbPopularHeader) nbPopularHeader.style.display = (searching || none) ? 'none' : '';
  if (nbDivider)       nbDivider.style.display       = (!allOpen || searching || none) ? 'none' : '';

  // "Show all banks" link visible only before opening
  if (nbShowAll) nbShowAll.style.display = allOpen ? 'none' : '';

  // List visibility
  if (!allOpen){
    if (nbAllList) nbAllList.style.display = 'none';
  } else {
    if (nbAllList) nbAllList.style.display = (searching && none) ? 'none' : '';
  }
}



  nbSearch?.addEventListener('input', applySearch);

  nbShowAll?.addEventListener('click', ()=>{
  openAll();                 // enter open mode for this session
  // clear any prior selection & CTA (the default checked one)
  nbBody.querySelectorAll('input[type="radio"][name="bank"]').forEach(r=> r.checked = false);
  removeCTAs();

  applySearch();             // update visibilities
  nbNoResults.style.display = 'none';
  nbSearch?.focus();
});


  // initial render (collapsed)
  filterPopular('');
  applySearch();
  wireRadios();
  if (!allOpen) attachCtaToChecked();
})();

/* =========================================================
   GIFT CARD VALIDATION
   ========================================================= */
(function(){
  const section=document.querySelector('.section.card[data-icon="gift"]');
  const num=document.getElementById('gcNumber');
  const pin=document.getElementById('gcPin');
  const add=document.getElementById('gcAddBtn');
  const eNum=document.getElementById('gcNumberErr');
  const ePin=document.getElementById('gcPinErr');
  if(!section||!num||!pin||!add||!eNum||!ePin) return;

  num.maxLength=16;

  let tNum=false,tPin=false;
  const sanitizeNumber=()=>{ const d=numOnly(num.value).slice(0,16); if(num.value!==d) num.value=d; return d; };
  const sanitizePin   =()=>{ const d=numOnly(pin.value).slice(0,6); if(pin.value!==d) pin.value=d; return d; };

  function vNumber(){ const d=sanitizeNumber(); let msg=''; if(!d) msg='Voucher number is required'; else if(d.length!==16) msg='Enter a valid 16-digit number'; eNum.textContent=tNum?msg:''; num.classList.toggle('is-invalid', tNum && !!msg); return !msg; }
  function vPin(){ const d=sanitizePin(); let msg=''; if(!d) msg='PIN is required'; else if(d.length!==6) msg='Enter a valid 6-digit PIN'; ePin.textContent=tPin?msg:''; pin.classList.toggle('is-invalid', tPin && !!msg); return !msg; }
  function refresh(){ const ok = vNumber() & vPin(); add.disabled = !ok; }
  function reset(){ tNum=tPin=false; eNum.textContent=''; ePin.textContent=''; num.classList.remove('is-invalid'); pin.classList.remove('is-invalid'); sanitizeNumber(); sanitizePin(); add.disabled=true; }

  document.querySelectorAll('[data-accordion] .head').forEach(h=>{
    h.addEventListener('click', ()=> setTimeout(()=>{ if(!section.classList.contains('open')) reset(); },0));
  });
  [num,pin].forEach(el=>{
    el.addEventListener('input', refresh);
    el.addEventListener('beforeinput', e=>{ if(e.inputType==='insertFromPaste'||e.inputType==='insertFromDrop') requestAnimationFrame(refresh); });
    el.addEventListener('keydown', e=>{
      const ok = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
      if(ok.includes(e.key)||e.ctrlKey||e.metaKey) return;
      if(!/^\d$/.test(e.key)) e.preventDefault();
    });
  });
  num.addEventListener('blur', ()=>{ tNum=true; refresh(); });
  pin.addEventListener('blur', ()=>{ tPin=true; refresh(); });

  reset();
  add.addEventListener('click', ()=>{ tNum=tPin=true; refresh(); if(!add.disabled) alert('Gift card added!'); });
})();

/* =========================================================
   PLACE ORDER plumbing (hidden form submission from sections)
   ========================================================= */
(function(){
  const form = document.getElementById('placeOrderForm');
  const methodInput = document.getElementById('poMethod');
  if(!form || !methodInput) return;
  const submitOrder = m=>{ methodInput.value=m||''; form.submit(); };
  document.getElementById('upi-pay')?.addEventListener('click', ()=>submitOrder('upi'));
  document.getElementById('card-pay')?.addEventListener('click', ()=>submitOrder('card'));
  document.getElementById('codPlaceOrder')?.addEventListener('click', ()=>submitOrder('cod'));
  document.getElementById('emiPay')?.addEventListener('click', ()=>submitOrder('emi'));
  document.getElementById('nbBody')?.addEventListener('click', e=>{
    const btn=e.target.closest('.bank-cta .btn'); if(btn) submitOrder('net_banking');
  });
})();

/* =========================================================
   EMI CALCULATOR (reads current Total Amount)
   ========================================================= */
(function(){
  const bankSel   = document.getElementById('emiBank');
  const tenureSel = document.getElementById('emiTenure');
  const typeRadios= document.querySelectorAll('input[name="emiType"]');
  const rateNode  = document.getElementById('emiRate');
  const feeNode   = document.getElementById('emiFee');
  const monthlyNd = document.getElementById('emiMonthly');
  const payBtn    = document.getElementById('emiPay');
  const errNode   = document.getElementById('emiError');
  if(!bankSel||!tenureSel||!rateNode||!feeNode||!monthlyNd||!payBtn||!errNode) return;

  const parseAmount = t => +((t||'').toString().replace(/[^\d.]/g,''))||0;
  const getTotal = ()=> parseAmount(document.getElementById('amountMain')?.textContent || '0');

  const RATE = {
    _default:{ feePct:1.0, p:{3:13.0,6:13.5,9:14.0,12:14.5} },
    'SBI':{ feePct:0.9,  p:{3:12.5,6:13.0,9:13.5,12:14.0} },
    'HDFC Bank':{ feePct:0.75, p:{3:12.0,6:12.5,9:13.0,12:13.5} },
    'ICICI Bank':{ feePct:0.85, p:{3:12.75,6:13.25,9:13.75,12:14.25} },
    'Axis Bank':{ feePct:0.85, p:{3:12.5,6:13.0,9:13.5,12:14.0} },
    'Kotak':{ feePct:0.8, p:{3:12.75,6:13.25,9:13.5,12:13.99} },
    'Kotak Mahindra Bank':{ feePct:0.8, p:{3:12.75,6:13.25,9:13.5,12:13.99} },
  };
  const adjByType=(apr,type)=> type==='cl' ? apr+1.25 : type==='dc' ? apr+0.5 : apr;
  const typeSel = ()=> (Array.from(typeRadios).find(x=>x.checked)?.value || 'cc');

  function emi(P, apr, n){
    const r=(apr/100)/12; if(r===0) return P/n;
    const a=Math.pow(1+r,n); return P*r*a/(a-1);
  }
  function render(){
    errNode.textContent='';
    const bank=bankSel.value||'', months=+(tenureSel.value||0), total=getTotal(), type=typeSel();
    const base=RATE[bank]||RATE._default;
    const apr = adjByType(base.p[months] ?? RATE._default.p[months] ?? 0, type);
    const fee = (base.feePct/100)*total;

    if(!(months && total>0 && apr>0)){
      rateNode.textContent='—'; feeNode.textContent='—'; monthlyNd.textContent='—'; payBtn.disabled=true; return;
    }
    monthlyNd.textContent=Rs(emi(total,apr,months));
    rateNode.textContent=apr.toFixed(2)+'%';
    feeNode.textContent=Rs(fee);
    payBtn.disabled=false;
  }
  bankSel.addEventListener('change',render);
  tenureSel.addEventListener('change',render);
  typeRadios.forEach(r=> r.addEventListener('change',render));

  // keep in sync if Total Amount text changes
  (function(){
    const n=document.getElementById('amountMain'); if(!n) return;
    const mo=new MutationObserver(render); mo.observe(n,{childList:true,subtree:true,characterData:true});
  })();

  render();
  payBtn.addEventListener('click', e=>{
    const ok = bankSel.value && tenureSel.value && getTotal()>0;
    if(!ok){ e.preventDefault(); errNode.textContent='Please select Bank and Tenure to continue with EMI.'; }
  });
})();

/* ===== Universal submit wiring: fills hidden inputs for UPI/Card/Saved ===== */

(function(){
  const form = document.getElementById('payForm');
  if (!form) return;

  const hidSavedId   = document.getElementById('saved_method_id');
  const hidSavedType = document.getElementById('saved_method_type');

    function fillHidden(submitter){
    // clear saved-method fields
    if (hidSavedId)   hidSavedId.value   = '';
    if (hidSavedType) hidSavedType.value = '';

    const submitId = submitter && submitter.id;

    // 1) If this click is for a SAVED tile button, look only in that tile
    let saved = null;
    const tile = submitter && submitter.closest('.tile-row');
    if (tile) {
      saved = tile.querySelector('.saved-radio:checked');
    }

    // 2) Otherwise, if this is the UPI button, look only at saved_upi radios
    if (!saved && submitId === 'upi-pay') {
      saved = document.querySelector('input.saved-radio[name="saved_upi"]:checked');
    }

    // 3) Or if this is the CARD button, look only at saved_card radios
    if (!saved && submitId === 'card-pay') {
      saved = document.querySelector('input.saved-radio[name="saved_card"]:checked');
    }

    // 4) If we found a saved method in the relevant section, use it
    if (saved){
      if (hidSavedId)   hidSavedId.value   = saved.value;
      if (hidSavedType) hidSavedType.value = saved.dataset.type || '';

      // force "not saving a new one" when using an existing saved method
      const hSaveUpi  = document.getElementById('save_upi');
      const hSaveCard = document.getElementById('save_card');
      if (hSaveUpi)  hSaveUpi.value  = '0';
      if (hSaveCard) hSaveCard.value = '0';
      return;
    }

    // 5) No relevant saved method selected -> treat as NEW UPI / NEW CARD
    const id = submitter && submitter.id;

    // 2) NEW UPI entry
    if (id === 'upi-pay'){
      const upiInput  = document.getElementById('upi-id');
      const upiSaveCk = document.getElementById('save-upi-checkbox');
      const hSaveUpi  = document.getElementById('save_upi');
      const hVpa      = document.getElementById('upi_vpa');

      const v = (upiInput && upiInput.value || '').trim();

      const wantSave = !!(upiSaveCk && upiSaveCk.checked && v);
      if (hSaveUpi) hSaveUpi.value = wantSave ? '1' : '0';
      if (hVpa)     hVpa.value     = wantSave ? v   : '';   // only send VPA when saving
    }

    // 3) NEW Card entry
    if (id === 'card-pay'){
      const numEl  = document.getElementById('card-number');
      const expEl  = document.getElementById('expiry');
      const saveCk = document.getElementById('save-card-checkbox');

      const hSave   = document.getElementById('save_card');
      const hLast4  = document.getElementById('card_last4');
      const hBrand  = document.getElementById('card_brand');
      const hMM     = document.getElementById('card_exp_month');
      const hYY     = document.getElementById('card_exp_year');
      const hMasked = document.getElementById('card_masked');
      const hName   = document.getElementById('card_holder_hidden'); // if you add one later

      const raw   = (numEl && numEl.value || '').replace(/\D+/g,'');
      const last4 = raw.slice(-4);

      function detectBrand(d){
        if (/^4/.test(d))        return 'VISA';
        if (/^5[1-5]/.test(d))   return 'MASTERCARD';
        if (/^3[47]/.test(d))    return 'AMEX';
        if (/^6(?:011|5)/.test(d)) return 'DISCOVER';
        return 'CARD';
      }
      const brand = detectBrand(raw);

      let mm = null, yy = null;
      const m = (expEl && expEl.value || '').match(/^(\d{2})\s*\/\s*(\d{2})$/);
      if (m){
        mm = parseInt(m[1],10);
        yy = parseInt('20' + m[2],10);
      }

      const wantSave = !!(saveCk && saveCk.checked && raw.length >= 12);

      if (wantSave){
        if (hSave)   hSave.value   = '1';
        if (hLast4)  hLast4.value  = last4;
        if (hBrand)  hBrand.value  = brand;
        if (hMM)     hMM.value     = mm || '';
        if (hYY)     hYY.value     = yy || '';
        if (hMasked) hMasked.value = `${brand} •••• ${last4}`;
      } else {
        if (hSave)   hSave.value   = '0';
        if (hLast4)  hLast4.value  = '';
        if (hBrand)  hBrand.value  = '';
        if (hMM)     hMM.value     = '';
        if (hYY)     hYY.value     = '';
        if (hMasked) hMasked.value = '';
      }
    }
  }

  // Intercept clicks on any payment button that posts payForm
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-pay[form="payForm"]');
    if (!btn) return;

    const targetForm = document.getElementById(btn.getAttribute('form'));
    if (!targetForm) return;

    e.preventDefault();

    // copy button's formaction / formmethod onto the form
    if (btn.hasAttribute('formaction')){
      targetForm.action = btn.getAttribute('formaction');
    }
    if (btn.hasAttribute('formmethod')){
      targetForm.method = btn.getAttribute('formmethod');
    }

    fillHidden(btn);          //  fill save_upi / save_card etc.
    btn.disabled = true;
    targetForm.requestSubmit(btn);   // fires normal submit flow
  }, true);

  // Safety: if something submits form without our click handler
  form.addEventListener('submit', function(e){
    const submitter = e.submitter || null;
    fillHidden(submitter);
  });
})();

   

/* =========================================================
Spinner 
========================================================= */

(function(){
  const overlay   = document.getElementById('nav-loading');
  const payForm   = document.getElementById('payForm') || document.querySelector('form[action][method="post"]');
  const once = { shown:false };

  function showLoader(msg){
    if (once.shown) return;
    once.shown = true;
    if (msg) overlay.querySelector('.nav-msg').textContent = msg;
    document.body.classList.add('is-busy');
    overlay.classList.add('is-on');
    // disable all form controls to avoid double submit
    document.querySelectorAll('button, input, select, textarea, a').forEach(el=>{
      if (el.closest('#nav-loading')) return; // don't disable overlay itself
      el.setAttribute('tabindex','-1');
      el.setAttribute('aria-disabled','true');
      if (el.tagName === 'BUTTON' || (el.tagName === 'INPUT' && /submit|button/.test(el.type))) {
        el.disabled = true;
      }
    });
  }

  // 1) When the payment form submits
  if (payForm){
    payForm.addEventListener('submit', function(){
      showLoader('Processing payment…');
    });
  }

  // 2) Also show on any navigation trigger (links/buttons with href)
  document.addEventListener('click', function(e){
    const a = e.target.closest('a[href]:not([target="_blank"])');
    if (!a) return;
    // ignore in-page anchors
    if (a.getAttribute('href').startsWith('#')) return;
    showLoader('Loading…');
  });

  // 3) If the browser is doing a page unload, show it too
  window.addEventListener('beforeunload', function(){
    showLoader('Processing…');
  });

  // 4) If page is restored from bfcache, remove the busy state
  window.addEventListener('pageshow', function(e){
    if (e.persisted){
      overlay.classList.remove('is-on');
      document.body.classList.remove('is-busy');
      once.shown = false;
    }
  });
})();


/* =========================================================
Global Dark ro White mode 
========================================================= */
(function () {
  const root = document.documentElement;

  function apply(mode) {
    const theme = (mode === 'dark') ? 'dark' : 'light';
    root.dataset.theme = theme;           // <-- all CSS reads this
    root.style.colorScheme = theme;       // form controls, UA styles
    try { localStorage.setItem('theme', theme); } catch {}
  }

  // initial
  const saved = localStorage.getItem('theme');
  apply(saved === 'dark' ? 'dark' : 'light');

  // header toggle (adapt id if different)
  document.getElementById('theme-toggle-header')?.addEventListener('click', () => {
    apply((root.dataset.theme === 'dark') ? 'light' : 'dark');
  });

  // cross-tab sync
  addEventListener('storage', (e) => {
    if (e.key === 'theme') apply(e.newValue === 'dark' ? 'dark' : 'light');
  });
})();


/* ================== DJANGO CSRF HELPERS ================== */
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? decodeURIComponent(m.pop()) : '';
}

/* ================== PAYMENT INACTIVITY TIMER ==================
   - Default is 60_000ms; override with data-timeout-ms on #paymentsTop (e.g. 10000 for testing).
   - Sends POST to /api/pay/timeout/ exactly once per page load.
================================================================= */
(function paymentTimeout(){
  const area    = document.getElementById('paymentsTop') || document.body;
  const payForm = document.getElementById('payForm');
  const modal   = document.getElementById('payTimeoutModal');
  const stayBtn = document.getElementById('payTimeoutStay');
  const ordersBtn = document.getElementById('payTimeoutOrders');

    // after: const stayBtn = ...; const ordersBtn = ...;
  const countdownEl = document.getElementById('ptoCountdown');
  const fillEl = document.getElementById('ptoFill');
  const REDIRECT_SEC = 20; // change to taste
  let cdTimer = null, cdLeft = REDIRECT_SEC;

  function startCountdown(){
    // reset
    cdLeft = REDIRECT_SEC;
    update();
    clearInterval(cdTimer);
    cdTimer = setInterval(() => {
      cdLeft--;
      update();
      if (cdLeft <= 0){
        clearInterval(cdTimer);
        // ensure server knows; then redirect
        postTimeoutOnce().finally(() => { window.location.href = '/api/vieworders/'; });
      }
    }, 1000);
  }
  function stopCountdown(){ clearInterval(cdTimer); }
  function update(){
    if (countdownEl) countdownEl.textContent = `Auto-redirecting in ${cdLeft}s…`;
    if (fillEl){
      const pct = Math.max(0, Math.min(100, 100 * (REDIRECT_SEC - cdLeft) / REDIRECT_SEC));
      fillEl.style.width = pct + '%';
      const bar = fillEl.parentElement;
      if (bar) bar.setAttribute('aria-valuenow', String(Math.round(pct)));
    }
  }

  // hook into show/hide
  const _showModal = showModal;
  showModal = function(){ _showModal(); startCountdown(); };
  const _hideModal = hideModal;
  hideModal = function(){ stopCountdown(); _hideModal(); };

  // cancel countdown if user continues here
  stayBtn?.addEventListener('click', (e) => { stopCountdown(); });


  if (!modal) return; // no modal, nothing to do

  const DEFAULT_MS = 40_000;
  const ms = Number(area?.dataset?.timeoutMs || DEFAULT_MS);

  let timerId = null;
  let submitted = false;
  let posted = false; // ensure we POST only once

  function startTimer(){
    clearTimeout(timerId);
    timerId = setTimeout(onTimeout, ms);
  }
  function stopTimer(){
    clearTimeout(timerId);
    timerId = null;
  }
  function showModal(){
  modal.classList.add('show');
  modal.removeAttribute('hidden');
  // ⬇lock background
  document.documentElement.classList.add('modal-open'); // <html>
  document.body.classList.add('modal-open');            // <body>
  // hard fallback against !important rules
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
}

function hideModal(){
  modal.classList.remove('show');
  // ⬇ unlock background
  document.documentElement.classList.remove('modal-open');
  document.body.classList.remove('modal-open');
  // remove hard fallback
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
}

  async function postTimeoutOnce(){
    if (posted) return;
    posted = true;
    try{
      const res = await fetch('/api/pay/timeout/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ reason: 'inactivity' }),
        credentials: 'same-origin'
      });
      // (optional) log to console for quick debugging
      if (!res.ok){
        const txt = await res.text().catch(()=> '');
        console.warn('pay timeout POST failed:', res.status, txt);
      }
    }catch(err){
      console.warn('pay timeout POST error:', err);
    }
  }

  async function onTimeout(){
    if (submitted) return;     // user already started paying
    await postTimeoutOnce();   // tell backend to log "Payment Failed"
    showModal();               // show dialog
  }

  // 1) Start timer on load
  startTimer();

  // 2) Any interaction in the payment area resets the timer
  ['click','keydown','pointerdown','touchstart','wheel'].forEach(ev => {
    area.addEventListener(ev, () => { if (!submitted) startTimer(); }, { passive: true });
  });

  // 3) If the user actually submits the payment form, cancel the timeout
  payForm?.addEventListener('submit', () => { submitted = true; stopTimer(); });

  // 4) Visibility changes: if they leave the tab, keep the timer running; if they come back, keep counting.
  //    (No special handling needed, but you can pause/resume if preferred.)

  // 5) Modal buttons
  stayBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    hideModal();
    if (!submitted) startTimer(); // give them another window
  });

  ordersBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    // ensure we told backend (in case user clicks quickly)
    postTimeoutOnce().finally(() => {
      window.location.href = '/api/vieworders/';
    });
  });

  // 6) Close modal on backdrop click (optional)
  modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
})();


// --- CSRF helper ---------------------------------------------------
function getCsrfToken(form){
  // try hidden input inside the form first
  const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
  if (input && input.value) return input.value;

  // fallback: read from cookie
  const m = document.cookie.match(/csrftoken=([^;]+)/);
  return m ? m[1] : "";
}

// Helper actions for Saved Methods (Default/Delete)
async function setDefault(e, form){
  e.preventDefault();
  const details = form.closest('details');   // 3-dot menu

  try{
    const csrf = getCsrfToken(form);
    const res = await fetch(form.action, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    });

    const data = await res.json().catch(() => ({}));

    if (res.ok && data.ok){
      if (details) details.open = false;    // close dropdown
      location.reload();                    // refresh to show new Default badge
    } else {
      console.error("setDefault failed", res.status, data);
      alert("Failed to set default.");
    }
  } catch (err){
    console.error(err);
    alert("Network error while setting default.");
  }
}
// ===== Delete saved method with custom confirm modal =====
let pmPendingForm = null;
let pmPendingDetails = null;

function openDeleteModal(form){
  pmPendingForm    = form;
  pmPendingDetails = form.closest('details');

  const modal    = document.getElementById('pm-confirm-modal');
  const backdrop = document.getElementById('pm-confirm-backdrop');
  const text     = document.getElementById('pm-confirm-text');

  if (text) {
    // You can customize this later to show card/UPI name
    text.textContent = 'Delete this saved payment method?';
  }

  if (modal && backdrop){
    modal.style.display = 'block';
    backdrop.style.display = 'block';
    document.documentElement.classList.add('vo-lock');
  }
}

function closeDeleteModal(){
  const modal    = document.getElementById('pm-confirm-modal');
  const backdrop = document.getElementById('pm-confirm-backdrop');

  if (modal && backdrop){
    modal.style.display = 'none';
    backdrop.style.display = 'none';
    document.documentElement.classList.remove('vo-lock');
  }
  pmPendingForm = null;
  pmPendingDetails = null;
}

// this is what your Delete button calls
function deleteMethod(e, form){
  e.preventDefault();
  openDeleteModal(form);
}

// wire up the modal buttons once
(function(){
  const btnRemove = document.getElementById('pm-confirm-remove');
  const btnCancel = document.getElementById('pm-confirm-cancel');
  const btnX      = document.getElementById('pm-confirm-close');
  const backdrop  = document.getElementById('pm-confirm-backdrop');

  async function reallyDelete(){
    if (!pmPendingForm) return closeDeleteModal();

    try{
      const csrf = pmPendingForm.querySelector('[name=csrfmiddlewaretoken"]').value;
      const res = await fetch(pmPendingForm.action, {
        method: "POST",               // hits saved_method_delete (home service)
        headers: {
          "X-CSRFToken": csrf,
          "X-Requested-With": "XMLHttpRequest",
        },
        credentials: "same-origin",
      });

      if (res.ok){
        // remove tile from the DOM without full reload
        const tile = pmPendingForm.closest('.tile-row');
        if (tile) tile.remove();

        if (pmPendingDetails) pmPendingDetails.open = false;
        closeDeleteModal();
      } else {
        const txt = await res.text().catch(()=> '');
        console.error('delete failed', res.status, txt);
        closeDeleteModal();
        alert("Delete failed.");
      }
    } catch (err){
      console.error(err);
      closeDeleteModal();
      alert("Network error while deleting.");
    }
  }

  btnRemove && btnRemove.addEventListener('click', reallyDelete);
  btnCancel && btnCancel.addEventListener('click', closeDeleteModal);
  btnX      && btnX.addEventListener('click', closeDeleteModal);
  backdrop  && backdrop.addEventListener('click', closeDeleteModal);
})();

/* Close any open 3-dot menus when clicking outside or pressing Esc */
document.addEventListener('click', (e) => {
  document.querySelectorAll('details.dots[open]').forEach(d => {
    if (!d.contains(e.target)) d.removeAttribute('open');
  });
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape'){
    document.querySelectorAll('details.dots[open]').forEach(d => {
      d.removeAttribute('open');
    });
  }
});



// When the shopper picks a saved UPI/Card, push id & type into the hidden form fields
(function(){
  const hidId  = document.getElementById('saved_method_id');
  const hidTyp = document.getElementById('saved_method_type');
  if (!hidId || !hidTyp) return;

  function onChange(e){
    const r = e.target;
    if (!r || !r.classList || !r.classList.contains('saved-radio')) return;
    hidId.value  = r.value;              // numeric id of SavedPaymentMethod
    hidTyp.value = r.dataset.type || ''; // 'upi' or 'card'
  }

  document.addEventListener('change', onChange);
})();


(function(){
  // show Proceed button under the chosen tile + set hidden inputs
  function activateTile(tile){
    document.querySelectorAll('.tile .pay-for-tile').forEach(b=>b.classList.add('hidden'));
    if(!tile) return;
    const btn = tile.querySelector('.pay-for-tile');
    if(btn) btn.classList.remove('hidden');

    const id   = tile.getAttribute('data-method-id');
    const type = tile.getAttribute('data-method-type');
    const hidId   = document.getElementById('saved_method_id');
    const hidType = document.getElementById('saved_method_type');
    if(hidId)   hidId.value = id || '';
    if(hidType) hidType.value = type || '';
  }

  // when a saved radio is clicked
  document.addEventListener('change', function(e){
    const r = e.target.closest('.saved-radio');
    if(!r) return;
    const tile = r.closest('.tile');
    activateTile(tile);
  });

  // on load, show button under the default-checked tile (if any)
  const initiallyChecked = document.querySelector('.saved-radio:checked');
  if(initiallyChecked) activateTile(initiallyChecked.closest('.tile'));

  // Add new links -> reveal manual entry forms
  const linkAddUpi  = document.getElementById('link-add-upi');
  const linkAddCard = document.getElementById('link-add-card');
  if(linkAddUpi){
    linkAddUpi.addEventListener('click', function(e){
      e.preventDefault();
      document.getElementById('new-upi-wrap')?.classList.remove('hidden');
      // unselect any radio so we save new value
      document.querySelectorAll('input[name="saved_upi"]').forEach(x=>x.checked=false);
      activateTile(null);
      document.getElementById('upi-id')?.focus();
    });
  }
  if(linkAddCard){
    linkAddCard.addEventListener('click', function(e){
      e.preventDefault();
      document.getElementById('new-card-wrap')?.classList.remove('hidden');
      document.querySelectorAll('input[name="saved_card"]').forEach(x=>x.checked=false);
      activateTile(null);
      document.getElementById('card-holder-name')?.focus();
    });
  }
})();

(function(){
  // Show Proceed button only for selected tile + highlight tile
  function refreshTileUI(scope){
    const root = scope || document;
    root.querySelectorAll('.tile-row').forEach(row=>{
      const r = row.querySelector('.saved-radio');
      const btn = row.querySelector('.pay-for-tile');
      const on = r && r.checked;
      row.classList.toggle('selected', !!on);
      if(btn) btn.classList.toggle('hidden', !on);
    });
  }
  document.addEventListener('change', (e)=>{
    if(e.target.classList.contains('saved-radio')){
      // unselect all other tiles in that section
      const section = e.target.closest('.collapsible') || document;
      section.querySelectorAll('.saved-radio').forEach(r=>{
        if(r!==e.target) r.closest('.tile-row')?.classList.remove('selected');
      });
      refreshTileUI(section);
    }
  });

  // “Add new …” toggles
  const addUpi  = document.getElementById('link-add-upi');
  const newUpi  = document.getElementById('new-upi-wrap');
  if(addUpi && newUpi){ addUpi.addEventListener('click', ()=>{ newUpi.classList.toggle('hidden'); }); }

  const addCard = document.getElementById('link-add-card');
  const newCard = document.getElementById('new-card-wrap');
  if(addCard && newCard){ addCard.addEventListener('click', ()=>{ newCard.classList.toggle('hidden'); }); }

  // initial pass
  refreshTileUI();
})();



// Show existing validated forms when "+ Add new ..." is clicked
(function(){
  // UPI
  const addUpiBtn  = document.getElementById('link-add-upi');
  const upiWrap    = document.getElementById('upi-manual-wrap');
  if (addUpiBtn && upiWrap){
    addUpiBtn.addEventListener('click', function(e){
      e.preventDefault();
      upiWrap.style.display = 'block';
      upiWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // unselect saved so backend understands this is a new ID
      document.querySelectorAll('input[name="saved_upi"]')
              .forEach(r => r.checked = false);
    });
  }

  // CARD
  const addCardBtn = document.getElementById('link-add-card');
  const cardWrap   = document.getElementById('card-manual-wrap');
  if (addCardBtn && cardWrap){
    addCardBtn.addEventListener('click', function(e){
      e.preventDefault();
      cardWrap.style.display = 'block';
      cardWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
      document.querySelectorAll('input[name="saved_card"]')
              .forEach(r => r.checked = false);
    });
  }
})();

(function(){
  /* Show the full manual form when "+ Add new ..." is clicked */

  // ----- UPI -----
    // ----- UPI -----
  const addUpiBtn   = document.getElementById('link-add-upi');
  const upiManual   = document.getElementById('upi-manual');
  const upiSubtitle = document.getElementById('upi-subtitle');

  if (addUpiBtn && upiManual){
    addUpiBtn.addEventListener('click', function(e){
      e.preventDefault();
      upiManual.classList.remove('hidden');
      addUpiBtn.classList.add('hidden');
      if (upiSubtitle) upiSubtitle.style.display = 'block';

      document.querySelectorAll('input[name="saved_upi"]').forEach(r => r.checked = false);

      const upiInput = document.getElementById('upi-id');
      const err      = document.getElementById('upi-id-error');
      const verify   = document.getElementById('upi-verify');
      const pay      = document.getElementById('upi-pay');

      if (upiInput) upiInput.value = '';
      if (err)      err.textContent = '';
      if (verify)   verify.disabled = true;
      if (pay)      pay.disabled    = true;

      upiInput?.focus();
    });
  }


  // ----- CARD -----
  const addCardBtn = document.getElementById('link-add-card');
  const cardManual = document.getElementById('card-manual');

  if (addCardBtn && cardManual){
    addCardBtn.addEventListener('click', function (e){
      e.preventDefault();
      cardManual.classList.remove('hidden');
      addCardBtn.classList.add('hidden');

      // clear any selected saved card
      document.querySelectorAll('input[name="saved_card"]').forEach(r => r.checked = false);

      // reset card fields & errors
      ['card-name','card-number','expiry','cvv'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.value = '';
          el.classList.remove('is-invalid');
        }
      });
      ['card-name-error','card-number-error','expiry-error','cvv-error'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '';
      });

      const payBtn = document.getElementById('card-pay');
      if (payBtn) payBtn.disabled = true;  // validation JS will re-enable when valid

      const cardNameInput = document.querySelector('#cardSection input#card-holder-name');
      if (cardNameInput){
        cardNameInput.scrollIntoView({ behavior:'smooth', block:'center' });
        cardNameInput.focus();
      }
    });
  }
})();


(function(){
  function refreshTiles(){
    document.querySelectorAll('.tile-row').forEach(row => {
      const r   = row.querySelector('.saved-radio');
      const btn = row.querySelector('.pay-for-tile');
      const on  = r && r.checked;
      row.classList.toggle('selected', !!on);
      if (btn) btn.classList.toggle('hidden', !on);
    });
  }

  document.addEventListener('change', e => {
    if (!e.target.classList || !e.target.classList.contains('saved-radio')) return;
    const scope = e.target.closest('.collapsible') || document;
    scope.querySelectorAll('.saved-radio').forEach(r => {
      if (r !== e.target) r.checked = false;
    });
    refreshTiles();
  });

  // initial state (default card/upi)
  refreshTiles();
})();



// ------------ Pretty confirm modal for saved-method delete ------------
(function(){
  const modal    = document.getElementById("sm-confirm-modal");
  const back     = document.getElementById("sm-confirm-backdrop");
  const btnYes   = document.getElementById("sm-confirm-yes");
  const btnNo    = document.getElementById("sm-confirm-no");
  const btnClose = document.getElementById("sm-confirm-close");
  const textEl   = document.getElementById("sm-confirm-text");

  if (!modal || !back) return;

  function lockScroll(){
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    document.body.dataset.smLockY = y;
    document.body.style.position = "fixed";
    document.body.style.top = `-${y}px`;
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";
  }
  function unlockScroll(){
    const y = parseInt(document.body.dataset.smLockY || "0", 10);
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.left = "";
    document.body.style.right = "";
    document.body.style.width = "";
    window.scrollTo(0, y);
    delete document.body.dataset.smLockY;
  }

  window.openSavedMethodConfirm = function(form){
    __pendingDeleteForm = form;  // global from above

    // attempt to put the masked value / card brand in the text
    let label = "this payment method";
    const row = form.closest(".tile-row");
    const txt = row?.querySelector(".radio-text strong");
    if (txt && txt.textContent.trim()) {
      label = txt.textContent.trim();
    }
    textEl.textContent = `Are you sure you want to delete '${label}'?`;

    modal.style.display = "block";
    back.style.display  = "block";
    lockScroll();
  };

  function close(){
    modal.style.display = "none";
    back.style.display  = "none";
    unlockScroll();
    __pendingDeleteForm = null;
  }

  btnNo   ?.addEventListener("click", close);
  btnClose?.addEventListener("click", close);
  back    ?.addEventListener("click", close);

  btnYes?.addEventListener("click", function(){
    if (!__pendingDeleteForm) {
      close();
      return;
    }
    // actually perform the delete (AJAX)
    doDeleteSavedMethod(__pendingDeleteForm);
    close();
  });
})();


(function(){
  /* Show / hide manual forms + sync with saved tiles */

  const addUpiBtn   = document.getElementById('link-add-upi');
  const upiManual   = document.getElementById('upi-manual');
  const addCardBtn  = document.getElementById('link-add-card');
  const cardManual  = document.getElementById('card-manual');

  function clearSavedTiles(type){
    const name = (type === 'upi') ? 'saved_upi' : 'saved_card';
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
      r.checked = false;
      const row = r.closest('.tile-row');
      if (row){
        row.classList.remove('selected');
        const btn = row.querySelector('.pay-for-tile');
        if (btn) btn.classList.add('hidden');
      }
    });
  }

  /* ----- UPI: "+ Add new UPI ID" ----- */
  if (addUpiBtn && upiManual){
    addUpiBtn.addEventListener('click', function(e){
      e.preventDefault();
      upiManual.classList.remove('hidden');
      addUpiBtn.classList.add('hidden');
      clearSavedTiles('upi');                            // hide saved CTA + deselect

      const upiInput = document.getElementById('upi-id');
      const err      = document.getElementById('upi-id-error');
      const verify   = document.getElementById('upi-verify');
      const pay      = document.getElementById('upi-pay');

      if (upiInput) upiInput.value = '';
      if (err)      err.textContent = '';
      if (verify)   verify.disabled = true;
      if (pay)      pay.disabled    = true;

      upiInput?.focus();
    });
  }

  /* ----- CARD: "+ Add new card" ----- */
  if (addCardBtn && cardManual){
    addCardBtn.addEventListener('click', function(e){
      e.preventDefault();
      cardManual.classList.remove('hidden');
      addCardBtn.classList.add('hidden');
      clearSavedTiles('card');                           // hide saved CTA + deselect

        ['card-name','card-number','expiry','cvv'].forEach(id => {
        const el = document.getElementById(id);
        if (el){
          el.value = '';
          el.classList.remove('is-invalid');
        }
      });
      ['card-name-error','card-number-error','expiry-error','cvv-error'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '';
      });


      const payBtn = document.getElementById('card-pay');
      if (payBtn) payBtn.disabled = true;

      const cardNameInput = document.querySelector('#cardSection input#card-holder-name');
      if (cardNameInput){
        cardNameInput.scrollIntoView({ behavior:'smooth', block:'center' });
        cardNameInput.focus();
      }
    });
  }

  /* ----- When user picks a saved method again ----- */
  document.addEventListener('change', function(e){
    const r = e.target;
    if (!r.classList || !r.classList.contains('saved-radio')) return;

    const type = r.dataset.type;

    if (type === 'upi'){
      if (upiManual) upiManual.classList.add('hidden');
      if (addUpiBtn) addUpiBtn.classList.remove('hidden');
    }

    if (type === 'card'){
      if (cardManual) cardManual.classList.add('hidden');
      if (addCardBtn) addCardBtn.classList.remove('hidden');
    }
  });
})();


// --- MAKE DEFAULT -------------------------------------------------
async function setDefault(ev, form) {
  ev.preventDefault();

  const tile  = form.closest(".tile-row");      // this card/UPI row
  if (!tile) return;

  const stack = tile.parentElement;            // container with all tiles of that section
  // detect type from data attributes or the radio
  const radio = tile.querySelector(".saved-radio");
  const methodType =
    tile.dataset.methodType ||
    (radio ? radio.dataset.type : "");

  const url      = form.action;
  const formData = new FormData(form);
  const menu     = form.closest("details");    // <-- 3-dots dropdown

  try {
    const resp = await fetch(url, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" },
      credentials: "same-origin",
    });

    if (!resp.ok) {
      console.error("Default failed", resp.status);
      alert("Could not set default. Please try again.");
      return;
    }

    const data = await resp.json().catch(() => ({}));
    if (!data.ok) {
      console.error("Default API returned false", data);
      alert("Could not set default. Please try again.");
      return;
    }

    //  SUCCESS – update UI without reloading

    // 1) Remove "Default" badge from other tiles of the same type
    if (stack) {
      stack.querySelectorAll(".tile-row").forEach(row => {
        const r = row.querySelector(".saved-radio");
        const t = row.dataset.methodType || (r ? r.dataset.type : "");
        if (t !== methodType) return;

        row.classList.remove("is-default");

        row.querySelectorAll(".badge").forEach(b => {
          if (b.textContent.trim() === "Default") b.remove();
        });
      });
    }

    // 2) Add "Default" badge to this tile
    tile.classList.add("is-default");

    // where to put the badge (card vs upi)
    let label = tile.querySelector(".radio-text");
    if (!label) {
      // fallbacks if your markup uses different wrappers
      label =
        tile.querySelector(".card-top") ||
        tile.querySelector(".upi-line") ||
        tile;
    }

    if (label) {
      // remove any existing "Default" badge inside this label
      label.querySelectorAll(".badge").forEach(b => {
        if (b.textContent.trim() === "Default") b.remove();
      });

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = "Default";
      label.appendChild(badge);
    }

    // 3) Move this tile to top of its stack
    if (stack && stack.firstElementChild !== tile) {
      stack.insertBefore(tile, stack.firstElementChild);
    }

    // 4) Select its radio and fire change so your existing code updates
    if (radio) {
      radio.checked = true;
      radio.dispatchEvent(new Event("change", { bubbles: true }));
    }

    // 5) Close the 3-dots menu after action
    if (menu) {
      menu.removeAttribute("open");   // or: menu.open = false;
    }

    // No reload → the Card accordion stays open & UPI doesn’t steal focus ✨

  } catch (err) {
    console.error("Default error", err);
    alert("Could not set default. Please try again.");
  }
}
// ---------- DELETE: open pretty confirm modal + AJAX delete ----------

let smPendingDeleteForm = null;

// helper in case you don't already have it
function getCookie(name) {
  const match = document.cookie.split("; ").find(row => row.startsWith(name + "="));
  return match ? decodeURIComponent(match.split("=")[1]) : "";
}

// open modal when user clicks "Delete" in 3-dots menu
function openSavedMethodConfirm(form) {
  const modal = document.getElementById("sm-confirm-modal");
  const back  = document.getElementById("sm-confirm-backdrop");
  const text  = document.getElementById("sm-confirm-text");

  if (!modal || !back) return;

  smPendingDeleteForm = form;

  // fill label in confirm text
  if (text) {
    let label = "this payment method";
    const row = form.closest(".tile-row");
    const nameNode =
      row && (
        row.querySelector(".upi-id strong") ||
        row.querySelector(".card-main") ||
        row.querySelector(".radio-text strong")
      );
    if (nameNode && nameNode.textContent.trim()) {
      label = nameNode.textContent.trim();
    }
    text.textContent = `Are you sure you want to delete '${label}'?`;
  }

  modal.style.display = "block";
  back.style.display  = "block";
}

// real delete call (used by the modal's "Delete" button)
async function doDeleteSavedMethod(form) {
  if (!form) return;

  const url       = form.action;
  const csrfInput = form.querySelector('[name="csrfmiddlewaretoken"]');
  const csrf      = csrfInput ? csrfInput.value : getCookie("csrftoken");

  try {
    const resp = await fetch(url, {
      method: "POST",  // hits saved_method_delete in Home service
      headers: {
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || !data.ok) {
      console.error("Delete failed", resp.status, data);
      alert("Could not delete. Please try again.");
      return;
    }

    // remove the tile from UI (no full reload)
    const tile = form.closest(".tile-row");
    if (tile) tile.remove();
  } catch (err) {
    console.error("Delete error", err);
    alert("Could not delete. Please try again.");
  }
}

// wire up the confirm modal once
(function(){
  const modal  = document.getElementById("sm-confirm-modal");
  const back   = document.getElementById("sm-confirm-backdrop");
  const btnYes = document.getElementById("sm-confirm-yes");
  const btnNo  = document.getElementById("sm-confirm-no");
  const btnX   = document.getElementById("sm-confirm-close");

  if (!modal || !back) return;

  function closeConfirm() {
    modal.style.display = "none";
    back.style.display  = "none";
    smPendingDeleteForm = null;
  }

  btnNo  && btnNo.addEventListener("click", closeConfirm);
  btnX   && btnX.addEventListener("click", closeConfirm);
  back   && back.addEventListener("click", closeConfirm);

  btnYes && btnYes.addEventListener("click", function () {
    if (smPendingDeleteForm) {
      doDeleteSavedMethod(smPendingDeleteForm);
    }
    closeConfirm();
  });
})();



// ---------- SESSION EXPIRED MODAL (payments page) ----------
(function(){
  const modal     = document.getElementById('session-modal');
  const backdrop  = document.getElementById('session-backdrop');
  const closeBtn  = document.getElementById('session-close-outside');
  const whyLink   = document.getElementById('why-link');
  const whyBlock  = document.getElementById('session-why-text');

  if (!modal || !backdrop) return;

  let opened = false;

  function openSessionModal(){
    if (opened) return;
    opened = true;

    backdrop.style.display = 'block';
    modal.style.display    = 'block';
    backdrop.removeAttribute('hidden');
    modal.removeAttribute('hidden');

    // lock background scroll (same idea as your other modals)
    document.documentElement.classList.add('modal-open');
    document.body.classList.add('modal-open');
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
  }

  function closeSessionModal(){
    opened = false;

    backdrop.style.display = 'none';
    modal.style.display    = 'none';
    backdrop.setAttribute('hidden','hidden');
    modal.setAttribute('hidden','hidden');

    // unlock scroll
    document.documentElement.classList.remove('modal-open');
    document.body.classList.remove('modal-open');
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  // close with X
  if (closeBtn){
    closeBtn.addEventListener('click', closeSessionModal);
  }

  // close when clicking on dark backdrop
  backdrop.addEventListener('click', function(e){
    if (e.target === backdrop) closeSessionModal();
  });

  // close on Esc key
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && opened){
      closeSessionModal();
    }
  });

  // "Why did this happen?" toggle
  if (whyLink && whyBlock){
    // make sure it starts hidden (also enforced in HTML)
    whyBlock.style.display = 'none';

    whyLink.addEventListener('click', function(e){
      e.preventDefault();
      const on = (whyBlock.style.display !== 'block');
      whyBlock.style.display = on ? 'block' : 'none';
      whyLink.classList.toggle('clicked', on);
      whyLink.textContent = on ? 'Hide details' : 'Why did this happen?';
    });
  }

  // Initial check: is the session already dead?
  fetch('/api/userview/', { credentials:'same-origin' })
    .then(function(r){
      if (r.status === 401 || r.status === 403) openSessionModal();
    })
    .catch(function(){
      // If the check itself fails (network/etc.), be safe and show modal
      openSessionModal();
    });

  // Wrap window.fetch so any later 401/403 also opens the modal
  const _fetch = window.fetch.bind(window);
  window.fetch = async function(...args){
    const res = await _fetch(...args);
    if ((res.status === 401 || res.status === 403) && !opened){
      openSessionModal();
    }
    return res;
  };
})();

</script>
{% endblock %}
