{% extends 'base.html' %}
{% block gallery_assets %}{% endblock %}
{% block title %}Reviews · {{ product.product_name }}{% endblock %}

{% block extra_style %}
<style>
  :root{
  --bg:#fff; --fg:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --brand:#2563eb; --brand-600:#1d4ed8; --amber:#f59e0b; --ok:#16a34a; --err:#e11d48;
}
/* apply dark tokens when body has .dark-mode */
body.dark-mode{
  --bg:#0b1220;         /* page surfaces */
  --fg:#e2e8f0;         /* main text */
  --muted:#94a3b8;      /* secondary text / placeholders */
  --line:#3b4252;       /* borders/dividers */
}
body{ background:var(--bg); color:var(--fg); }


/* the fade on collapsed photo grid already uses var(--bg), so it adapts */

  .page{max-width:900px;margin:24px auto;padding:0 16px}
  .muted{color:var(--muted)}

  .prod-header{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-bottom:18px}
  .prod-left{display:flex;gap:12px;align-items:center}
  .prod-img{width:70px;height:70px;border-radius:8px;object-fit:cover;border:1px solid var(--line)}
  .prod-title{font-size:22px;font-weight:700;margin:0}
  .prod-price{font-weight:700}

  .section-title{font-size:18px;font-weight:700;margin:0 0 8px}
  .stars{display:inline-flex;gap:6px;margin:8px 0}
  .star{font-size:22px;cursor:pointer;color:#d1d5db}
  .star.on{color:var(--amber)}
  .input{width:100%;border:1px solid var(--line);background:var(--bg);color:var(--fg);padding:10px;border-radius:8px;outline:none;margin:4px 0 8px}
  .textarea{width:100%;border:1px solid var(--line);background:var(--bg);color:var(--fg);padding:10px;border-radius:8px;outline:none;min-height:120px;max-height:220px;resize:none}
  .media-row{display:flex;align-items:flex-start;gap:12px;margin-top:8px;flex-wrap:wrap}
  .preview{display:flex;gap:6px;flex-wrap:wrap}
  .preview > div{position:relative;display:inline-block}
  .preview img{height:80px;width:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  .btn{border:none;border-radius:6px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-600)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
  .actions{margin-top:12px;display:flex;gap:8px;align-items:center}
  .notice{display:none;margin:10px 0;padding:10px 12px;border-radius:8px;border:1px solid rgba(14,165,233,.35);background:rgba(14,165,233,.08);font-weight:600}

  .divider{border:none;border-top:1px solid var(--line);margin:20px 0}
  .empty{color:var(--muted)}

  .rv{padding:14px 0;border-bottom:1px solid var(--line)}
  .rv-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .rv-left{display:flex;align-items:center;gap:10px}
  .rv-title{font-weight:700;font-size:15px}
  .rv-body{white-space:pre-wrap;margin-top:4px;font-size:14px}
  .rv-footer{margin-top:6px;display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
  .rv-name{font-weight:600;color:var(--fg)}
  .rv-dot{opacity:.6}
  .rv-when{white-space:nowrap}
  .badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.03)}
  .rv-footer .spacer{flex:1}

  /* grid of review photos */
  .rv-images{
    display:grid;
    grid-template-columns:repeat(5, 80px);
    gap:8px;
    margin-top:6px;
  }
  .rv-images img{
    width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)
  }
  .rv-images video{
  width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)
}
  /* collapse to 2 rows initially */
  .rv-images.collapsed{
    max-height:calc(80px*2 + 8px*1);
    overflow:hidden; position:relative;
  }
  .rv-images.collapsed::after{
    content:""; position:absolute; left:0; right:0; bottom:0; height:36px;
    background:linear-gradient(to bottom, rgba(255,255,255,0), var(--bg));
  }
  .photo-toggle{margin-top:6px;background:none;border:0;color:var(--brand);font-weight:700;cursor:pointer}

  /* Rating badge */
  .rate-badge,.rate-badge.good,.rate-badge.avg,.rate-badge.bad{
    display:inline-flex;align-items:center;gap:6px;height:26px;min-width:22px;padding:0 10px;border-radius:5px;border:1px solid var(--line);font-weight:700;font-size:13px;line-height:1;color:#fff;flex:0 0 auto
  }
  .rate-badge.good{background:#1aa14c;border-color:#25a458}
  .rate-badge.avg{background:#b76527;border-color:#c66832}
  .rate-badge.bad{background:#c43535;border-color:#ad2b2b}
  .rate-star{font-size:14px}

  /* Reactions */
  .react{display:flex;align-items:center;gap:10px}
  .react-btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:20px;padding:6px 10px;background:var(--bg);cursor:pointer;font-weight:600}
  .react-btn:hover{background:#f3f4f6}
  .react-btn.active.like{background:#065f46;color:#fff;border-color:#064e3b}
  .react-btn.active.dislike{background:#7f1d1d;color:#fff;border-color:#7f1d1d}
  .react-count{font-size:12px;opacity:.8}

  /* 3-dots */
  .kebab-item{ color: var(--fg); } 
  .kebab{position:relative}
.kebab-btn{
  background: transparent;
  border:1px solid var(--line);
  border-radius:8px;
  cursor:pointer;
  padding:6px 8px;
  font-weight:700;
  font-size:18px;   /* make the dots bigger */
  line-height:1;
  color: var(--fg);
}
.kebab-btn:hover{ background: rgba(255,255,255,.06); }
  .kebab-menu{position:absolute;right:0;top:36px;min-width:140px;background:var(--bg);border:1px solid var(--line);border-radius:10px;box-shadow:0 10px 26px rgba(0,0,0,.14);padding:6px;display:none;z-index:5}
  .kebab-menu.open{display:block}
  .kebab-item{width:100%;text-align:left;border:0;background:transparent;padding:8px 10px;border-radius:8px;cursor:pointer}
  .kebab-item:hover{background:#f3f4f6}
  .kebab-item.danger{color:#b91c1c}

  body.dark-mode .kebab-menu{
  background:#0f172a;
  border-color:rgba(255,255,255,.14);
  box-shadow:0 12px 26px rgba(0,0,0,.55);
}
body.dark-mode .kebab-item{ color:#e2e8f0; }
body.dark-mode .kebab-item:hover{ background:rgba(255,255,255,.08); }
body.dark-mode .kebab-item.danger{ color:#fca5a5; }
body.dark-mode .kebab-item.danger:hover{
  background:rgba(239,68,68,.12);
  color:#fecaca;
}
  .pager .btn.current{background: var(--brand);color:#fff;border-color: var(--brand);pointer-events:none;}
  .pager{display:flex;align-items:center;justify-content:center;gap:16px;margin:24px 0}
  .pager .btn{display:inline-block;padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:var(--bg);font-weight:700;text-decoration:none}
  .btn.is-disabled{pointer-events:none;opacity:.55}
  .pager .meta{color:var(--muted);font-size:13px}

/* container */
.abuse-dd{ position:relative; display:inline-block; margin-left:6px; }

/* naked downward arrow (no box) */
.abuse-trigger{
  background:transparent !important;
  border:0 !important;
  cursor:pointer; padding:4px 6px; line-height:1;
}
.abuse-trigger:focus{ outline:none; }
.abuse-trigger svg{
  width:18px; height:18px; stroke:var(--muted);
  transition:transform .15s ease, stroke .15s ease;
}
.abuse-dd:hover .abuse-trigger svg{
  transform:rotate(180deg);           /* flip on hover like Flipkart */
  stroke:var(--fg);
}

/* tiny dropdown */
.abuse-menu{
  position:absolute; right:0; top:28px; min-width:160px;
  background:var(--bg); color:var(--fg);
  border:1px solid var(--line); border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  padding:6px; display:none; z-index:200;
}
/* open on hover (no JS needed) */
.abuse-dd:hover .abuse-menu{ display:block; }

.abuse-item{
  width:100%; text-align:left; background:transparent; border:0;
  padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700;
}
.abuse-item:hover{ background:rgba(148,163,184,.12); }
.abuse-item.danger{ color:#e11d48; }
.abuse-item[disabled]{ opacity:.6; cursor:default; }

/* dark-only touch-ups */
body.dark-mode .abuse-menu{
  border-color:rgba(255,255,255,.16);
  box-shadow:0 12px 26px rgba(0,0,0,.55);
}

/* dark tweaks */
body.dark-mode .abuse-menu{ border-color:rgba(255,255,255,.16); box-shadow:0 12px 26px rgba(0,0,0,.55); }

  /* Summary */
  .summary{display:none;grid-template-columns:130px 1fr;gap:18px;align-items:center;margin:6px 0 18px;border:1px solid var(--line);border-radius:10px;padding:14px}
  .summary-left{display:flex;flex-direction:column;align-items:center;gap:6px}
  .avg{font-size:34px;font-weight:800}
  .avg-star{color:#f59e0b;font-weight:800}
  .total{color:var(--muted);font-size:16px}
  .bars{display:flex;flex-direction:column;gap:6px}
  .bar{display:flex;align-items:center;gap:8px}
  .bar .label{width:18px;text-align:right;font-weight:700}
  .track{flex:1;height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
  /* rating bars – animate in like Flipkart */
.fill{
  height:100%;
  background:#10b981;
  width:0;                                      /* start collapsed */
  transition: width .9s cubic-bezier(.22,.8,.2,1);
  will-change: width;
}
.fill.mid{background:#f59e0b}
.fill.low{background:#ef4444}

/* accessibility: no motion when user prefers */
@media (prefers-reduced-motion: reduce){
  .fill{ transition:none; }
}

  
  /*center toast */
.toasts{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  z-index:2147483000; display:flex; flex-direction:column; gap:10px; align-items:center;
  pointer-events:none;
}
.toast{
  display:inline-flex;        /* shrink-wrap to content */
  width:auto;
  max-width:min(92vw, 720px); /* wrap on small screens/long text */
  padding:14px 18px;
  border-radius:12px;
  box-shadow:0 14px 44px rgba(0,0,0,.35);
  gap:12px; align-items:center; pointer-events:auto;

  opacity:0; transform:translateY(10px); animation:slideIn .25s ease forwards;

  background:#111827; color:#fff; border:1px solid rgba(255,255,255,.08);
  font-weight:700;
  white-space:normal;         /* allow wrapping */
  word-break:break-word;
}
  .toast.err{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
  .toast.info{background:#eff6ff;border-color:#bfdbfe;color:#1e3a8a}

/* small green check circle (only added for 'ok' toasts) */
.toast .ico{
  width:20px; height:20px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:#16a34a; color:#fff; font-size:12px; font-weight:900;
}

  @keyframes slideIn{to{opacity:1;transform:translateY(0)}}

  /* Modal confirm */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1200}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(420px,92vw);background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.25);display:none;z-index:1201}
  .modal.open,.modal-backdrop.open{display:block}
  .modal .hd{padding:14px 16px;font-weight:800;border-bottom:1px solid var(--line)}
  .modal .bd{padding:16px}
  .modal .ft{padding:12px 16px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line)}
  .btn.danger{background:#dc2626;color:#fff}

  /* Clamp long review text and show a toggle */
.rv.collapsed .rv-body{
  display:-webkit-box;
  -webkit-box-orient:vertical;
  -webkit-line-clamp:5;   
  overflow:hidden;
}
.moreless{
  background:none;border:0;padding:0;margin-top:6px;
  color:var(--brand);cursor:pointer;font-weight:700;
}
.moreless:focus{outline:2px solid var(--brand-600);outline-offset:2px}

/* ---- inline gallery overlay (light friendly) ---- */
.gal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1200;display:none}
.gal{position:fixed;inset:auto auto 6vh auto;left:50%;top:50%;transform:translate(-50%,-50%);
     width:min(1100px,96vw);max-height:90vh;background:#fff;color:#111;border-radius:14px;
     border:1px solid #e5e7eb;box-shadow:0 14px 44px rgba(0,0,0,.35);z-index:1201;display:none}
.gal.open,.gal-backdrop.open{display:block}
.gal-wrap{display:grid;grid-template-columns:1fr 360px;gap:18px;padding:18px;max-height:90vh}
.gal-left{display:flex;flex-direction:column;gap:10px}
.gal-canvas{flex:1;min-height:360px;border:1px dashed #e5e7eb;border-radius:12px;
            display:flex;align-items:center;justify-content:center;overflow:hidden}
.gal-canvas img{max-width:100%;max-height:100%}
.gal-thumbs{display:flex;gap:8px;flex-wrap:wrap}
.gal-thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
.gal-thumbs img.active{border-color:#2563eb}
.gal-nav{display:flex;justify-content:space-between;align-items:center;gap:10px}
.gal-arrow{width:36px;height:36px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:800}
.gal-close{position:absolute;right:12px;top:12px;width:34px;height:34px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}

.gi-title{font-weight:800;margin:0 0 6px}
.gi-meta{color:#64748b;font-size:12px;margin-bottom:8px;display:flex;gap:8px;align-items:center}
.gi-body{white-space:pre-wrap;font-size:14px}
.gi-read{background:none;border:0;color:#2563eb;font-weight:700;cursor:pointer;padding:0;margin-top:6px}
.gi-rate{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:6px;background:#16a34a;color:#fff;font-weight:800;margin-right:8px}

/* --- Focus ring like login (blue highlight) --- */
.input, .textarea{
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
}
.input:focus, .textarea:focus{
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(37,99,235,.35); /* blue soft ring */
  background: rgba(255,255,255,.02);
}
body.light-mode .input:focus,
body.light-mode .textarea:focus{ background:#fff; }

/* placeholders follow theme in both modes */
.input::placeholder, .textarea::placeholder{ color: var(--muted); opacity:.9; }

/* --- Make reaction counts readable in dark mode --- */
.react-count{ color: var(--fg); opacity:.95; font-weight:700; }
.react-btn.active.like .react-count,
.react-btn.active.dislike .react-count{ color:#fff; opacity:1; }

/* --- Thumbnail "View" button (so it feels like a button not cursor) --- */
.rv-images{ position:relative; }
.rv-images .rv-thumb-wrap{ position:relative; display:inline-block; }
.rv-images img{ cursor: default; } /* not a pointer anymore */

body.dark-mode .rv-view-btn{ border-color: rgba(255,255,255,.2); }

/* icon color + hover for dark mode */
body.dark-mode #theme-toggle{ color:#fff; }
body.dark-mode #theme-toggle:hover{ background: rgba(255,255,255,.10); }

.moreless,
.photo-toggle{
  background:none;
  border:0;
  color:var(--brand);
  font-weight:700;
  padding:0;
  cursor:pointer;
  border-radius:6px;            
}

.moreless:hover,
.photo-toggle:hover{ text-decoration:underline; }

/* remove the default “blue box” focus outline, keep an accessible ring */
.moreless:focus,
.photo-toggle:focus{ outline:none; }
.moreless:focus-visible,
.photo-toggle:focus-visible{
  box-shadow:0 0 0 3px rgba(37,99,235,.35);
  border-radius:6px;
}
/* review row divider in dark */
body.dark-mode .rv{ border-bottom-color: rgba(255,255,255,.10); }

/* reaction chips contrast in dark */
body.dark-mode .react-btn{
  background:#0b1220;
  border-color:rgba(255,255,255,.16);
  color:#e2e8f0;
}
body.dark-mode .react-btn:hover{ background:rgba(255,255,255,.06); }

/* keep active states punchy */
body.dark-mode .react-btn.active.like{ background:#065f46; border-color:#064e3b; color:#fff; }
body.dark-mode .react-btn.active.dislike{ background:#7f1d1d; border-color:#7f1d1d; color:#fff; }

/* thumbnails should show hand cursor (Flipkart-style) */
.rv-images img{ cursor:pointer !important; }
.rv-images video{ cursor:pointer !important; }

/* Theme toggle lives INSIDE header, not fixed */
#theme-toggle{
  float: right;             /* push to right side */
  margin-right: 18px;       /* distance from right edge */
  margin-top: -8px;         /* align vertically */
  font-size: 20px;          /* same icon size as home */
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  background: transparent;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: background .18s;
}
#theme-toggle:hover{ background:rgba(255,255,255,.10); }

/* tooltip stays the same */
#theme-tooltip{
  position:absolute; left:10%; top:110%; transform:translateX(-50%);
  background:#232323; color:#fff; padding:7px 16px; border-radius:6px;
  font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,.18);
  white-space:nowrap; margin-top:7px; z-index:2147483000; pointer-events:none;
  opacity:0; transition:opacity .15s;
}
#theme-toggle:hover #theme-tooltip{ opacity:1; }
#theme-tooltip::before{
  content:""; position:absolute; top:-7px; left:50%; transform:translateX(-50%);
  border-width:0 7px 7px 7px; border-style:solid; border-color:transparent transparent #232323 transparent;
}

/* Pager: same layout, just better dark treatment */
.pager{ display:flex; align-items:center; justify-content:center; gap:12px; margin:24px 0; }
.pager .btn{
  background:var(--bg); color:var(--fg); border:1px solid var(--line);
  border-radius:999px; font-weight:700;
}
.pager .btn:hover{ background:rgba(148,163,184,.12) }
.pager .btn.is-disabled{ opacity:.45; pointer-events:none; }
.pager .meta{ color:var(--muted); }


.preview video{ width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line); }
.preview img  { width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line); }
.preview .kill{
  position:absolute;top:-6px;right:-6px;border:none;background:#ef4444;color:#fff;
  width:22px;height:22px;border-radius:999px;cursor:pointer;font-weight:800;line-height:1
}
.preview > div{ position:relative; display:inline-block; }

/* ==== Flipkart-like Certified Buyer mark: grey circle + bold white tick ==== */
.cert{ display:inline-flex; align-items:center; gap:8px; margin-left:8px; font-weight:700; color:var(--muted); }

.cert .tick{ 
  width:18px; height:18px; flex:0 0 18px; 
  display:inline-block; vertical-align:middle;
}

/* solid grey circle behind the tick */
.cert .tick-bg{ fill:#9ca3af; }                 /* slate-400 */
body.dark-mode .cert .tick-bg{ fill:#6b7280; }  /* slate-500 in dark */

/* thick, fully white check */
.cert .tick-mark{
  stroke:#fff;            /* pure white */
  stroke-width:3;         /* bolder like Flipkart */
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
}


/* --- Video thumbs: same play-badge overlay as gallery --- */
.rv-images .rv-thumb{                         /* wrapper for thumbs */
  position:relative; display:inline-flex;
  width:80px; height:80px; border-radius:8px; overflow:visible;
}
.rv-images .rv-thumb > video,
.rv-images .rv-thumb > img{
  width:100%; height:100%;
  object-fit:cover; border-radius:8px; border:1px solid var(--line);
  box-sizing:border-box;
}

/* centered play badge (circle + triangle) */
.rv-images .rv-thumb[data-vid="1"]::after{
  content:""; position:absolute; left:50%; top:50%;
  width:40px; height:40px; border-radius:999px;
  background:
    radial-gradient(circle at 45% 35%, rgba(255,255,255,.14), transparent 45%),
    rgba(0,0,0,.55);
  border:2px solid rgba(255,255,255,.95);
  box-shadow:0 1px 3px rgba(0,0,0,.25);
  transform:translate(-50%,-50%);
  pointer-events:none;
}
.rv-images .rv-thumb[data-vid="1"]::before{
  content:""; position:absolute; left:50%; top:50%;
  border-left:12px solid #fff; border-top:8px solid transparent; border-bottom:8px solid transparent;
  transform:translate(calc(-50% + 2px), -50%);
  filter:drop-shadow(0 0 1px rgba(0,0,0,.85)) drop-shadow(0 1px 2px rgba(0,0,0,.45));
  pointer-events:none;
}

/* Play badge should fade away on hover (like review_gallery) */
.rv-images .rv-thumb[data-vid="1"]::after,
.rv-images .rv-thumb[data-vid="1"]::before{
  opacity: 1;
  transition: opacity .15s ease;
}

/* on hover hide the badge (video still a static thumb) */
.rv-images .rv-thumb[data-vid="1"]:hover::after,
.rv-images .rv-thumb[data-vid="1"]:hover::before{
  opacity: 0;
}

/* make sure the wrapper, not the <video>, gets the click */
.rv-images .rv-thumb{ cursor: pointer; }
/* Video thumbs shouldn't eat the click or show PiP overlay */
.rv-images .rv-thumb video{
  pointer-events: none;       
}
.prod-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.prod-right {
  display: flex;
  align-items: center;
  gap: 12px;   /* spacing between count and toggle */
}

/* --- compact pager overrides --- */
.pager{ gap:8px; margin:16px 0; }
.pager .btn{ padding:4px 10px; font-size:13px; border-radius:10px; }  /* numbers smaller */
.pager .meta{ font-size:12px; }

/* make PREVIOUS/NEXT look like plain text links (still clickable) */
.pager .btn.nav{
  background: transparent;
  border: 0;
  padding: 0;
  color: var(--brand);
  font-weight: 700;
  text-decoration: none;          /* no underline */
  border-radius: 0;
}
.pager .btn.nav:hover{ text-decoration: none; opacity:.85; }
.pager .btn.nav.is-disabled{ opacity:.45; pointer-events:none; }

/* tiny spinner that appears during fast navigation */
#pager-spin{
  display:none; width:14px; height:14px;
  border:2px solid var(--line);
  border-top-color: var(--brand);
  border-radius:50%;
  animation: pagerSpin .7s linear infinite;
}
.pager.loading #pager-spin{ display:inline-block; }

@keyframes pagerSpin{ to{ transform:rotate(360deg); } }

</style>
{% endblock %}

{% block content %}
<div class="page">

  <!-- config for JS -->
  <div id="config"
     data-submit-url="{% url 'submit_review' product.product_id %}"
     data-product-id="{{ product.product_id }}"
     data-user-id="{{ current_user_id|default:'' }}"
     data-ratings="{{ rating_count|default:0 }}"
     data-reviews="{{ review_count|default:0 }}"></div>

  <!-- header -->
  <div class="prod-header">
    <div class="prod-left">
      <img class="prod-img" src="{{ product.image|default:'' }}" alt="{{ product.product_name }}">
      <div>
        <h1 class="prod-title">{{ product.product_name }}</h1>
        <div class="prod-price">₹ {{ product.price }}</div>
        <div class="muted">{{ product.product_description }}</div>
      </div>
    </div>
    <div class="muted">
  <span id="review-count">
    {% if rating_count or review_count %}
      {{ rating_count|default:0 }} rating{{ rating_count|pluralize }}{% if review_count %} &amp; {{ review_count }} review{{ review_count|pluralize }}{% endif %}
    {% else %}
      No ratings yet
    {% endif %}
  </span></div>
  </div>

  <!-- rating summary (hidden until JS fills it) -->
  <div id="rating-summary" class="summary">
    <div class="summary-left">
      <div class="avg"><span id="avg-rating">0.0</span> <span class="avg-star">★</span></div>
<div class="total" id="total-ratings">
  <span id="count-ratings">0</span> Ratings<br>
  <span id="count-reviews">0</span> Reviews
</div>
    </div>
    <div class="bars">
      {% for s in "54321" %}
      <div class="bar">
        <div class="label">{{ s }}★</div>
        <div class="track"><div class="fill {% if s == '3' %}mid{% elif s in '21' %}low{% endif %}" id="bar-{{ s }}" style="width:0%"></div></div>
        <div class="count" id="count-{{ s }}">0</div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% include "review_enhancements.html" %}

  <!-- write review -->
  {% if can_review %}
    <h3 class="section-title">Write a review</h3>
    <div id="already-msg" class="notice">You’ve already reviewed this product. You can edit your existing review below.</div>

    <form id="review-form" action="{% url 'submit_review' product.product_id %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="rating" id="rating-input" value="0">

      <div class="stars" id="stars">
        {% for i in "12345" %}<span class="star" data-v="{{ forloop.counter }}">★</span>{% endfor %}
      </div>

      <input id="title" name="title" type="text" class="input" placeholder="Add a review title (e.g., ‘Must buy!’)">
      <textarea id="body" name="body" class="textarea" placeholder="Share details on quality, fit, pros & cons…"></textarea>

     <div class="media-row">
  <!-- One visible picker for both types -->
  <label for="media" class="btn ghost">+ Add photo/video</label>
  <input id="media" type="file" accept="image/*,video/*" style="display:none" multiple>
  <input id="images" name="images" type="file" accept="image/*" style="display:none" multiple>
  <input id="videos" name="videos" type="file" accept="video/*" style="display:none" multiple>
  <div id="media-preview" class="preview hint">No media selected</div>
</div>
      <div class="actions">
        <button id="submit-btn" type="submit" class="btn primary">Submit review</button>
        <button id="cancel-edit" type="button" class="btn ghost" style="display:none">Cancel edit</button>
      </div>
    </form>
  {% else %}
    <h3 class="section-title">Write a review</h3>
    <div class="notice" style="display:block">Only customers who purchased this item can leave a review.</div>
  {% endif %}

  <hr class="divider">

  <!-- customer reviews -->
  <h3 class="section-title">Customer reviews</h3>

  {% if pinned_review %}
    <div class="rv" data-review-id="{{ pinned_review.review_id }}" style="border-left:3px solid #aee1f8;padding-left:10px">
    <div class="rv-head">
      <div class="rv-left">
        {% with pinned_review.rating as rt %}
          <div class="rate-badge {% if rt >= 4 %}good{% elif rt == 3 %}avg{% else %}bad{% endif %}">
            <span>{{ rt }}</span><span class="rate-star">★</span>
          </div>
        {% endwith %}
        {% if pinned_review.title %}<div class="rv-title">{{ pinned_review.title }}</div>{% endif %}
      </div>
    </div>

{% if pinned_review.body %}
  <div class="rv-body">{{ pinned_review.body }}</div>
  <button type="button" class="moreless" hidden>Read more</button>
{% endif %}
    {% if pinned_review.image_urls or pinned_review.image_url or pinned_review.video_urls %}
  <div class="rv-images collapsed">
    {% if pinned_review.image_urls %}
      {% for u in pinned_review.image_urls %}
        <img src="{{ u }}" alt="">
      {% endfor %}
    {% endif %}

    {% if pinned_review.image_url %}
      <img src="{{ pinned_review.image_url }}" alt="">
    {% endif %}

    {% if pinned_review.video_urls %}
      {% for u in pinned_review.video_urls %}
        <span class="rv-thumb" data-vid="1">
            <video src="{{ u }}" muted playsinline preload="metadata"
         disablepictureinpicture
         controlslist="nodownload noplaybackrate noremoteplayback"
         tabindex="-1"></video>
      </span>
      {% endfor %}
    {% endif %}
  </div>
  <button type="button" class="photo-toggle" hidden>See more media</button>
{% endif %}

    <div class="rv-footer">
      <span class="rv-name">{{ pinned_review.user_name|default:"Anonymous" }}</span>
{% if pinned_review.is_verified_purchase %}
  <span class="cert">
  <svg class="tick" viewBox="0 0 24 24" aria-hidden="true">
    <circle cx="12" cy="12" r="10" class="tick-bg"></circle>
    <path d="M7.5 12.5l2.7 2.7 5.3-6.2" class="tick-mark"></path>
  </svg>
  Certified Buyer
</span>
{% endif %}
      <span class="rv-dot">•</span>
      <span class="rv-when">{% if pinned_review.display_date %}{{ pinned_review.display_date }}{% else %}{{ pinned_review.created_at|date:"M j, Y, g:i A" }}{% endif %}</span>
      <span class="spacer"></span>

      <div class="react" data-id="{{ pinned_review.review_id }}">
        <button type="button" class="react-btn like" data-val="1">👍 <span class="react-count js-like">{{ pinned_review.like_count }}</span></button>
        <button type="button" class="react-btn dislike" data-val="-1">👎 <span class="react-count js-dislike">{{ pinned_review.dislike_count }}</span></button>
      </div>

      {% if not current_user_id or pinned_review.user_id != current_user_id %}
  <div class="abuse-dd">
  <button type="button" class="abuse-trigger" aria-haspopup="true" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M6 9l6 6 6-6"></path> <!-- downward arrow -->
    </svg>
  </button>
  <div class="abuse-menu" role="menu">
<button class="abuse-item danger js-report" data-id="{{ pinned_review.review_id }}" role="menuitem">Report Abuse</button>
  </div>
</div>
{% endif %}


      <div class="kebab">
        <button type="button" class="kebab-btn" aria-label="More">⋯</button>
        <div class="kebab-menu">
          <button class="kebab-item js-edit"
            data-id="{{ pinned_review.review_id }}"
            data-body="{{ pinned_review.body|default_if_none:''|escape }}"
            data-rating="{{ pinned_review.rating }}"
            data-title="{{ pinned_review.title|default_if_none:''|escape }}">Edit</button>
          <button class="kebab-item danger js-delete" data-id="{{ pinned_review.review_id }}">Delete</button>
        </div>
      </div>
    </div>
  </div>
  <div id="pinned-data"
     data-id="{{ pinned_review.review_id }}"
     data-title="{{ pinned_review.title|default_if_none:''|escape }}"
     data-body="{{ pinned_review.body|default_if_none:''|escape }}"
     data-rating="{{ pinned_review.rating }}">
</div>
  {% endif %}

  {% if reviews and reviews|length > 0 %}
    {% for r in reviews %}
    <div class="rv" data-review-id="{{ r.review_id }}">
      <div class="rv-head">
        <div class="rv-left">
          {% with r.rating as rt %}
            <div class="rate-badge {% if rt >= 4 %}good{% elif rt == 3 %}avg{% else %}bad{% endif %}">
              <span>{{ rt }}</span><span class="rate-star">★</span>
            </div>
          {% endwith %}
          {% if r.title %}<div class="rv-title">{{ r.title }}</div>{% endif %}
        </div>
      </div>

     {% if r.body %}
  <div class="rv-body">{{ r.body }}</div>
  <button type="button" class="moreless" hidden>Read more</button>
{% endif %}


     {# show media block if there are any images, legacy single image, or videos #}
{% if r.image_urls or r.image_url or r.video_urls %}
  <div class="rv-images collapsed">
    {# images (multi) #}
    {% if r.image_urls %}
      {% for u in r.image_urls %}
        <img src="{{ u }}" alt="review image">
      {% endfor %}
    {% endif %}

    {# legacy single image #}
    {% if r.image_url %}
      <img src="{{ r.image_url }}" alt="review image">
    {% endif %}

    {# videos #}
    {% if r.video_urls %}
      {% for u in r.video_urls %}
        <span class="rv-thumb" data-vid="1">
            <video src="{{ u }}" muted playsinline preload="metadata"
         disablepictureinpicture
         controlslist="nodownload noplaybackrate noremoteplayback"
         tabindex="-1"></video>
      </span>
      {% endfor %}
    {% endif %}
  </div>
  <button type="button" class="photo-toggle" hidden>See more media</button>
{% endif %}


      <div class="rv-footer">
        <span class="rv-name">{{ r.user_name|default:"Anonymous" }}</span>
{% if r.is_verified_purchase %}
  <span class="cert">
    <svg class="tick" viewBox="0 0 24 24" aria-hidden="true">
      <circle cx="12" cy="12" r="10" class="tick-bg"></circle>
      <path d="M7.5 12.5l2.7 2.7 5.3-6.2" class="tick-mark"></path>
    </svg>
    Certified Buyer
  </span>
{% endif %}
        <span class="rv-dot">•</span>
        <span class="rv-when">{% if r.display_date %}{{ r.display_date }}{% else %}{{ r.created_at|date:"M j, Y, g:i A" }}{% endif %}</span>
        <span class="spacer"></span>

        <div class="react" data-id="{{ r.review_id }}">
          <button type="button" class="react-btn like" data-val="1">👍 <span class="react-count js-like">{{ r.like_count }}</span></button>
          <button type="button" class="react-btn dislike" data-val="-1">👎 <span class="react-count js-dislike">{{ r.dislike_count }}</span></button>
        </div>

        {% if not current_user_id or r.user_id != current_user_id %}
  <div class="abuse-dd">
  <button type="button" class="abuse-trigger" aria-haspopup="true" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M6 9l6 6 6-6"></path> <!-- downward arrow -->
    </svg>
  </button>
  <div class="abuse-menu" role="menu">
    <button class="abuse-item danger js-report" data-id="{{ r.review_id }}" role="menuitem">Report Abuse</button>
  </div>
</div>
{% endif %}


        {% if current_user_id and r.user_id == current_user_id %}
        <div class="kebab">
          <button type="button" class="kebab-btn" aria-label="More">⋯</button>
          <div class="kebab-menu">
            <button class="kebab-item js-edit"
              data-id="{{ r.review_id }}"
              data-body="{{ r.body|default_if_none:''|escape }}"
              data-rating="{{ r.rating }}"
              data-title="{{ r.title|default_if_none:''|escape }}">Edit</button>
            <button class="kebab-item danger js-delete" data-id="{{ r.review_id }}">Delete</button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% elif not pinned_review %}
    <div class="empty">No reviews yet. Be the first to review this product.</div>
  {% endif %}

</div>

{% if total_pages and total_pages > 1 %}
  <div class="pager" style="gap:10px; flex-wrap:wrap">
    <span class="meta">Page {{ cur_page }} of {{ total_pages }}</span>

    <!-- PREVIOUS -->
    <a href="{{ prev_url|default:'#' }}" class="btn {% if not prev_url %}is-disabled{% endif %}">PREVIOUS</a>

    <!-- Numbered pages with gaps -->
    {% for it in page_links %}
      {% if it.dots %}
        <span class="meta" aria-hidden="true">…</span>
      {% else %}
        {% if it.is_current %}
          <a class="btn current" aria-current="page">{{ it.n }}</a>
        {% else %}
          <a href="{{ it.url }}" class="btn">{{ it.n }}</a>
        {% endif %}
      {% endif %}
    {% endfor %}
    <a href="{{ next_url|default:'#' }}" class="btn {% if not next_url %}is-disabled{% endif %}">NEXT</a>
    <span id="pager-spin" aria-hidden="true"></span>
  </div>
{% endif %}


<!-- Toast container -->
<div class="toasts" id="toasts"></div>

<!-- Modal confirm -->
<div id="confirmBackdrop" class="modal-backdrop"></div>
<div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="hd" id="confirmTitle">Delete review</div>
  <div class="bd">Delete this review permanently?</div>
  <div class="ft">
    <button type="button" class="btn ghost" id="confirmCancel">Cancel</button>
    <button type="button" class="btn danger" id="confirmOk">Delete</button>
  </div>
</div>
<script>
(function(){
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF = getCookie('csrftoken');
  const cfg  = document.getElementById('config');
  const SUBMIT = cfg?.dataset.submitUrl || '';
  // --- Per-user vote memory (so colors survive refresh and are per-user) ---
const CURRENT_USER_ID = cfg?.dataset.userId || 'anon';
const VOTE_KEY = `review_vote_state_v2:${CURRENT_USER_ID}`;

function _getVoteMap(){
  try { return JSON.parse(localStorage.getItem(VOTE_KEY) || '{}') || {}; }
  catch(_) { return {}; }
}
function _setVoteMap(m){ try{ localStorage.setItem(VOTE_KEY, JSON.stringify(m)); }catch(_){} }

function rememberVote(reviewId, val){         // val: 1=like, -1=dislike, 0=clear
  const m = _getVoteMap();
  if (val === 0) delete m[reviewId]; else m[reviewId] = val;
  _setVoteMap(m);
}
function readRememberedVote(reviewId){
  const m = _getVoteMap();
  return Number(m[reviewId] || 0);
}

  const toastBox = document.getElementById('toasts');
  function toast(kind, msg, ms=2600){
  const t = document.createElement('div');
  t.className = 'toast ' + (kind || 'info');
  t.innerHTML = (kind==='ok' ? '<span class="ico">✔</span>' : '') + '<div>'+msg+'</div>';
  toastBox.appendChild(t);
  setTimeout(()=>{ t.style.opacity = '0'; t.style.transform='translateY(10px)'; }, ms);
  setTimeout(()=>{ t.remove(); }, ms+250);
}

  // stars input
  const starsWrap = document.getElementById('stars');
  const stars = starsWrap ? [...starsWrap.querySelectorAll('.star')] : [];
  const ratingInput = document.getElementById('rating-input');
  function paint(n){ stars.forEach((s,i)=> s.classList.toggle('on', i < n)); }
  stars.forEach(s=>{
    s.addEventListener('mouseenter', ()=>paint(parseInt(s.dataset.v,10)));
    s.addEventListener('mouseleave', ()=>paint(parseInt(ratingInput.value||'0',10)));
    s.addEventListener('click', ()=>{ const v = parseInt(s.dataset.v,10); ratingInput.value=v; paint(v); });
  });

  function seedAllReactions(){
  document.querySelectorAll('.react[data-id]').forEach(wrap=>{
    const id = wrap.dataset.id;
    const likeBtn = wrap.querySelector('.react-btn.like');
    const disBtn  = wrap.querySelector('.react-btn.dislike');
    if (!likeBtn || !disBtn) return;

    // reset
    likeBtn.classList.remove('active');
    disBtn.classList.remove('active');

    // 1) Prefer server-rendered state if present
    const hostLiked    = likeBtn.classList.contains('active');
    const hostDisliked = disBtn.classList.contains('active');
    if (hostLiked){ rememberVote(id, 1); return; }
    if (hostDisliked){ rememberVote(id, -1); return; }

    // 2) Otherwise, restore our remembered state for THIS user
    const memo = readRememberedVote(id);
    if (memo === 1) likeBtn.classList.add('active');
    else if (memo === -1) disBtn.classList.add('active');
  });
}


  // Unified media picker (images + videos) with one preview, but submits to hidden images/videos 
const mediaInput    = document.getElementById('media');
const imagesHidden  = document.getElementById('images');   
const videosHidden  = document.getElementById('videos');   
const mediaPreview  = document.getElementById('media-preview');

// Keep selection order; each entry knows if it's image or video
let mediaFiles = []; 

function syncHiddenInputs(){
  const imgDT = new DataTransfer();
  const vidDT = new DataTransfer();
  mediaFiles.forEach(({file, type}) => {
    (type === 'video' ? vidDT : imgDT).items.add(file);
  });
  imagesHidden.files = imgDT.files;
  videosHidden.files = vidDT.files;
}

function renderMediaPreviews(){
  if (!mediaPreview) return;
  if (!mediaFiles.length){
    mediaPreview.textContent = 'No media selected';
    mediaPreview.classList.add('hint');
    return;
  }
  mediaPreview.classList.remove('hint');

  mediaPreview.innerHTML = mediaFiles.map(({file, type}, i) => {
    const u = URL.createObjectURL(file);
    if (type === 'video'){
      return `
        <div style="position:relative;display:inline-block">
          <video src="${u}" muted playsinline loop
                 style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)"></video>
          <button type="button" class="kill" data-idx="${i}"
                  style="position:absolute;top:-6px;right:-6px;border:none;background:#ef4444;color:#fff;
                         width:22px;height:22px;border-radius:999px;cursor:pointer;font-weight:800;line-height:1">×</button>
        </div>`;
    }
    // image
    return `
      <div style="position:relative;display:inline-block">
        <img src="${u}" alt="media ${i+1}"
             style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">
        <button type="button" class="kill" data-idx="${i}"
                style="position:absolute;top:-6px;right:-6px;border:none;background:#ef4444;color:#fff;
                       width:22px;height:22px;border-radius:999px;cursor:pointer;font-weight:800;line-height:1">×</button>
      </div>`;
  }).join('');

  // remove handlers
  mediaPreview.querySelectorAll('button.kill[data-idx]').forEach(btn=>{
    btn.onclick = () => {
      const i = +btn.dataset.idx;
      mediaFiles.splice(i, 1);
      syncHiddenInputs();
      renderMediaPreviews();
    };
  });
}

mediaInput?.addEventListener('change', () => {
  const incoming = Array.from(mediaInput.files || []);
  incoming.forEach(f => {
    const type = (f.type || '').startsWith('video') ? 'video' : 'image';
    mediaFiles.push({ file: f, type });
  });
  // Clear the visible input so selecting the same files again will still fire 'change'
  mediaInput.value = '';
  syncHiddenInputs();
  renderMediaPreviews();
});
  // submit / edit
  const form   = document.getElementById('review-form');
  const btn    = document.getElementById('submit-btn');
  const cancel = document.getElementById('cancel-edit');
  const already = document.getElementById('already-msg');
  let editingId = null;

  function toEditMode(id){ editingId=id; btn.textContent='Update review'; cancel.style.display='inline-block'; if(already) already.style.display='block'; }
  function exitEdit(){ editingId=null; btn.textContent='Submit review'; cancel.style.display='none'; form.reset(); document.getElementById('title').value=''; ratingInput.value=0; paint(0); imgPrev.textContent='No image selected'; imgPrev.classList.add('hint'); if(already) already.style.display='none'; }
  cancel?.addEventListener('click', e=>{ e.preventDefault(); exitEdit(); });


  document.addEventListener('click', (e)=>{
    const b = e.target.closest('.js-edit'); if(!b) return;
    e.preventDefault();
    document.getElementById('body').value  = b.dataset.body || '';
    document.getElementById('title').value = b.dataset.title || '';
    ratingInput.value = b.dataset.rating || '5';
    paint(parseInt(ratingInput.value,10));
    toEditMode(b.dataset.id);
    window.scrollTo({top:0,behavior:'smooth'});
    toast('info','Editing your review');
  });

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const rating = parseInt(ratingInput.value||'0',10);
    if(!rating || rating<1 || rating>5){ toast('err','Please select a rating (1–5)'); return; }
    const fd = new FormData(form);
    try{
      btn.disabled = true; const orig = btn.textContent;
      btn.textContent = editingId ? 'Updating…' : 'Submitting…';
      let url = SUBMIT, method = 'POST';
      if (editingId){ url = `/api/reviews/${editingId}/edit/`; method = 'POST'; }

      const resp = await fetch(url, { method, body: fd, credentials:'include', headers:{'X-CSRFToken': CSRF} });
      let data = {}; const ct = resp.headers.get('content-type')||'';
      if (ct.includes('application/json')) { try{ data = await resp.json(); } catch(_){} }

      if (!resp.ok){
        if (resp.status===409 && (data?.existing_review_id || data?.backend?.existing_review_id)){
          const id = data.existing_review_id || data.backend.existing_review_id;
          toEditMode(id); toast('err',"You already reviewed this product. Editing your existing one.");
          btn.disabled=false; btn.textContent=orig; return;
        }
        if (resp.status===403){
          toast('err', data?.error || 'You must purchase this product before leaving a review.');
          btn.disabled=false; btn.textContent=orig; return;
        }
        toast('err', data?.error || 'Could not submit review');
        btn.disabled=false; btn.textContent=orig; return;
      }
      toast('ok', editingId ? 'Your review was updated' : 'Your review was submitted');
      setTimeout(()=>window.location.reload(), 650);
    }catch(err){ console.error(err); toast('err','Network error. Please try again.'); btn.disabled=false; }
  });

  // reactions
  document.addEventListener('click', async (e)=>{
    const el = e.target.closest('.react-btn'); if(!el) return;
    const wrap = el.closest('.react'); const reviewId = wrap?.dataset.id; const value = el.dataset.val;
    if(!reviewId || !value) return;
    try{
      const resp = await fetch(`/api/reviews/${reviewId}/vote/`, {
        method:'POST', credentials:'include',
        headers:{'X-CSRFToken': CSRF, 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: new URLSearchParams({value})
      });
      const data = await resp.json().catch(()=> ({}));
      if (resp.status===401){ toast('err','Please log in to vote'); return; }
      if (!resp.ok || !data?.ok){ toast('err', data?.error || 'Could not record vote'); return; }
      wrap.querySelector('.js-like').textContent    = data.like_count;
      wrap.querySelector('.js-dislike').textContent = data.dislike_count;
      const likeBtn = wrap.querySelector('.react-btn.like');
      const dislikeBtn = wrap.querySelector('.react-btn.dislike');
      likeBtn.classList.remove('active');
      dislikeBtn.classList.remove('active');
      if (data.action === 'created' || data.action === 'switched'){
      if (value === '1'){
        likeBtn.classList.add('active');
        rememberVote(reviewId, 1);
      }else{
        dislikeBtn.classList.add('active');
        rememberVote(reviewId, -1);
      }
      }else if (data.action === 'deleted' || data.action === 'cleared'){
        rememberVote(reviewId, 0);
      }else{
    const v = likeBtn.classList.contains('active') ? 1 :
            (dislikeBtn.classList.contains('active') ? -1 : 0);
      rememberVote(reviewId, v);
    }
    }catch(err){ console.error(err); toast('err','Network error'); }
  });

  // kebab menu open/close
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.kebab-btn');
    const anyMenu = document.querySelectorAll('.kebab-menu');
    if (btn){
      e.preventDefault();
      const wrap = btn.closest('.kebab');
      const menu = wrap.querySelector('.kebab-menu');
      anyMenu.forEach(m => { if (m !== menu) m.classList.remove('open'); });
      menu.classList.toggle('open');
      return;
    }
    if (!e.target.closest('.kebab')) anyMenu.forEach(m => m.classList.remove('open'));
  });

  // modal confirm for delete
  const modal = document.getElementById('confirmModal');
  const backdrop = document.getElementById('confirmBackdrop');
  const btnOk = document.getElementById('confirmOk');
  const btnCancel = document.getElementById('confirmCancel');
  let _pendingDeleteId = null;
  function openConfirm(id){ _pendingDeleteId = id; backdrop.classList.add('open'); modal.classList.add('open'); }
  function closeConfirm(){ _pendingDeleteId = null; backdrop.classList.remove('open'); modal.classList.remove('open'); }
  btnCancel.addEventListener('click', closeConfirm);
  backdrop.addEventListener('click', closeConfirm);

  document.addEventListener('click', (e)=>{
    const del = e.target.closest('.js-delete'); if(!del) return;
    e.preventDefault();
    openConfirm(del.dataset.id);
  });

  btnOk.addEventListener('click', async ()=>{
    const id = _pendingDeleteId; if (!id) return;
    try{
      const resp = await fetch(`/api/reviews/${id}/delete/`, {
        method:'POST', credentials:'include',
        headers:{'X-CSRFToken': CSRF}
      });
      if (!resp.ok){
        const data = await resp.json().catch(()=> ({}));
        toast('err', data?.error || 'Could not delete review');
        closeConfirm(); return;
      }
      toast('ok','Review deleted');
      closeConfirm();
      setTimeout(()=>window.location.reload(), 500);
    }catch(err){ console.error(err); toast('err','Network error'); closeConfirm(); }
  });

  // photos: show toggle only if there are >2 rows hidden
  function initPhotoToggles(){
    document.querySelectorAll('.photo-toggle').forEach(btn=>{
      const grid = btn.previousElementSibling;
      if (!grid || !grid.classList.contains('rv-images')) return;
      // ensure collapsed first for measurement
      grid.classList.add('collapsed');
      // show button if scrollHeight > visible height (meaning more rows exist)
      btn.hidden = !(grid.scrollHeight > grid.clientHeight + 2);
      btn.textContent = 'See more photos';
      btn.onclick = ()=>{
        grid.classList.toggle('collapsed');
        btn.textContent = grid.classList.contains('collapsed') ? 'See more photos' : 'See fewer photos';
      };
    });
  }
  window.addEventListener('load', initPhotoToggles);
  setTimeout(initPhotoToggles, 500); // safety

  // fetch stats
  (function () {
  fetch('/api/reviews/{{ product.product_id }}/stats/')
    .then(r => r.json())
    .then(data => {
      if (!data) return;

      const top = document.getElementById('review-count');
const cfgEl = document.getElementById('config');
const ratingsFromTpl = Number(cfgEl?.dataset.ratings || 0);
const reviewsFromTpl = Number(cfgEl?.dataset.reviews || 0);

// data.total = ratings total from stats API (bars use this)
const ratingsTotal = Number(data?.total ?? ratingsFromTpl);
const reviewsTotal = reviewsFromTpl;

if (top) {
  if (ratingsTotal || reviewsTotal) {
    const rWord = ratingsTotal === 1 ? 'rating' : 'ratings';
    const vWord = reviewsTotal === 1 ? 'review' : 'reviews';
    top.textContent = reviewsTotal
      ? `${ratingsTotal} ${rWord} & ${reviewsTotal} ${vWord}`
      : `${ratingsTotal} ${rWord}`;
  } else {
    top.textContent = 'No ratings yet';
  }
}
      const summary = document.getElementById('rating-summary');
      if (data.total && summary) {
        summary.style.display = 'grid';
        const avgEl = document.getElementById('avg-rating');
        if (avgEl) avgEl.textContent = (data.average?.toFixed ? data.average.toFixed(1) : data.average);
        const totalEl = document.getElementById('total-ratings');
if (totalEl) {
  const rWord = ratingsTotal === 1 ? 'rating' : 'ratings';
  const vWord = reviewsTotal === 1 ? 'review' : 'reviews';
  totalEl.textContent = reviewsTotal
    ? `${ratingsTotal} ${rWord} & ${reviewsTotal} ${vWord}`
    : `${ratingsTotal} ${rWord}`;
}

        const total = data.total || 1;
        for (let star = 5; star >= 1; star--) {
          const count = (data.counts && (data.counts[String(star)] ?? 0)) || 0;
          const pct = Math.round((count / total) * 100);
          const bar = document.getElementById(`bar-${star}`);
          const cnt = document.getElementById(`count-${star}`);

          if (cnt) cnt.textContent = count;

          if (bar) {
            // reset to 0 so the transition always plays
            bar.style.transition = 'none';
            bar.style.width = '0%';
            void bar.offsetWidth; // force reflow

            // animate to the real percent (slight stagger)
            const delay = (5 - star) * 90;
            requestAnimationFrame(() => {
              bar.style.transition = 'width .9s cubic-bezier(.22,.8,.2,1)';
              setTimeout(() => { bar.style.width = pct + '%'; }, delay);
            });
          }
        }
      }
    }) // <-- close the .then block properly
    .catch(err => console.error('Stats fetch error:', err));
})();

  // --- clamp long review text + toggle
function initBodyClamp(){
  document.querySelectorAll('.rv').forEach(rv=>{
    const body = rv.querySelector('.rv-body');
    const btn  = rv.querySelector('.moreless');
    if(!body || !btn) return;

    // start collapsed
    rv.classList.add('collapsed');

    // only show button if there is overflow (i.e., more than 5 lines)
    requestAnimationFrame(()=>{
      if (body.scrollHeight > body.clientHeight + 2) {
        btn.hidden = false;
        btn.textContent = 'Read more';
      }
    });

    btn.onclick = ()=>{
      const isCollapsed = rv.classList.toggle('collapsed');
      btn.textContent = isCollapsed ? 'Read more' : 'Show less';
      btn.setAttribute('aria-expanded', String(!isCollapsed));
    };
  });
}

// run on load (and after any async content if needed)
window.addEventListener('load', initBodyClamp);
(function () {
    const params = new URLSearchParams(location.search);
    if (!params.get('edit')) return;       // only run when ?edit=1 is present

    const el = document.getElementById('pinned-data');
    if (!el) return;                        // no pinned review found

    const d = el.dataset;
    const bodyEl     = document.getElementById('body');
    const titleEl    = document.getElementById('title');
    const ratingEl   = document.getElementById('rating-input');

    if (bodyEl)   bodyEl.value   = d.body || '';
    if (titleEl)  titleEl.value  = d.title || '';
    if (ratingEl) {
      ratingEl.value = d.rating || '5';
      if (typeof paint === 'function') paint(parseInt(ratingEl.value, 10));
    }

    if (typeof toEditMode === 'function') toEditMode(d.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // optional: remove ?edit=1 from the URL so refresh doesn't re-open
    if (history.replaceState) {
      const url = new URL(location.href);
      url.searchParams.delete('edit');
      history.replaceState({}, '', url);
    }
  })();

/* Report Abuse – Flipkart-like: hover menu + one-time report + bottom toast */
const REPORT_KEY = 'review_reported_v1';
const getSet = () => { try { return new Set(JSON.parse(localStorage.getItem(REPORT_KEY) || '[]')); } catch (_) { return new Set(); } };
const saveSet = s => localStorage.setItem(REPORT_KEY, JSON.stringify([...s]));

// keep buttons disabled if already reported
function markReported(){
  const s = getSet();
  document.querySelectorAll('.js-report[data-id]').forEach(b=>{
    if (s.has(String(b.dataset.id))){
      b.textContent = 'Reported';
      b.setAttribute('disabled','');
    }
  });
}
markReported();

document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.js-report'); if(!btn) return;
  const id = btn.dataset.id; if(!id) return;

  const s = getSet();
  if (s.has(String(id))){ toast('info','Already reported for review moderation.'); return; }

  // optimistic UI like Flipkart
  toast('ok','Thanks for reporting it. Our team will look into it at the earliest.');
  btn.textContent = 'Reported';
  btn.setAttribute('disabled','');
  s.add(String(id)); saveSet(s);

  // backend call
  try{
    const resp = await fetch(`/api/reviews/${id}/report/`, {
      method:'POST', credentials:'include',
      headers:{ 'X-CSRFToken': CSRF, 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams({ reason:'abuse' })
    });
    if (resp.status === 401){
      toast('err','Please log in to report');
      s.delete(String(id)); saveSet(s);
      btn.textContent = 'Report Abuse';
      btn.removeAttribute('disabled');
    } else if (resp.status === 409){
      toast('info','Already reported for review moderation.');
    }
  }catch(_){ /* keep disabled to avoid spam */ }
});


(function fastPager(){
  const root = () => document.getElementById('rv-root');
  const pager = () => document.querySelector('.pager');

  function attach(){
    if (!root() || !pager()) return;
    pager().querySelectorAll('a[href]').forEach(a=>{
      if (a.classList.contains('is-disabled')) return;
      a.addEventListener('click', (e)=>{
        if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return; // let new-tab etc work
        e.preventDefault();
        const url = a.getAttribute('href');
        if (!url || url === '#') return;

        // show tiny spinner
        pager().classList.add('loading');

        fetch(url, { credentials: 'include' })
          .then(r => r.text())
          .then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const fresh = doc.getElementById('rv-root');
            if (!fresh) { location.href = url; return; } // fallback
            root().replaceWith(fresh);
            window.history.pushState({}, '', url);
            window.scrollTo({ top: 0, behavior: 'auto' });
            // reattach handlers to the new pager
            setTimeout(()=>{ fastPager(); }, 0);
          })
          .catch(()=> location.href = url)
          .finally(()=> {
            const p = pager();
            if (p) p.classList.remove('loading');
          });
      });
    });
  }

  // Re-hydrate on back/forward
  window.addEventListener('popstate', ()=>{
    fetch(location.href, { credentials: 'include' })
      .then(r=>r.text())
      .then(html=>{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const fresh = doc.getElementById('rv-root');
        if (fresh && root()) { root().replaceWith(fresh); fastPager(); }
      });
  });

  attach();
})();
  // Open lightbox (review_gallery) for both images and video thumbs
document.addEventListener('click', (e) => {
  // Accept clicks on both images and video thumb wrappers
  const node = e.target.closest('.rv-images img, .rv-images .rv-thumb[data-vid]');
  if (!node) return;

  // Get the review id
  const rv = node.closest('.rv');
  const reviewId = rv?.dataset.reviewId || rv?.getAttribute('data-review-id');
  if (!reviewId) return;

  // Build ordered list of thumbnails (images + video-thumbs)
  const grid  = rv.querySelector('.rv-images');
  const items = [...grid.querySelectorAll('img, .rv-thumb[data-vid]')];

  // Figure out the index of the clicked item
  const start = Math.max(0, items.indexOf(node));

  fetch("{% url 'review_gallery' %}" + "?review_id=" + encodeURIComponent(reviewId) + "&idx=" + start, { credentials: 'include' })
  .then(r => r.text())
  .then(html => {
    const dlg  = document.getElementById('rvDlg');
    const body = document.getElementById('rvDlgBody');
    if (!dlg || !body) { alert('Gallery host not found'); return; }

    // 1) Insert the HTML
    body.innerHTML = html;

    // 2) Execute any <script> tags inside the injected HTML
    body.querySelectorAll('script').forEach(oldS => {
      const s = document.createElement('script');
      if (oldS.src) s.src = oldS.src;
      else s.textContent = oldS.textContent;
      // carry over type (module vs classic)
      if (oldS.type) s.type = oldS.type;
      document.body.appendChild(s);
      // optional cleanup
      setTimeout(() => s.remove(), 0);
    });

    // 3) Make backdrop click close the dialog (in case the gallery code didn't wire it)
    dlg.onclick = (e) => {
      const r = dlg.getBoundingClientRect();
      // if click happened outside the dialog's bounding box, close
      if (e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom) {
        dlg.close();
      }
    };

    // 4) Also close when a button/link inside has data-rg-close (the close "X" in our template below)
    body.addEventListener('click', (e) => {
      if (e.target.closest('[data-rg-close]')) dlg.close();
    });

    dlg.showModal();
  })
  .catch(() => alert('Could not open gallery'));

});
seedAllReactions(); 
})();
</script>
{% endblock %}
